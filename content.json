{"meta":{"title":"Star","subtitle":null,"description":"ä¸€é—ªä¸€é—ªäº®æ™¶æ™¶ï¼Œæ¼«å¤©éƒ½æ˜¯å°æ˜Ÿæ˜Ÿ~","author":"Star","url":"https://xingxin-99.github.io"},"pages":[{"title":"bangumi","date":"2019-02-10T13:32:48.000Z","updated":"2021-11-09T14:13:18.000Z","comments":false,"path":"bangumi/index.html","permalink":"https://xingxin-99.github.io/bangumi/index.html","excerpt":"","text":"","keywords":null},{"title":"about","date":"2018-12-12T14:14:36.000Z","updated":"2021-11-09T14:13:18.000Z","comments":false,"path":"about/index.html","permalink":"https://xingxin-99.github.io/about/index.html","excerpt":"","text":"[ã•ãã‚‰è˜ã®hojun] ä¸&nbsp; Mashiro&nbsp; ï¼ˆ çœŸï¼ˆã¾ï¼‰ç™½ï¼ˆã—ã‚ï¼‰ ï¼‰ å¯¹è¯ä¸­... bot_ui_ini()","keywords":"å…³äº"},{"title":"Ca","date":"2018-12-12T14:14:16.000Z","updated":"2023-08-25T05:38:52.619Z","comments":true,"path":"categories/index.html","permalink":"https://xingxin-99.github.io/categories/index.html","excerpt":"","text":""},{"title":"client","date":"2018-12-20T15:13:35.000Z","updated":"2021-11-09T14:13:18.000Z","comments":false,"path":"client/index.html","permalink":"https://xingxin-99.github.io/client/index.html","excerpt":"","text":"ç›´æ¥ä¸‹è½½ or æ‰«ç ä¸‹è½½ï¼š","keywords":"Androidå®¢æˆ·ç«¯"},{"title":"comment","date":"2018-12-20T15:13:48.000Z","updated":"2021-11-09T14:13:18.000Z","comments":true,"path":"comment/index.html","permalink":"https://xingxin-99.github.io/comment/index.html","excerpt":"","text":"å¿µä¸¤å¥è¯— å™åˆ«æ¢¦ã€æ‰¬å·ä¸€è§‰ã€‚ ã€å®‹ä»£ã€‘å´æ–‡è‹±ã€Šå¤œæ¸¸å®«Â·äººå»è¥¿æ¥¼é›æ³ã€‹","keywords":"ç•™è¨€æ¿"},{"title":"donate","date":"2018-12-20T15:13:05.000Z","updated":"2021-11-09T14:13:18.000Z","comments":false,"path":"donate/index.html","permalink":"https://xingxin-99.github.io/donate/index.html","excerpt":"","text":"","keywords":"è°¢è°¢é¥²ä¸»äº†å–µ~"},{"title":"lab","date":"2019-01-05T13:47:59.000Z","updated":"2021-11-09T14:13:18.000Z","comments":false,"path":"lab/index.html","permalink":"https://xingxin-99.github.io/lab/index.html","excerpt":"","text":"sakuraä¸»é¢˜balabala","keywords":"Labå®éªŒå®¤"},{"title":"links","date":"2018-12-19T15:11:06.000Z","updated":"2021-11-09T14:13:18.000Z","comments":true,"path":"links/index.html","permalink":"https://xingxin-99.github.io/links/index.html","excerpt":"","text":"","keywords":"å‹äººå¸"},{"title":"music","date":"2018-12-20T15:14:28.000Z","updated":"2021-11-09T14:13:18.000Z","comments":false,"path":"music/index.html","permalink":"https://xingxin-99.github.io/music/index.html","excerpt":"","text":"","keywords":"å–œæ¬¢çš„éŸ³ä¹"},{"title":"rss","date":"2018-12-20T15:09:03.000Z","updated":"2021-11-09T14:13:18.000Z","comments":true,"path":"rss/index.html","permalink":"https://xingxin-99.github.io/rss/index.html","excerpt":"","text":""},{"title":"theme-sakura","date":"2019-01-04T14:53:25.000Z","updated":"2021-11-09T14:13:18.000Z","comments":false,"path":"theme-sakura/index.html","permalink":"https://xingxin-99.github.io/theme-sakura/index.html","excerpt":"","text":"Hexoä¸»é¢˜Sakuraä¿®æ”¹è‡ªWordPressä¸»é¢˜Sakuraï¼Œæ„Ÿè°¢åŸä½œè€…Mashiro","keywords":"Hexo ä¸»é¢˜ Sakura ğŸŒ¸"},{"title":"tags","date":"2018-12-12T14:14:16.000Z","updated":"2021-11-09T14:13:18.000Z","comments":true,"path":"tags/index.html","permalink":"https://xingxin-99.github.io/tags/index.html","excerpt":"","text":""},{"title":"video","date":"2018-12-20T15:14:38.000Z","updated":"2021-11-09T14:13:18.000Z","comments":false,"path":"video/index.html","permalink":"https://xingxin-99.github.io/video/index.html","excerpt":"","text":"var videos = [ { img: 'https://lain.bgm.tv/pic/cover/l/0e/1e/218971_2y351.jpg', title: 'æœèŠ±å¤•èª“â€”â€”äºç¦»åˆ«ä¹‹æœæŸèµ·çº¦å®šä¹‹èŠ±', status: 'å·²è¿½å®Œ', progress: 100, jp: 'ã•ã‚ˆãªã‚‰ã®æœã«ç´„æŸã®èŠ±ã‚’ã‹ã–ã‚ã†', time: 'æ”¾é€æ—¶é—´: 2018-02-24 SUN.', desc: ' ä½åœ¨è¿œç¦»å°˜åš£çš„åœŸåœ°ï¼Œä¸€è¾¹å°†æ¯å¤©çš„äº‹æƒ…ç¼–ç»‡æˆåä¸ºå¸Œæ¯”æ¬§çš„å¸ƒï¼Œä¸€è¾¹é™é™ç”Ÿæ´»çš„ä¼Šæ¬§å¤«äººæ°‘ã€‚åœ¨15å²å·¦å³å¤–è¡¨å°±åœæ­¢æˆé•¿ï¼Œæ‹¥æœ‰æ•°ç™¾å¹´å¯¿å‘½çš„ä»–ä»¬ï¼Œè¢«ç§°ä¸ºâ€œç¦»åˆ«çš„ä¸€æ—â€ï¼Œå¹¶è¢«è§†ä¸ºæ´»ç€çš„ä¼ è¯´ã€‚æ²¡æœ‰åŒäº²çš„ä¼Šæ¬§å¤«å°‘å¥³ç›å¥‡äºšï¼Œè¿‡ç€è¢«ä¼™ä¼´åŒ…å›´çš„å¹³ç¨³æ—¥å­ï¼Œå´æ€»æ„Ÿè§‰â€œå­¤èº«ä¸€äººâ€ã€‚ä»–ä»¬çš„è¿™ç§æ—¥å¸¸ï¼Œä¸€ç¬é—´å°±å´©æºƒæ¶ˆå¤±ã€‚è¿½æ±‚ä¼Šæ¬§å¤«çš„é•¿å¯¿ä¹‹è¡€ï¼Œæ¢…è¨è’‚å†›ä¹˜åç€åä¸ºé›·çº³ç‰¹çš„å¤ä»£å…½å‘åŠ¨äº†è¿›æ”»ã€‚åœ¨ç»æœ›ä¸æ··ä¹±ä¹‹ä¸­ï¼Œä¼Šæ¬§å¤«çš„ç¬¬ä¸€ç¾å¥³è•¾è‰äºšè¢«æ¢…è¨è’‚å¸¦èµ°ï¼Œè€Œç›å¥‡äºšæš—æ‹çš„å°‘å¹´å…‹é‡Œå§†ä¹Ÿå¤±è¸ªäº†ã€‚ç›å¥‡äºšè™½ç„¶æ€»ç®—é€ƒè„±äº†ï¼Œå´å¤±å»äº†ä¼™ä¼´å’Œå½’å»ä¹‹åœ°â€¦â€¦ã€‚' }, { img : 'https://lain.bgm.tv/pic/cover/l/0e/1e/218971_2y351.jpg', title: 'æœèŠ±å¤•èª“â€”â€”äºç¦»åˆ«ä¹‹æœæŸèµ·çº¦å®šä¹‹èŠ±', status: 'å·²è¿½å®Œ', progress: 100, jp: 'ã•ã‚ˆãªã‚‰ã®æœã«ç´„æŸã®èŠ±ã‚’ã‹ã–ã‚ã†', time: '2018-02-24 SUN.', desc: ' ä½åœ¨è¿œç¦»å°˜åš£çš„åœŸåœ°ï¼Œä¸€è¾¹å°†æ¯å¤©çš„äº‹æƒ…ç¼–ç»‡æˆåä¸ºå¸Œæ¯”æ¬§çš„å¸ƒï¼Œä¸€è¾¹é™é™ç”Ÿæ´»çš„ä¼Šæ¬§å¤«äººæ°‘ã€‚åœ¨15å²å·¦å³å¤–è¡¨å°±åœæ­¢æˆé•¿ï¼Œæ‹¥æœ‰æ•°ç™¾å¹´å¯¿å‘½çš„ä»–ä»¬ï¼Œè¢«ç§°ä¸ºâ€œç¦»åˆ«çš„ä¸€æ—â€ï¼Œå¹¶è¢«è§†ä¸ºæ´»ç€çš„ä¼ è¯´ã€‚æ²¡æœ‰åŒäº²çš„ä¼Šæ¬§å¤«å°‘å¥³ç›å¥‡äºšï¼Œè¿‡ç€è¢«ä¼™ä¼´åŒ…å›´çš„å¹³ç¨³æ—¥å­ï¼Œå´æ€»æ„Ÿè§‰â€œå­¤èº«ä¸€äººâ€ã€‚ä»–ä»¬çš„è¿™ç§æ—¥å¸¸ï¼Œä¸€ç¬é—´å°±å´©æºƒæ¶ˆå¤±ã€‚è¿½æ±‚ä¼Šæ¬§å¤«çš„é•¿å¯¿ä¹‹è¡€ï¼Œæ¢…è¨è’‚å†›ä¹˜åç€åä¸ºé›·çº³ç‰¹çš„å¤ä»£å…½å‘åŠ¨äº†è¿›æ”»ã€‚åœ¨ç»æœ›ä¸æ··ä¹±ä¹‹ä¸­ï¼Œä¼Šæ¬§å¤«çš„ç¬¬ä¸€ç¾å¥³è•¾è‰äºšè¢«æ¢…è¨è’‚å¸¦èµ°ï¼Œè€Œç›å¥‡äºšæš—æ‹çš„å°‘å¹´å…‹é‡Œå§†ä¹Ÿå¤±è¸ªäº†ã€‚ç›å¥‡äºšè™½ç„¶æ€»ç®—é€ƒè„±äº†ï¼Œå´å¤±å»äº†ä¼™ä¼´å’Œå½’å»ä¹‹åœ°â€¦â€¦ã€‚' } ] .should-ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:95%;}.should-ellipsis-full{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;}.should-ellipsis i{position:absolute;right:24px;}.grey-text{color:#9e9e9e !important}.grey-text.text-darken-4{color:#212121 !important}html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}img{border-style:none}progress{display:inline-block;vertical-align:baseline}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{-webkit-box-sizing:border-box;box-sizing:border-box}*,*:before,*:after{-webkit-box-sizing:inherit;box-sizing:inherit}ul:not(.browser-default){padding-left:0;list-style-type:none}ul:not(.browser-default)>li{list-style-type:none}.card{-webkit-box-shadow:0 2px 2px 0 rgba(0,0,0,0.14),0 3px 1px -2px rgba(0,0,0,0.12),0 1px 5px 0 rgba(0,0,0,0.2);box-shadow:0 2px 2px 0 rgba(0,0,0,0.14),0 3px 1px -2px rgba(0,0,0,0.12),0 1px 5px 0 rgba(0,0,0,0.2)}.hoverable{-webkit-transition:-webkit-box-shadow .25s;transition:-webkit-box-shadow .25s;transition:box-shadow .25s;transition:box-shadow .25s,-webkit-box-shadow .25s}.hoverable:hover{-webkit-box-shadow:0 8px 17px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);box-shadow:0 8px 17px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19)}i{line-height:inherit}i.right{float:right;margin-left:15px}.bangumi .right{float:right !important}.material-icons{text-rendering:optimizeLegibility;-webkit-font-feature-settings:'liga';-moz-font-feature-settings:'liga';font-feature-settings:'liga'}.row{margin-left:auto;margin-right:auto;margin-bottom:20px}.row:after{content:\"\";display:table;clear:both}.row .col{float:left;-webkit-box-sizing:border-box;box-sizing:border-box;padding:0 .75rem;min-height:1px}.row .col.s12{width:100%;margin-left:auto;left:auto;right:auto}@media only screen and (min-width:601px){.row .col.m6{width:50%;margin-left:auto;left:auto;right:auto}}html{line-height:1.5;font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,Oxygen-Sans,Ubuntu,Cantarell,\"Helvetica Neue\",sans-serif;font-weight:normal;color:rgba(0,0,0,0.87)}@media only screen and (min-width:0){html{font-size:14px}}@media only screen and (min-width:992px){html{font-size:14.5px}}@media only screen and (min-width:1200px){html{font-size:15px}}.card{position:relative;margin:.5rem 0 1rem 0;background-color:#fff;-webkit-transition:-webkit-box-shadow .25s;transition:-webkit-box-shadow .25s;transition:box-shadow .25s;transition:box-shadow .25s,-webkit-box-shadow .25s;border-radius:2px}.card .card-title{font-size:24px;font-weight:300}.card .card-title.activator{cursor:pointer}.card .card-image{position:relative}.card .card-image img{display:block;border-radius:2px 2px 0 0;position:relative;left:0;right:0;top:0;bottom:0;width:100%}.card .card-content{padding:24px;border-radius:0 0 2px 2px}.card .card-content p{margin:0}.card .card-content .card-title{display:block;line-height:32px;margin-bottom:8px}.card .card-content .card-title i{line-height:32px}.card .card-reveal{padding:24px;position:absolute;background-color:#fff;width:100%;overflow-y:auto;left:0;top:100%;height:100%;z-index:3;display:none}.card .card-reveal .card-title{cursor:pointer;display:block}.waves-effect{position:relative;cursor:pointer;display:inline-block;overflow:hidden;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;vertical-align:middle;z-index:1;-webkit-transition:.3s ease-out;transition:.3s ease-out}.waves-effect img{position:relative;z-index:-1}.waves-block{display:block}::-webkit-input-placeholder{color:#d1d1d1}::-moz-placeholder{color:#d1d1d1}:-ms-input-placeholder{color:#d1d1d1}::-ms-input-placeholder{color:#d1d1d1}[type=\"radio\"]:not(:checked){position:absolute;opacity:0;pointer-events:none}[type=\"radio\"]:not(:checked)+span{position:relative;padding-left:35px;cursor:pointer;display:inline-block;height:25px;line-height:25px;font-size:1rem;-webkit-transition:.28s ease;transition:.28s ease;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}[type=\"radio\"]:not(:checked)+span:before,[type=\"radio\"]:not(:checked)+span:after{border-radius:50%}[type=\"radio\"]:not(:checked)+span:before,[type=\"radio\"]:not(:checked)+span:after{border:2px solid #5a5a5a}[type=\"radio\"]:not(:checked)+span:after{-webkit-transform:scale(0);transform:scale(0)}[type=\"checkbox\"]:not(:checked){position:absolute;opacity:0;pointer-events:none}[type=\"checkbox\"]:not(:checked):disabled+span:not(.lever):before{border:none;background-color:rgba(0,0,0,0.42)}[type=\"checkbox\"].filled-in:not(:checked)+span:not(.lever):before{width:0;height:0;border:3px solid transparent;left:6px;top:10px;-webkit-transform:rotateZ(37deg);transform:rotateZ(37deg);-webkit-transform-origin:100% 100%;transform-origin:100% 100%}[type=\"checkbox\"].filled-in:not(:checked)+span:not(.lever):after{height:20px;width:20px;background-color:transparent;border:2px solid #5a5a5a;top:0px;z-index:0}input[type=checkbox]:not(:disabled) ~ .lever:active:before,input[type=checkbox]:not(:disabled).tabbed:focus ~ .lever::before{-webkit-transform:scale(2.4);transform:scale(2.4);background-color:rgba(0,0,0,0.08)}input[type=range].focused:focus:not(.active)::-webkit-slider-thumb{-webkit-box-shadow:0 0 0 10px rgba(38,166,154,0.26);box-shadow:0 0 0 10px rgba(38,166,154,0.26)}input[type=range].focused:focus:not(.active)::-moz-range-thumb{box-shadow:0 0 0 10px rgba(38,166,154,0.26)}input[type=range].focused:focus:not(.active)::-ms-thumb{box-shadow:0 0 0 10px rgba(38,166,154,0.26)} ç•ªç»„è®¡åˆ’ è¿™é‡Œå°†æ˜¯æ°¸è¿œçš„å›å¿† window.onload = function(){ videos.forEach(function(video, i){ $('#rootRow').append(` ${video.title} ${video.jp} ${video.status} ${video.title} ${video.jp} æ”¾é€æ—¶é—´: ${video.time} ${video.desc} ${video.status} `) }) }","keywords":"Bç«™"}],"posts":[{"title":"æµ‹è¯•","slug":"æµ‹è¯•-1","date":"2023-08-27T08:18:42.000Z","updated":"2023-08-27T08:33:26.794Z","comments":true,"path":"2023/08/27/æµ‹è¯•-1/","link":"","permalink":"https://xingxin-99.github.io/2023/08/27/æµ‹è¯•-1/","excerpt":"","text":"table { table-layout: fixed; width: 1000px; /*è¡¨æ ¼å®½åº¦*/ max-width: 1000px; /*è¡¨æ ¼æœ€å¤§å®½åº¦ï¼Œé¿å…è¡¨æ ¼è¿‡å®½*/ border: 1px solid #dedede; /*è¡¨æ ¼å¤–è¾¹æ¡†è®¾ç½®*/ margin: 15px auto; /*å¤–è¾¹è·*/ border-collapse: collapse; /*ä½¿ç”¨å•ä¸€çº¿æ¡çš„è¾¹æ¡†*/ word-break:break-all; word-wrap:break-word; empty-cells: show; /*å•å…ƒæ ¼æ— å†…å®¹ä¾æ—§ç»˜åˆ¶è¾¹æ¡†*/ } table th, table td { height: 35px; /*ç»Ÿä¸€æ¯ä¸€è¡Œçš„é»˜è®¤é«˜åº¦*/ border: 1px solid #dedede; /*å†…éƒ¨è¾¹æ¡†æ ·å¼*/ padding: 0 10px; /*å†…è¾¹è·*/ } table th { font-weight: bold; /*åŠ ç²—*/ text-align: center !important; /*å†…å®¹å±…ä¸­ï¼ŒåŠ ä¸Š !important é¿å…è¢« Markdown æ ·å¼è¦†ç›–*/ background: rgba(158,188,226,0.2); /*èƒŒæ™¯è‰²*/ } table tbody tr:nth-child(2n) { background: rgba(158,188,226,0.12); } table th { white-space: nowrap; /*è¡¨å¤´å†…å®¹å¼ºåˆ¶åœ¨ä¸€è¡Œæ˜¾ç¤º*/ } table th:nth-of-type(1){ width: 20%; } table th:nth-of-type(2){ width: 20%; } table th:nth-of-type(3){ width: 20%; } table th:nth-of-type(4){ width: 40%; } æµ‹è¯•åŸºç¡€ä»€ä¹ˆæ˜¯è½¯ä»¶æµ‹è¯•ï¼Ÿ å¤ä¹ æ—¶é—´ 2023/8/6 2023/8/16 ä½¿ç”¨æŸäº›æŠ€æœ¯æ‰‹æ®µå¯¹è½¯ä»¶è¿›è¡Œæ“ä½œï¼Œå‘ç°è½¯ä»¶ç¼ºé™·ï¼Œåˆ¤æ–­è½¯ä»¶æ˜¯å¦æ»¡è¶³ä½¿ç”¨éœ€æ±‚ ä»€ä¹ˆæ˜¯é»‘ç›’æµ‹è¯•ï¼Ÿ å¤ä¹ æ—¶é—´ 2023/8/4 2023/8/16 é»‘ç›’æµ‹è¯•æ˜¯æŒ‡åœ¨è¿›è¡Œæµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬çœ‹ä¸è§ç¨‹åºçš„æºä»£ç ï¼Œåªå¯¹ç¨‹åºçš„åŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚åœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­ä¸»è¦å…³æ³¨è¾“å…¥ä¸è¾“å‡ºä»¥åŠè¾“å‡ºæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚å…¶ä¸­åŠŸèƒ½æµ‹è¯•åˆå¯ç§°ä¸ºé»‘ç›’æµ‹è¯• ä»€ä¹ˆæ˜¯ç™½ç›’æµ‹è¯•ï¼Ÿ å¤ä¹ æ—¶é—´ 2023/8/4 2023/8/16 ç™½ç›’æµ‹è¯•æ˜¯æŒ‡æµ‹è¯•çš„è¿‡ç¨‹ä¸­èƒ½çœ‹åˆ°ç¨‹åºçš„æºä»£ç ï¼Œä¸»è¦æ˜¯å¯¹ç¨‹åºçš„æºä»£ç è¿›è¡Œæµ‹è¯•ã€‚æµ‹è¯•è€…æ£€æŸ¥ç¨‹åºçš„å†…éƒ¨ç»“æ„ï¼Œæ ¹æ®å†…éƒ¨é€»è¾‘æ¥è®¾è®¡æµ‹è¯•ç”¨ä¾‹ã€‚æ¯”å¦‚å•å…ƒæµ‹è¯•å°±æ˜¯ä¸€ç§ç™½ç›’æµ‹è¯•ã€‚ç™½ç›’æµ‹è¯•æ ¹æ®è½¯ä»¶çš„å†…éƒ¨é€»è¾‘è®¾è®¡æµ‹è¯•ç”¨ä¾‹ï¼Œå¸¸ç”¨çš„æŠ€æœ¯æ˜¯é€»è¾‘è¦†ç›–ï¼Œå³è€ƒå¯Ÿç”¨æµ‹è¯•æ•°æ®è¿è¡Œè¢«æµ‹ç¨‹åºæ—¶å¯¹ç¨‹åºé€»è¾‘çš„è¦†ç›–ç¨‹åº¦ã€‚ä¸»è¦çš„è¦†ç›–æ ‡å‡†æœ‰ 6 ç§ï¼šè¯­å¥è¦†ç›–ã€åˆ¤å®šè¦†ç›–ã€æ¡ä»¶è¦†ç›–ã€åˆ¤å®š/æ¡ä»¶è¦†ç›–ã€ç»„åˆæ¡ä»¶è¦†ç›–å’Œè·¯å¾„è¦†ç›–ã€‚ ä»€ä¹ˆæ˜¯ç°ç›’æµ‹è¯•ï¼Ÿï¼ˆé›†æˆæµ‹è¯•ã€æ¥å£æµ‹è¯•ï¼‰ å¤ä¹ æ—¶é—´ 2023/8/4 2023/8/16 ç°ç›’æµ‹è¯•æ˜¯ä»‹äºç™½ç›’æµ‹è¯•å’Œé»‘ç›’æµ‹è¯•ä¹‹é—´çš„ä¸€ç§æµ‹è¯•æ–¹æ³•ï¼Œå®ƒèƒ½çœ‹è§ç¨‹åºçš„éƒ¨åˆ†æºç ï¼Œä¸»è¦æ˜¯å¯¹ç¨‹åºçš„æ¥å£è¿›è¡Œæµ‹è¯•ã€‚åœ¨æˆ‘ä»¬æ‰§è¡Œæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬æ˜¯å…ˆè¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œå†è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œæœ€åè¿›è¡Œç³»ç»Ÿæµ‹è¯•ã€‚åœ¨æˆ‘ä»¬æµ‹è¯•å®Œæˆå•ä¸ªæ¨¡å—è¿è¡Œæ­£ç¡®ä¹‹åï¼Œè¿˜éœ€è¦å»éªŒè¯å•ä¸ªæ¨¡å—ä¸æ¨¡å—ç»„åˆåœ¨ä¸€èµ·æ—¶æ˜¯å¦ä¼šå‡ºç°é—®é¢˜ï¼Œè¿™ä¸ªæ–¹å¼å°±æ˜¯ç°ç›’æµ‹è¯•ã€‚ ä¸ºä»€ä¹ˆè¿›è¡Œäº†ç™½ç›’æµ‹è¯•ä¹‹åè¿˜è¦è¿›è¡Œé»‘ç›’æµ‹è¯•ï¼Ÿ å¤ä¹ æ—¶é—´ 2023/8/4 2023/8/16 ç™½ç›’æµ‹è¯•ä¸ä»…ä»…å…³æ³¨è¾“å…¥ä¸è¾“å‡ºçš„ç»“æœæ˜¯å¦æ­£ç¡®ï¼ŒåŒæ—¶è¿˜å…³æ³¨ç¨‹åºæ˜¯å¦‚ä½•å¤„ç†çš„ã€‚è€Œé»‘ç›’æµ‹è¯•åœ¨æ•´ä¸ªæµ‹è¯•è¿‡ç¨‹ä¸­åªå…³æ³¨è¾“å…¥å’Œè¾“å‡ºï¼Œå¦‚æœè¾“å…¥ä¸€ä¸ªæµ‹è¯•æ•°æ®ï¼Œè¾“å‡ºçš„ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºè¿™ä¸ªåŠŸèƒ½æ˜¯æ­£ç¡®çš„ã€‚è™½ç„¶ä»æŸç§è§’åº¦æ¥çœ‹ï¼Œç™½ç›’æµ‹è¯•æ¯”é»‘ç›’æµ‹è¯•æ›´ä¸ºå…¨é¢ã€‚ä½†æ˜¯æœ‰ä¸€äº›é»‘ç›’æµ‹è¯•çš„å†…å®¹æ˜¯ç™½ç›’æµ‹è¯•ä¸èƒ½åšåˆ°çš„ã€‚æ¯”å¦‚é»‘ç›’æµ‹è¯•æ˜¯æ›´æ¥è¿‘äºç”¨æˆ·ä½¿ç”¨çš„æµ‹è¯•ï¼Œå› æ­¤æˆ‘ä»¬è¿˜ä¼šå…³æ³¨ç¨‹åºçš„æ˜“ç”¨æ€§ã€ç•Œé¢å±•ç¤ºã€ä¸šåŠ¡æµç¨‹ç­‰ï¼Œè€Œç™½ç›’æµ‹è¯•æ—¶å¹¶ä¸è€ƒè™‘è¿™äº›ã€‚ æµ‹è¯•çš„åŸºæœ¬æµç¨‹ å¤ä¹ æ—¶é—´ 2023/8/16 éœ€æ±‚åˆ†æ é˜…è¯»éœ€æ±‚æ–‡æ¡£ï¼Œè”åˆå‰ç«¯ã€åç«¯ã€æµ‹è¯•ã€äº§å“ç­‰éƒ¨é—¨ï¼Œç¡®ä¿å„éƒ¨é—¨å¯¹éœ€æ±‚ç†è§£ä¸€è‡´ï¼›äº†è§£è½¯ä»¶çš„å…·ä½“åŠŸèƒ½ è®¡åˆ’ç¼–å†™ ç¡®å®šæµ‹è¯•çš„ç›®æ ‡ã€èŒƒå›´å¯¹äººåŠ›ã€ç‰©åŠ›è¿›è¡Œåˆ†é…ï¼Œç¡®å®šé‚£äº›äººè¦å…·ä½“åšå“ªäº›äº‹æƒ…ï¼Œå¯¹è¿›åº¦è¿›è¡Œå®‰æ’ç¡®å®šè¦ä½¿ç”¨å“ªäº›æµ‹è¯•å·¥å…·ã€æµ‹è¯•ç­–ç•¥ ç”¨ä¾‹è®¾è®¡ åˆ†æéœ€æ±‚ï¼Œä»éœ€æ±‚ä¸­æå–æµ‹è¯•ç‚¹ï¼Œæ¥è®¾è®¡æµ‹è¯•ç”¨ä¾‹ ç”¨ä¾‹æ‰§è¡Œï¼Œæäº¤bugï¼Œå›å½’æµ‹è¯• å½“è¿›è¡Œæµ‹è¯•åï¼Œä¼šå‘ç°è½¯ä»¶çš„ç¼ºé™·ã€‚ç¡®å®šç¼ºé™·åï¼Œå°†ç¼ºé™·æäº¤ç»™å¼€å‘äººå‘˜ï¼Œå¼€å‘äººå‘˜ä¿®æ”¹åè¿›è¡Œå›å½’æµ‹è¯• æµ‹è¯•æŠ¥å‘Š å¸¸è§çš„é»‘ç›’æµ‹è¯•æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ| å¤ä¹ æ—¶é—´ | 2023/8/4 | 2023/8/16 || â€” | â€” | â€” | ç­‰ä»·ç±»åˆ’åˆ†æ³•ï¼ˆç©·ä¸¾åœºæ™¯ï¼‰ æŒ‡åœ¨æ‰€æœ‰çš„æµ‹è¯•æ•°æ®ä¸­ï¼Œå¯¹å…·æœ‰æŸç§å…±åŒç‰¹å¾çš„æ•°æ®é›†åˆè¿›è¡Œåˆ’åˆ†ï¼Œç„¶åä»æ¯ä¸€ä¸ªå­é›†ä¸­é€‰å–å°‘æ•°å…·æœ‰ä»£è¡¨æ€§çš„æ•°æ®ä½œä¸ºæµ‹è¯•ç”¨ä¾‹ã€‚ä¸¾ä¾‹ï¼šéªŒè¯6-10ä½è‡ªç„¶æ•°QQå·çš„åˆæ³•æ€§æŒ‰ç…§ç­‰ä»·ç±»åˆ’åˆ†æ³•ï¼šæœ‰æ•ˆç­‰ä»·ç±»ï¼š6-10ä½è‡ªç„¶æ•°ï¼›æ— æ•ˆç­‰ä»·ç±»ï¼š&lt;6ä½ï¼Œ&gt;10ä½è‡ªç„¶æ•°ï¼Œä»¥åŠ6-10ä½éè‡ªç„¶æ•° è¾¹ç•Œå€¼åˆ†æï¼ˆæœ‰è¾¹ç•ŒèŒƒå›´ï¼‰ å¯¹è¾“å…¥ã€è¾“å‡ºçš„è¾¹ç•Œå€¼è¿›è¡Œæµ‹è¯•ã€‚åœ¨è¾¹ç•Œå€¼åˆ†ææ³•ä¸­è§„èŒƒäº†è¦é€‰æ‹©çš„è¾¹ç•Œå€¼ï¼Œä¸Šç‚¹ã€ç¦»ç‚¹ã€å†…ç‚¹ å› æœå›¾åˆ†æ åˆ©ç”¨å›¾è§£æ³•åˆ†æè¾“å…¥çš„å„ç§ç»„åˆæƒ…å†µï¼Œä»è€Œè®¾è®¡æµ‹è¯•ç”¨ä¾‹çš„æ–¹æ³• åˆ¤å®šè¡¨æ³•ï¼ˆå¤šæ¡ä»¶ä¾èµ–å…³ç³»ï¼‰ ä»¥è¡¨æ ¼å½¢å¼è¡¨è¾¾å¤šæ¡ä»¶ä¾èµ–é€»è¾‘åˆ¤æ–­çš„å·¥å…·åˆ¤å®šè¡¨ç”±æ¡ä»¶æ¡©ã€åŠ¨ä½œæ¡©ã€æ¡ä»¶é¡¹ã€åŠ¨ä½œé¡¹ç»„æˆï¼Œæ ¹æ®æ¡ä»¶é¡¹ç¡®å®šåŠ¨ä½œé¡¹ï¼Œè´¯ç©¿æ¡ä»¶é¡¹å’ŒåŠ¨ä½œé¡¹çš„ä¸€åˆ—æ˜¯ä¸€æ¡è§„åˆ™ é”™è¯¯æ¨æµ‹æ³• æ ¹æ®æµ‹è¯•è€…ä»¥å¾€æµ‹è¯•ç»éªŒæ¥å¯¹å¯èƒ½å‡ºç°é”™è¯¯çš„åœ°æ–¹è¿›è¡Œæµ‹è¯•ã€‚ ä¸ºä»€ä¹ˆè¦è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Ÿ å¤ä¹ æ—¶é—´ 2023/8/16 è‡ªåŠ¨åŒ–æµ‹è¯•æ˜¯æŒ‡ä½¿ç”¨è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·æ¥æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œå®ƒæŠŠä»¥äººä¸ºé©±åŠ¨çš„æµ‹è¯•è½¬å˜ä¸ºä»¥æœºå™¨é©±åŠ¨ï¼Œä»£æ›¿äº†æˆ‘ä»¬æ‰‹å·¥æ‰§è¡Œæµ‹è¯•çš„è¡Œä¸ºã€‚ é€šè¿‡é‡‡ç”¨è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œå¯ä»¥æ›¿ä»£å¤§é‡é‡å¤æ€§çš„å·¥ä½œï¼Œæé«˜æµ‹è¯•æ•ˆç‡ ä¿è¯æ¯æ¬¡æµ‹è¯•çš„ä¸€è‡´æ€§å’Œå¯é‡å¤æ€§ã€‚ç”±äºæ¯æ¬¡è‡ªåŠ¨åŒ–æµ‹è¯•æ‰§è¡Œæ—¶è„šæœ¬éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æ¯æ¬¡æ‰§è¡Œçš„æµ‹è¯•å…·æœ‰ä¸€è‡´æ€§ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æé«˜å›å½’æµ‹è¯•çš„æ•ˆç‡ã€‚ å¯ä»¥æ›´å¥½çš„åˆ©ç”¨éå·¥ä½œæ—¶é—´ã€‚ç”±äºè‡ªåŠ¨åŒ–æµ‹è¯•èƒ½å¤Ÿå“ªæ‰¾è®¡åˆ’è‡ªåŠ¨æ‰§è¡Œï¼Œå› æ­¤å°±å¯ä»¥åˆ©ç”¨éå·¥ä½œæ—¶é—´ä½¿ç”¨è‡ªåŠ¨åŒ–æµ‹è¯•æ¥æ‰§è¡Œæµ‹è¯•ã€‚æµ‹è¯•ç”¨ä¾‹ç¼–å†™è§„èŒƒ| ç”¨ä¾‹ç¼–å· | ç”¨ä¾‹æ ‡é¢˜ | æµ‹è¯•æ¨¡å—/é¡¹ç›® | ç”¨ä¾‹çº§åˆ« | é¢„ç½®æ¡ä»¶ | æµ‹è¯•æ­¥éª¤ | æµ‹è¯•æ•°æ® | é¢„æœŸç»“æœ || â€” | â€” | â€” | â€” | â€” | â€” | â€” | â€” || | é¢„æœŸç»“æœ(æµ‹è¯•ç‚¹) | | | | | | || login_001 | ç™»é™†å¤±è´¥ï¼ˆæ‰‹æœºå·æœªæ³¨å†Œ+éç©ºå¯†ç ï¼‰ | login | P1 | 1.APPåº”ç”¨æ­£å¸¸2.ç½‘ç»œæ­£å¸¸ | 1.æ‰“å¼€ç™»å½•é¡µé¢2.è¾“å…¥æ‰‹æœºå·3.è¾“å…¥å¯†ç 4.ç‚¹å‡»ç™»å½• | æ‰‹æœºå·ï¼š13257894512å¯†ç ï¼š1458796 | ç™»é™†å¤±è´¥ã€‚æç¤ºï¼šâ€œæ‰‹æœºå·æœªæ³¨å†Œâ€| Selenium Seleniumç»„ä»¶ ä»‹ç» Selenium WebDriver æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œæµè§ˆå™¨ Selenium IDE æä¾›å½•åˆ¶Seleniumæµ‹è¯•ç”¨ä¾‹ Selenium Grid æ¨¡æ‹Ÿå¤šä¸ªæ“ä½œç³»ç»Ÿ/æµè§ˆå™¨æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ LinuxLinuxå¦‚ä½•å®æ—¶æŸ¥çœ‹æ—¥å¿—è®°å½•ï¼Ÿ å‘½ä»¤ æè¿° less filename tail notes.log é»˜è®¤æ˜¾ç¤ºæœ€å 10 è¡Œã€‚ -f å¾ªç¯è¯»å–-c&lt;æ•°ç›®&gt; æ˜¾ç¤ºçš„å­—èŠ‚æ•°-n&lt;è¡Œæ•°&gt; æ˜¾ç¤ºæ–‡ä»¶çš„å°¾éƒ¨ n è¡Œå†…å®¹ || tail -f filename | æŠŠ filename æ–‡ä»¶é‡Œçš„æœ€å°¾éƒ¨çš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œå¹¶ä¸”ä¸æ–­åˆ·æ–°ï¼Œåªè¦ filename æ›´æ–°å°±å¯ä»¥çœ‹åˆ°æœ€æ–°çš„æ–‡ä»¶å†…å®¹ã€‚ || tail -n +20 notes.log | æ˜¾ç¤ºæ–‡ä»¶ notes.log çš„å†…å®¹ï¼Œä»ç¬¬ 20 è¡Œè‡³æ–‡ä»¶æœ«å°¾ || tail -c 10 notes.log | æ˜¾ç¤ºæ–‡ä»¶ notes.log çš„æœ€å 10 ä¸ªå­—ç¬¦: | linuxå‘½ä»¤ï¼Œç»Ÿè®¡ä¸€ä¸ªæ–‡æœ¬ä¸­å…³é”®å­—å‡ºç°çš„æ¬¡æ•°grep -o targetStr filename | wc -l linux æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ‰€æœ‰åç¼€ä¸º .pyæ–‡ä»¶find ./ -name &quot;*.py&quot; linuxå¸¸ç”¨å‘½ä»¤ï¼šæŸ¥çœ‹æŒ‡å®šç«¯å£è¿›ç¨‹# æŸ¥çœ‹æŸè¿›ç¨‹ç«¯å£å ç”¨æƒ…å†µ ps -ef |grep tomcat ps -p PID æŸ¥çœ‹è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ åœºæ™¯é¢˜è®¾è®¡è´­ç‰©è½¦æµ‹è¯•ç”¨ä¾‹æœç´¢é¡µé¢è®¾è®¡æµ‹è¯•ç”¨ä¾‹æŠ¢çº¢åŒ…è®¾è®¡æµ‹è¯•ç”¨ä¾‹å¾®ä¿¡æœ‹å‹åœˆæµ‹è¯•ç”¨ä¾‹æ”¯ä»˜æµ‹è¯•ç”¨ä¾‹æ·˜å®æœç´¢æ¡†æµ‹è¯•ç”¨ä¾‹å¼€æ”¾æ€§é—®é¢˜æ€ä¹ˆç†è§£çš„æµ‹å¼€è¿™ä¸ªå²—ä½","categories":[{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"https://xingxin-99.github.io/categories/æµ‹è¯•/"}],"tags":[{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"https://xingxin-99.github.io/tags/æµ‹è¯•/"}],"keywords":[{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"https://xingxin-99.github.io/categories/æµ‹è¯•/"}]},{"title":"WebSocket","slug":"WebSocket","date":"2023-08-26T10:50:39.000Z","updated":"2023-08-27T08:19:55.542Z","comments":true,"path":"2023/08/26/WebSocket/","link":"","permalink":"https://xingxin-99.github.io/2023/08/26/WebSocket/","excerpt":"","text":"WebSocketWbeSocketæ˜¯ä¸€ä¸ªåŸºäºTCPçš„ä¸€ç§æ–°çš„ç½‘ç»œåè®®ï¼ˆwsåè®®ï¼‰ï¼ˆä¸åŒäºHttpåè®®ï¼‰ï¼Œæ˜¯ä¸€ç§å…¨åŒå·¥çš„é€šä¿¡åè®®ï¼Œå®ƒå³å…è®¸æµè§ˆå™¨å‘æœåŠ¡å™¨ç«¯æ¨é€æ¶ˆæ¯ï¼ŒåŒæ—¶ä¹Ÿå…è®¸æœåŠ¡å™¨ç«¯å‘æµè§ˆå™¨æ¨é€æ¶ˆæ¯ã€‚æµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦ç»å†ä¸€æ¬¡æ¡æ‰‹ï¼Œå°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæŒä¹…æ€§è¿æ¥ï¼Œå¹¶åœ¨è¿æ¥ä¸­è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚ WebSocketå’ŒHttpæœ‰ä»€ä¹ˆä¸åŒï¼ŸWebSocketæ˜¯ä¸€ç§å…¨åŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œå®ƒå…è®¸ä¸¤ç«¯éƒ½å¯ä»¥ä¸»åŠ¨çš„å‘å¯¹æ–¹æ¨é€æ¶ˆæ¯ï¼Œå› æ­¤Websocketæ›´åƒæ˜¯ç°å®ç”Ÿæ´»ä¸­æ‰“ç”µè¯çš„åœºæ™¯ï¼Œç”µè¯æ¥é€šåï¼ŒåŒæ–¹éƒ½å¯ä»¥å¬åˆ°å¯¹æ–¹çš„ä¿¡æ¯ã€‚è€ŒHttpå®ƒæ˜¯è¯·æ±‚å“åº”æ¨¡å¼ï¼Œç”±å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œæµè§ˆå™¨å›ä»¥å“åº”ã€‚ Websocketçš„åº”ç”¨åœºæ™¯ï¼ˆé¡µé¢ä¸åˆ·æ–°ï¼Œä½†æ•°æ®å¯ä»¥å®æ—¶å˜åŒ–ï¼‰è§†é¢‘å¼¹å¹•ã€ç½‘é¡µèŠå¤©ï¼ˆé€šè¿‡WebsocketæŠŠèŠå¤©æ¶ˆæ¯æ¨é€åˆ°é¡µé¢ä¸­æ˜¾ç¤ºï¼‰ã€ä½“è‚²å®å†µæ›´æ–°ã€è‚¡ç¥¨åŸºé‡‘æŠ¥ä»·å®æ—¶æ›´æ–° WebSocketçš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å»ºç«‹è¿æ¥çš„è¯·æ±‚ï¼Œæ­¤æ—¶å‘é€çš„è¯·æ±‚ä¿¡æ¯å¦‚ä¸‹ï¼š GET /chat HTTP/1.1 Host: server.example.com Upgrade: websocket Connection: Upgrade Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw== Sec-WebSocket-Protocol: chat, superchat Sec-WebSocket-Version: 13 Origin: http://example.com Upgrade: åœ¨ HTTP è¯·æ±‚ä¸­ï¼ŒUpgrade å¤´éƒ¨å­—æ®µé€šçŸ¥æœåŠ¡å™¨å®¢æˆ·ç«¯å¸Œæœ›å‡çº§åˆ°å…¶ä»–åè®®ã€‚å®ƒæŒ‡ç¤ºæœåŠ¡å™¨åœ¨å“åº”ä¸­æ˜¯å¦æ”¯æŒå‡çº§ï¼Œå¹¶å°†åè®®æ›´æ”¹ä¸ºè¯·æ±‚ä¸­æŒ‡å®šçš„åè®®ã€‚Connection: Upgrade : åœ¨ HTTP è¯·æ±‚ä¸­ï¼ŒConnection å¤´éƒ¨å­—æ®µæŒ‡ç¤ºå®¢æˆ·ç«¯æ˜¯å¦å¸Œæœ›ä¸æœåŠ¡å™¨å»ºç«‹æŒä¹…è¿æ¥ã€‚è€Œå½“ä¸ Upgrade å¤´éƒ¨ä¸€åŒä½¿ç”¨æ—¶ï¼ŒConnection: Upgrade è¡¨ç¤ºå®¢æˆ·ç«¯å¸Œæœ›å‡çº§åˆ°å…¶ä»–åè®®ï¼Œå¹¶è¦æ±‚æœåŠ¡å™¨åœ¨å“åº”ä¸­è¿›è¡Œåè®®å‡çº§ã€‚åœ¨æœåŠ¡å™¨çš„å“åº”ä¸­ï¼Œå¦‚æœæ”¯æŒå‡çº§åˆ° WebSocketï¼Œä¼šåŒ…å«å¦‚ä¸‹çš„å“åº”å¤´éƒ¨ï¼š HTTP/1.1 101 Switching Protocols Upgrade: websocket Connection: Upgrade Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo= è¿™æ ·ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å°±ä¼šä»æ™®é€šçš„ HTTP è¿æ¥å‡çº§ä¸º WebSocket è¿æ¥ï¼Œåç»­é€šä¿¡å°†ä½¿ç”¨ WebSocket åè®®ã€‚ åœ¨WeSocketä¹‹å‰æ˜¯å¦‚ä½•è¿›è¡Œå®æ—¶é€šä¿¡çš„ï¼Ÿ è½®è¯¢ã€‚å®¢æˆ·ç«¯å®šæœŸå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œåˆ¤æ–­æœåŠ¡å™¨ä¸­æ˜¯å¦æœ‰æ–°çš„æ•°æ®å¯ç”¨ã€‚æ‹¿æ¥å•æé†’è¿™ä¸ªåŠŸèƒ½ä¸¾ä¾‹ï¼Œå¦‚æœä¸ä½¿ç”¨WebSocketï¼Œå°±éœ€è¦å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯è½®è¯¢çš„å‘èµ·æŸ¥è¯¢è¯·æ±‚ï¼Œåˆ¤æ–­æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨æ–°çš„è¿˜æœªè¿›è¡Œæ¥å•æé†’è®¢å•æ•°æ®ï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™å°†æ¥å•æé†’éœ€è¦çš„ä¿¡æ¯è¿”å›ç»™å‰ç«¯ã€‚ç¼ºç‚¹ï¼šä¼šåœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´äº§ç”Ÿå¤§é‡çš„è¯·æ±‚ä¸å“åº”ï¼Œå¯¼è‡´ä¸å¿…è¦çš„ç½‘ç»œå¼€é”€å’Œå»¶è¿Ÿã€‚ é•¿è½®è¯¢ã€‚å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚åï¼Œä¿æŒè¿æ¥æ‰“å¼€ï¼Œç­‰å¾…æ–°æ•°æ®å“åº”ååœ¨å…³é—­è¿æ¥ã€‚ä¼˜ç¼ºç‚¹ï¼šè§£å†³äº†æ— æ•ˆè½®è¯¢çš„æ•°é‡ï¼Œä½†ä»ç„¶éœ€è¦é¢‘ç¹å»ºç«‹å’Œå…³é—­è¿æ¥ã€‚ Cometã€‚æ¨¡æ‹Ÿå®æ—¶é€šä¿¡ï¼Œåœ¨è¿”å›è¯·æ±‚åç»§ç»­ä¿æŒè¿æ¥æ‰“å¼€ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ä¿æŒé•¿è¿æ¥æ¥å®ç°å®æ—¶é€šä¿¡ï¼Œå¹¶å…è®¸æœåŠ¡å™¨é€šè¿‡æµå¼ä¼ è¾“ç­‰æ¨é€æŠ€æœ¯æ¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ã€‚ç¼ºç‚¹ï¼š è¯¥æ–¹æ³•ä¾ç„¶ä¾èµ–äºæ— çŠ¶æ€çš„HTTPè¿æ¥ï¼Œå…¶è¦æ±‚æœåŠ¡å™¨ç«¯æœ‰ç‰¹æ®Šçš„åŠŸèƒ½(ç±»ä¼¼äºæµå¼ä¼ è¾“ç­‰æ¨é€æŠ€æœ¯)æ¥ä¸´æ—¶æŒ‚èµ·è¿æ¥ã€‚ WebSocketçš„ä¼˜åŠ¿ åŒå‘å®æ—¶é€šä¿¡ã€‚åœ¨å•ä¸ªã€é•¿æ—¶é—´çš„è¿æ¥ä¸Šè¿›è¡ŒåŒå‘å®æ—¶é€šä¿¡ã€‚åœ¨éœ€è¦å¿«é€Ÿå®æ—¶æ›´æ–°çš„åº”ç”¨ç¨‹åºé‡Œï¼Œæ¯”HTTPæ›´é«˜æ•ˆã€‚ é™ä½å»¶è¿Ÿã€‚æ•°æ®å¯ç”¨åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´ä»¥æ¯”HTTPæ›´ä½çš„å»¶è¿Ÿè¿›è¡Œä¼ è¾“ã€‚ï¼ˆå¤´éƒ¨ç›¸å¯¹è¾ƒå°ï¼›åœ¨é•¿è¿æ¥é‡Œä¼ è¾“æ•°æ®ï¼Œä¸å¿…åœ¨æ¯æ¬¡å»ºç«‹è¿æ¥ï¼‰ æ›´é«˜æ•ˆçš„èµ„æºåˆ©ç”¨ã€‚ç”±äºè¿æ¥åªå»ºç«‹äº†ä¸€æ¬¡ï¼Œå› æ­¤å‡å°‘äº†é‡å¤è¯·æ±‚å’Œå“åº”çš„å¼€é”€ WebSocketçš„é™åˆ¶ ä¸æä¾›åŠ å¯†åŠŸèƒ½ã€‚å¦‚æœä¼ è¾“çš„æ•°æ®è¦ä¿è¯å®‰å…¨æ€§ï¼Œéœ€é‡‡ç”¨åƒSSLè¿™æ ·çš„åè®® ä¸æ”¯æŒå¤è€æµè§ˆå™¨ã€‚ ä¿æŒé•¿è¿æ¥éœ€è¦æœåŠ¡å™¨ä¸æ–­ç»´æŠ¤å’Œå¤„ç†è¿æ¥çš„çŠ¶æ€ã€‚ å®ç°æ­¥éª¤ ä½¿ç”¨websocket.htmlé¡µé¢ä½œä¸ºWebSocketå®¢æˆ·ç«¯ï¼ˆç”±å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ¡æ‰‹è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å“åº”åï¼ŒäºŒè€…å°±å»ºç«‹äº†æŒä¹…è¿æ¥ï¼‰ å¯¼å…¥WebSocketçš„mavenåæ ‡ å¯¼å…¥WebSocketæœåŠ¡ç«¯ç»„ä»¶WebSocketServerï¼ˆæ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚å¹¶å¤„ç†ï¼Œç±»ä¼¼äºControllerï¼‰ï¼Œç”¨äºå’Œå®¢æˆ·ç«¯é€šä¿¡ å¯¼å…¥é…ç½®ç±»WebSocketConfigurationï¼Œæ³¨å†ŒWebSocketçš„æœåŠ¡ç«¯ç»„ä»¶ å¯¼å…¥å®šæ—¶ä»»åŠ¡ç±»WebSocketTaskï¼Œå®šæ—¶å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼ˆç”¨äºæµ‹è¯•ï¼Œå¯æœ‰å¯æ— ï¼‰ å‡½æ•°/æ³¨è§£ ä½œç”¨ new WebSocket(url) å‘åœ°å€ä¸ºurlçš„æœåŠ¡ç«¯å»ºç«‹è¿æ¥ï¼Œå¹¶è¿”å›wså¯¹è±¡ï¼Œé‡Œé¢æä¾›äº†è¿æ¥ç›¸å…³çš„API @ServerEndpoint(â€œ/ws/{sid}â€) å°†ç›®å‰çš„ç±»å®šä¹‰æˆä¸€ä¸ªwebsocketæœåŠ¡å™¨ç«¯, æ³¨è§£çš„å€¼å°†è¢«ç”¨äºç›‘å¬ç”¨æˆ·è¿æ¥çš„ç»ˆç«¯è®¿é—®URLåœ°å€,å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ªURLæ¥è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ç«¯ @OnOpen è¿æ¥å»ºç«‹æˆåŠŸè°ƒç”¨æ–¹æ³• @OnMessage æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨æ–¹æ³• WebSocketç»„ä»¶package com.sky.websocket; import org.springframework.stereotype.Component; import javax.websocket.OnClose; import javax.websocket.OnMessage; import javax.websocket.OnOpen; import javax.websocket.Session; import javax.websocket.server.PathParam; import javax.websocket.server.ServerEndpoint; import java.util.Collection; import java.util.HashMap; import java.util.Map; /** * WebSocketæœåŠ¡ */ @Component //æ ‡è¯†è¯¥ç±»ä¸ºWebSokcetæœåŠ¡å™¨ç«¯ï¼Œç›‘å¬è¯¥URLåœ°å€ï¼Œå®¢æˆ·ç«¯å¯é€šè¿‡è¯¥URLè¿æ¥åˆ°è¯¥æœåŠ¡å™¨ç«¯ @ServerEndpoint(&quot;/ws/{sid}&quot;) public class WebSocketServer { //å­˜æ”¾ä¼šè¯å¯¹è±¡ //ä¸€ä¸ªSessionå°±æ˜¯ä¸€ä¸ªä¼šè¯ï¼Œå½“å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥åï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªsessionä¼šè¯ private static Map&lt;String, Session&gt; sessionMap = new HashMap(); /** * è¿æ¥å»ºç«‹æˆåŠŸè°ƒç”¨çš„æ–¹æ³• * sidä¸ºå®¢æˆ·ç«¯çš„æ ‡è¯†ï¼Œè¿æ¥å»ºç«‹æˆåŠŸåˆ™æŠŠè¯¥ä¼šè¯å­˜å…¥åˆ°mapä¸­ */ @OnOpen public void onOpen(Session session, @PathParam(&quot;sid&quot;) String sid) { System.out.println(&quot;å®¢æˆ·ç«¯ï¼š&quot; + sid + &quot;å»ºç«‹è¿æ¥&quot;); sessionMap.put(sid, session); } /** * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³• * * @param message å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯ */ @OnMessage public void onMessage(String message, @PathParam(&quot;sid&quot;) String sid) { System.out.println(&quot;æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯ï¼š&quot; + sid + &quot;çš„ä¿¡æ¯:&quot; + message); } /** * è¿æ¥å…³é—­è°ƒç”¨çš„æ–¹æ³• * * @param sid */ @OnClose public void onClose(@PathParam(&quot;sid&quot;) String sid) { System.out.println(&quot;è¿æ¥æ–­å¼€:&quot; + sid); sessionMap.remove(sid); } /** * ç¾¤å‘ * * @param message */ public void sendToAllClient(String message) { Collection&lt;Session&gt; sessions = sessionMap.values(); for (Session session : sessions) { try { //æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ session.getBasicRemote().sendText(message); } catch (Exception e) { e.printStackTrace(); } } } } å®šä¹‰é…ç½®ç±»ï¼Œæ³¨å†ŒWebSocketçš„æœåŠ¡ç«¯ç»„ä»¶ package com.sky.config; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.web.socket.server.standard.ServerEndpointExporter; /** * WebSocketé…ç½®ç±»ï¼Œç”¨äºæ³¨å†ŒWebSocketçš„Bean */ @Configuration public class WebSocketConfiguration { @Bean public ServerEndpointExporter serverEndpointExporter() { return new ServerEndpointExporter(); } } æ¥å•æé†’åŠŸèƒ½å®ç° é€šè¿‡WebSocketæ¥å®ç°ç®¡ç†ç«¯é¡µé¢å’ŒæœåŠ¡ç«¯ä¿æŒé•¿è¿æ¥æœåŠ¡ç«¯ï¼šå¼•å…¥WebSocketä¾èµ–ï¼Œæ³¨å†ŒWebSokcetç»„ä»¶ï¼Œç›‘å¬Websocketå®¢æˆ·ç«¯å‘é€çš„å»ºç«‹è¿æ¥æ¶ˆæ¯æµè§ˆå™¨ï¼šåœ¨å‰ç«¯é¡µé¢ä¸­å·²ç»å†™å¥½äº†WebSocketç›¸å…³çš„jsä»£ç ï¼Œç™»å½•æˆåŠŸåï¼Œé¡µé¢è§£æjsä»£ç ï¼Œå‘æœåŠ¡ç«¯å‘é€å»ºç«‹è¿æ¥çš„è¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åå“åº”æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„é•¿è¿æ¥å»ºç«‹æˆåŠŸï¼Œä¹‹ååŒæ–¹ä¾¿å¯é€šè¿‡è¯¥è¿æ¥æ¨é€æ¶ˆæ¯ å½“å®¢æˆ·æ”¯ä»˜åï¼Œè°ƒç”¨WebSocketçš„ç›¸å…³APIå®ç°æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯å½“å®¢æˆ·æ”¯ä»˜æˆåŠŸåï¼Œå¾®ä¿¡ç«¯ä¼šè°ƒç”¨æˆ‘ä»¬å†™å¥½çš„ä¸€ä¸ªå›è°ƒæ–¹æ³•paySuccess()æ¥æ‰§è¡Œæ”¯ä»˜æˆåŠŸåçš„å¤„ç†é€»è¾‘ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¯¥å›è°ƒå‡½æ•°çš„é€»è¾‘ä¸­è¡¥å……äº†ç”±æœåŠ¡å™¨ç«¯å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯çš„ä»£ç ã€‚ä¸»è¦é€»è¾‘ï¼šæ³¨å…¥WebSocketServerå¯¹è±¡ï¼Œç”Ÿæˆæˆ‘ä»¬è¦å‘é€åˆ°å®¢æˆ·ç«¯çš„JSONæ¶ˆæ¯ï¼Œè°ƒç”¨å†™å¥½çš„å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯çš„APIï¼ˆæµè§ˆå™¨ç«¯ä¸æœåŠ¡å™¨ç«¯å»ºç«‹é•¿è¿æ¥åç”Ÿæˆä¸€ä¸ªsessionå¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªsessionå¯¹è±¡å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼‰ï¼Œå°†è¯¥æ¶ˆæ¯æ¨é€åˆ°å®¢æˆ·ç«¯é¡µé¢ @Autowired private WebSocketServer webSocketServer; /** * æ”¯ä»˜æˆåŠŸï¼Œä¿®æ”¹è®¢å•çŠ¶æ€ * * @param outTradeNo */ public void paySuccess(String outTradeNo) { // å½“å‰ç™»å½•ç”¨æˆ·id Long userId = BaseContext.getCurrentId(); // æ ¹æ®è®¢å•å·æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„è®¢å• Orders ordersDB = orderMapper.getByNumberAndUserId(outTradeNo, userId); // æ ¹æ®è®¢å•idæ›´æ–°è®¢å•çš„çŠ¶æ€ã€æ”¯ä»˜æ–¹å¼ã€æ”¯ä»˜çŠ¶æ€ã€ç»“è´¦æ—¶é—´ Orders orders = Orders.builder() .id(ordersDB.getId()) .status(Orders.TO_BE_CONFIRMED) .payStatus(Orders.PAID) .checkoutTime(LocalDateTime.now()) .build(); orderMapper.update(orders); ////////////////////////////////////////////// Map map = new HashMap(); map.put(&quot;type&quot;, 1);//æ¶ˆæ¯ç±»å‹ï¼Œ1è¡¨ç¤ºæ¥å•æé†’ map.put(&quot;orderId&quot;, orders.getId()); map.put(&quot;content&quot;, &quot;è®¢å•å·ï¼š&quot; + outTradeNo); //é€šè¿‡WebSocketå®ç°æ¥å•æé†’ï¼Œå‘å®¢æˆ·ç«¯æµè§ˆå™¨æ¨é€æ¶ˆæ¯ webSocketServer.sendToAllClient(JSON.toJSONString(map)); /////////////////////////////////////////////////// } /** * ç¾¤å‘ * * @param message */ public void sendToAllClient(String message) { Collection&lt;Session&gt; sessions = sessionMap.values(); for (Session session : sessions) { try { //æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ session.getBasicRemote().sendText(message); } catch (Exception e) { e.printStackTrace(); } } } å®¢æˆ·ç«¯æµè§ˆå™¨è§£ææœåŠ¡ç«¯æ¨é€çš„æ¶ˆæ¯ï¼Œåˆ¤æ–­æ˜¯æ¥å•æé†’è¿˜æ˜¯å®¢æˆ·å‚¬å•ï¼Œè¿›è¡Œç›¸åº”çš„æ¶ˆæ¯æç¤ºå’Œè¯­éŸ³æ’­æŠ¥ï¼ˆå‰ç«¯é¡µé¢å·²å®ç°ï¼‰ çº¦å®šæœåŠ¡ç«¯å‘é€ç»™å®¢æˆ·ç«¯æµè§ˆå™¨çš„æ•°æ®æ ¼å¼ä¸ºJSONï¼Œå­—æ®µåŒ…æ‹¬ï¼štypeï¼ŒorderIdï¼Œcontent type ä¸ºæ¶ˆæ¯ç±»å‹ï¼Œ1ä¸ºæ¥å•æé†’ 2ä¸ºå®¢æˆ·å‚¬å• orderId ä¸ºè®¢å•id content ä¸ºæ¶ˆæ¯å†…å®¹ å‚è€ƒä¸€æ–‡åƒé€ WebSocket åŸç† åˆšé¢è¯•å®Œï¼Œè¶çƒ­èµ¶ç´§æ•´ç† - æ˜é‡‘10 åˆ†é’Ÿ ç†è®º + å®æ“ ææ‡‚ WebSocket_å“”å“©å“”å“©_bilibili","categories":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/categories/é¡¹ç›®/"}],"tags":[{"name":"WebSocket","slug":"WebSocket","permalink":"https://xingxin-99.github.io/tags/WebSocket/"}],"keywords":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/categories/é¡¹ç›®/"}]},{"title":"JWTå®‰å…¨è®¤è¯","slug":"JWTå®‰å…¨è®¤è¯","date":"2023-08-26T10:50:12.000Z","updated":"2023-08-26T10:57:05.254Z","comments":true,"path":"2023/08/26/JWTå®‰å…¨è®¤è¯/","link":"","permalink":"https://xingxin-99.github.io/2023/08/26/JWTå®‰å…¨è®¤è¯/","excerpt":"","text":"JWTå®‰å…¨è®¤è¯JWTçš„å…¨ç§°ä¸ºJson Web Tockenï¼Œå®ƒé€šè¿‡æ•°å­—ç­¾åçš„æ–¹å¼ï¼Œä»¥Jsonå¯¹è±¡ä¸ºè½½ä½“ï¼Œå®ç°åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å®‰å…¨çš„ä¼ è¾“æ•°æ®ã€‚JWTç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œè¿™ä¸‰éƒ¨åˆ†åˆ†åˆ«æ˜¯Headerã€Payloadã€Signatureï¼Œè¿™ä¸‰éƒ¨åˆ†ä¹‹é—´ç”¨.æ‹¼æ¥ã€‚å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»å½•åï¼Œç”ŸæˆJWTï¼Œå¹¶å°†å…¶ä»¥tockenè¿”å›ç»™å‰ç«¯ã€‚åç»­å®¢æˆ·ç«¯æ¯æ¬¡å‘èµ·çš„è¯·æ±‚éƒ½åŒ…å«JWTã€‚ç³»ç»Ÿåœ¨å¤„ç†è¯·æ±‚ä¹‹å‰ï¼Œä¼šå…ˆä½¿ç”¨æ‹¦æˆªå™¨æ‹¦æˆªè¯·æ±‚ï¼Œå¯¹è¯·æ±‚ä¸­çš„JWTè¿›è¡Œå®‰å…¨æ ¡éªŒï¼Œé€šè¿‡ä¹‹åæ‰æ”¾è¡Œ JWTç»„æˆ Headerç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼štokençš„ç±»å‹ä»¥åŠç­¾åç®—æ³•çš„åç§°ã€‚ { &#39;alg&#39;: &quot;HS256&quot;, &#39;typ&#39;: &quot;JWT&quot; } ç”¨Base64å¯¹è¿™ä¸ªJSONç¼–ç å°±å¾—åˆ°JWTçš„ç¬¬ä¸€éƒ¨åˆ† Payload(è´Ÿè½½)ï¼šåœ¨è´Ÿè½½ä¸­å¯ä»¥å£°æ˜ä¸€äº›ç”¨äºä¼ è¾“çš„æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·åç­‰ä¿¡æ¯ { &quot;sub&quot;: &#39;1234567890&#39;, &quot;name&quot;: &#39;john&#39;, &quot;admin&quot;:true } Signatureï¼šå¯¹headå’ŒpayloadæŒ‰ç…§æŒ‡å®šçš„ç­¾åç®—æ³•è¿›è¡Œç­¾åï¼Œä¿è¯JWTæ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ var encodedString = base64UrlEncode(header) +&#39;.&#39;+ base64UrlEncode(payLoad); var signature = HMACSHA256(encodedString,&#39;secret&#39;); å¦‚ä½•èƒ½ç¡®ä¿JWTæ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ï¼Ÿ é¦–å…ˆï¼ŒJWTç”±å¤´éƒ¨ã€è´Ÿè½½ã€ç­¾åä¸‰éƒ¨åˆ†ç»„æˆï¼Œå¤´éƒ¨åŒ…å«äº†tockenç±»å‹ä»¥åŠä½¿ç”¨çš„ç­¾åç®—æ³•ï¼Œè€Œè´Ÿè½½ä¸­æœ‰æˆ‘ä»¬æ‰€å£°æ˜çš„JSONå‹çš„æ•°æ®ä¿¡æ¯ï¼Œè€Œç­¾åæ˜¯å¯¹å¤´éƒ¨å’Œè´Ÿè½½è¿›è¡Œbase64ç¼–ç åï¼Œé€šè¿‡ç­¾åç®—æ³•ä»¥åŠæœåŠ¡å™¨ç«¯ç”Ÿæˆçš„ç§˜é’¥å¯¹base64ç¼–ç åçš„å¤´éƒ¨å’Œè´Ÿè½½è¿›è¡Œç­¾åã€‚å¦‚æœæœ‰äººå¯¹å¤´éƒ¨å’Œè´Ÿè½½å†…å®¹è§£ç ä¹‹åå†ç”Ÿæˆæ–°çš„JWTï¼Œç”±äºå®ƒä¸çŸ¥é“æœåŠ¡å™¨ç«¯ç§˜é’¥ï¼Œå› æ­¤æœåŠ¡å™¨ç«¯è¿›è¡ŒJWTæ ¡éªŒå¤±è´¥ï¼Œå°±åˆ¤æ–­æ­¤JWTå·²ç»è¢«ç¯¡æ”¹ã€‚ å‚è€ƒï¼šJWTè¯¦ç»†æ•™ç¨‹ä¸ä½¿ç”¨jwtæ•™ç¨‹ä¸€æ”¯æœ‰ç†æƒ³çš„æœˆæœˆé¸Ÿçš„åšå®¢-CSDNåšå®¢ åœ¨é¡¹ç›®ä¸­å¦‚ä½•å®ç°JWTå®‰å…¨è®¤è¯çš„ï¼Ÿ å¼•å…¥JWTçš„ç›¸å…³ä¾èµ– é€šè¿‡Jwts.builderå»åˆ›å»ºä¸€ä¸ªjwtï¼Œé€šè¿‡setClaimsæ–¹æ³•è®¾ç½®ç§æœ‰å£°æ˜ï¼Œç§æœ‰å£°æ˜å°±æ˜¯æˆ‘ä»¬æƒ³åœ¨æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¼ é€çš„æ•°æ®ï¼Œé€šè¿‡signWithæ–¹æ³•è®¾ç½®ç­¾åä½¿ç”¨çš„ç­¾åç®—æ³•åŠç­¾åç§˜é’¥ï¼Œé€šè¿‡setExpirationæ–¹æ³•è®¾ç½®ç­¾åè¿‡æœŸæ—¶é—´ï¼Œé€šè¿‡compactæ–¹æ³•å°†è¿™äº›ä¿¡æ¯ç»„åˆï¼Œç”ŸæˆJWT public class JwtUtil { /** * ç”Ÿæˆjwt * ä½¿ç”¨Hs256ç®—æ³•, ç§åŒ™ä½¿ç”¨å›ºå®šç§˜é’¥ * * @param secretKey jwtç§˜é’¥ * @param ttlMillis jwtè¿‡æœŸæ—¶é—´(æ¯«ç§’) * @param claims è®¾ç½®çš„ä¿¡æ¯ * @return */ public static String createJWT(String secretKey, long ttlMillis, Map&lt;String, Object&gt; claims) { // æŒ‡å®šç­¾åçš„æ—¶å€™ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼Œä¹Ÿå°±æ˜¯headeré‚£éƒ¨åˆ† SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256; // ç”ŸæˆJWTçš„æ—¶é—´ long expMillis = System.currentTimeMillis() + ttlMillis; Date exp = new Date(expMillis); // è®¾ç½®jwtçš„body JwtBuilder builder = Jwts.builder() // å¦‚æœæœ‰ç§æœ‰å£°æ˜ï¼Œä¸€å®šè¦å…ˆè®¾ç½®è¿™ä¸ªè‡ªå·±åˆ›å»ºçš„ç§æœ‰çš„å£°æ˜ï¼Œè¿™ä¸ªæ˜¯ç»™builderçš„claimèµ‹å€¼ï¼Œä¸€æ—¦å†™åœ¨æ ‡å‡†çš„å£°æ˜èµ‹å€¼ä¹‹åï¼Œå°±æ˜¯è¦†ç›–äº†é‚£äº›æ ‡å‡†çš„å£°æ˜çš„ .setClaims(claims) // è®¾ç½®ç­¾åä½¿ç”¨çš„ç­¾åç®—æ³•å’Œç­¾åä½¿ç”¨çš„ç§˜é’¥ .signWith(signatureAlgorithm, secretKey.getBytes(StandardCharsets.UTF_8)) // è®¾ç½®è¿‡æœŸæ—¶é—´ .setExpiration(exp); return builder.compact(); } /** * Tokenè§£å¯† * * @param secretKey jwtç§˜é’¥ æ­¤ç§˜é’¥ä¸€å®šè¦ä¿ç•™å¥½åœ¨æœåŠ¡ç«¯, ä¸èƒ½æš´éœ²å‡ºå», å¦åˆ™signå°±å¯ä»¥è¢«ä¼ªé€ , å¦‚æœå¯¹æ¥å¤šä¸ªå®¢æˆ·ç«¯å»ºè®®æ”¹é€ æˆå¤šä¸ª * @param token åŠ å¯†åçš„token * @return */ public static Claims parseJWT(String secretKey, String token) { // å¾—åˆ°DefaultJwtParser Claims claims = Jwts.parser() // è®¾ç½®ç­¾åçš„ç§˜é’¥ .setSigningKey(secretKey.getBytes(StandardCharsets.UTF_8)) // è®¾ç½®éœ€è¦è§£æçš„jwt .parseClaimsJws(token).getBody(); return claims; } } åç«¯å°†tockenä¼ é€’åˆ°å‰ç«¯ï¼Œé‚£ä¹ˆä¹‹åæ¯æ¬¡å‘é€è¯·æ±‚æ—¶ï¼Œè¯·æ±‚çš„headerä¸­éƒ½æºå¸¦è¯¥tockenä¿¡æ¯ã€‚å½“å‰ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šåœ¨æ‹¦æˆªå™¨ä¸­æ‹¦æˆªè¯¥è¯·æ±‚ï¼Œå¹¶ä»è¯·æ±‚å¤´ä¸­è·å–è¯¥tockenè¿›è¡ŒJWTæ ¡éªŒï¼Œæ ¡éªŒå¤±è´¥åˆ™è¿”å›â€œç”¨æˆ·æœªç™»å½•â€çš„ä¿¡æ¯ã€‚æ ¡éªŒæˆåŠŸåˆ™æ”¾è¡Œï¼Œç»§ç»­æ¥ä¸‹æ¥çš„å¤„ç†é€»è¾‘ã€‚ /** * jwtä»¤ç‰Œæ ¡éªŒçš„æ‹¦æˆªå™¨ */ @Component @Slf4j public class JwtTokenAdminInterceptor implements HandlerInterceptor { @Autowired private JwtProperties jwtProperties; /** * æ ¡éªŒjwt * * @param request * @param response * @param handler * @return * @throws Exception */ public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { //åˆ¤æ–­å½“å‰æ‹¦æˆªåˆ°çš„æ˜¯Controllerçš„æ–¹æ³•è¿˜æ˜¯å…¶ä»–èµ„æº if (!(handler instanceof HandlerMethod)) { //å½“å‰æ‹¦æˆªåˆ°çš„ä¸æ˜¯åŠ¨æ€æ–¹æ³•ï¼Œç›´æ¥æ”¾è¡Œ return true; } //1ã€ä»è¯·æ±‚å¤´ä¸­è·å–ä»¤ç‰Œ String token = request.getHeader(jwtProperties.getAdminTokenName()); //2ã€æ ¡éªŒä»¤ç‰Œ try { log.info(&quot;jwtæ ¡éªŒ:{}&quot;, token); Claims claims = JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token); Long empId = Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString()); /////å°†ç”¨æˆ·idå­˜å‚¨åˆ°ThreadLocal//////// BaseContext.setCurrentId(empId); //////////////////////////////////// log.info(&quot;å½“å‰å‘˜å·¥idï¼š&quot;, empId); //3ã€é€šè¿‡ï¼Œæ”¾è¡Œ return true; } catch (Exception ex) { //4ã€ä¸é€šè¿‡ï¼Œå“åº”401çŠ¶æ€ç  response.setStatus(401); return false; } } } sky: jwt: # è®¾ç½®jwtç­¾ååŠ å¯†æ—¶ä½¿ç”¨çš„ç§˜é’¥ admin-secret-key: itcast # è®¾ç½®jwtè¿‡æœŸæ—¶é—´ admin-ttl: 7200000 # è®¾ç½®å‰ç«¯ä¼ é€’è¿‡æ¥çš„ä»¤ç‰Œåç§° admin-token-name: token user-secret-key: itheima user-ttl: 7200000 user-token-name: authentication @Component @ConfigurationProperties(prefix = &quot;sky.jwt&quot;) @Data public class JwtProperties { /** * ç®¡ç†ç«¯å‘˜å·¥ç”Ÿæˆjwtä»¤ç‰Œç›¸å…³é…ç½® */ private String adminSecretKey; private long adminTtl; private String adminTokenName; /** * ç”¨æˆ·ç«¯å¾®ä¿¡ç”¨æˆ·ç”Ÿæˆjwtä»¤ç‰Œç›¸å…³é…ç½® */ private String userSecretKey; private long userTtl; private String userTokenName; } cookieã€sessionã€tokençš„åŒºåˆ«ç”±äºHttpæ˜¯æ— çŠ¶æ€åè®®ï¼Œå› æ­¤å¯¹äºæœåŠ¡å™¨æ¥è¯´ï¼Œå®ƒæ¥æ”¶åˆ°çš„æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨å¹¶ä¸ä¼šå»è®°å½•æ¯ä¸ªè¯·æ±‚ä¹‹é—´çš„è”ç³»ã€‚ä½†æ˜¯å¯¹äºæ›´å¤šçš„ä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦å»è®©æœåŠ¡å™¨è®°å½•æ­¤æ¬¡å‘æ¥çš„è¯·æ±‚æ˜¯å“ªä¸ªå®¢æˆ·ç«¯å‘é€æ¥çš„ï¼Œæ¯”å¦‚ç”¨æˆ·ç™»å½•è¿›æŸä¸ªç½‘ç«™ä¹‹åï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„è¯·æ±‚ï¼Œç”¨æˆ·å°±ä¸éœ€è¦æ¯æ¬¡åœ¨é‡å¤ç™»å½•ï¼Œè¿›è¡Œèº«ä»½éªŒè¯ã€‚è€Œé€šè¿‡cookieã€sessionã€tokenæˆ‘ä»¬å°±èƒ½å¤Ÿè®©æœåŠ¡å™¨ç«¯è¯†åˆ«å‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚ cookieå®ƒæ˜¯å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­çš„ï¼Œå¹¶ä¸”cookieçš„å¤§å°æœ‰é™åˆ¶ï¼Œä¸€èˆ¬ä¸è¶…è¿‡4KBã€‚ç”±äºcookieå­˜å‚¨åœ¨å®¢æˆ·ç«¯çš„ï¼Œå› æ­¤ä¸€èˆ¬è®¤ä¸ºcookieä¸å¤Ÿå®‰å…¨ï¼Œåˆ«äººå¯ä»¥ç›´æ¥å¯¹æœ¬åœ°çš„cookieè¿›è¡Œåˆ†æã€‚å½“æµè§ˆå™¨å‘æœåŠ¡å™¨ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ç«¯é¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦å·²ç»ä¸ºå‘å‡ºè¯¥è¯·æ±‚çš„å®¢æˆ·ç«¯åˆ›å»ºäº†å¯¹åº”çš„sessionï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™åˆ›å»ºsessionï¼Œå¹¶åœ¨å“åº”å¤´ä¸­è®¾ç½®set-cookieï¼Œset-cookieä¸­åŒ…å«äº†ç”Ÿæˆçš„sessionIdã€‚æµè§ˆå™¨æ¥æ”¶åˆ°è¯¥å“åº”åï¼Œæµè§ˆå™¨åœ¨ä¸‹æ¬¡è¯·æ±‚å¤´ä¸­è‡ªåŠ¨æºå¸¦cookieã€‚æœåŠ¡å™¨ç«¯æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åå…ˆéªŒè¯cookieä¿¡æ¯ï¼Œæ¯”å¦‚éªŒè¯cookieä¸­çš„sessionä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™æ­£å¸¸å“åº”ï¼Œä¸å­˜åœ¨åˆ™æ‹¦æˆªè¿”å›é”™è¯¯ä¿¡æ¯ã€‚ sessionå®ƒæ˜¯å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œç”±äºæ˜¯å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œå› æ­¤ä¸€èˆ¬è®¤ä¸ºsessionä¸­å­˜å‚¨çš„æ•°æ®æ˜¯å®‰å…¨çš„ã€‚å½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯å»ºç«‹è¿æ¥åï¼Œå®ƒä¼šåœ¨æœåŠ¡å™¨ç«¯ç”Ÿæˆä¸€ä¸ªå…·æœ‰å”¯ä¸€sessionIdçš„sessionã€‚æˆ‘ä»¬å¯ä»¥æŠŠç”¨æˆ·çš„idä¿¡æ¯å­˜å‚¨åˆ°sessionä¸­ï¼Œå½“ä¸‹æ¬¡å®¢æˆ·ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œé€šè¿‡åˆ¤æ–­è¯¥sessionä¸­æ˜¯å¦å­˜åœ¨ç”¨æˆ·ä¿¡æ¯æ¥åˆ¤æ–­ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ã€‚ä½†æ˜¯sessionä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œç”±äºsessionå®ƒæ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤å½“æœ‰å¾ˆå¤šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å»ºç«‹è¿æ¥æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºå¾ˆå¤šsessionï¼Œè¿™æ ·å°±å ç”¨äº†æœåŠ¡å™¨çš„å†…å­˜èµ„æºã€‚å¦å¤–sessionå®ƒå¹¶ä¸é€‚ç”¨äºåˆ†å¸ƒå¼çš„ç¯å¢ƒï¼Œæ¯”å¦‚å½“æœ‰ä¸¤ä¸ªtomcatæœåŠ¡å™¨æ—¶ï¼Œé‡‡ç”¨è½®è¯¢æ–¹å¼è®¿é—®æœåŠ¡å™¨ï¼Œé‚£ä¹ˆç”¨æˆ·å°±è¦è¿›è¡Œå¤šæ¬¡ç™»å½•ã€‚ tockenæœ¬è´¨ä¸Šæˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹åšä¸€ä¸ªåŠ å¯†åçš„å­—ç¬¦ä¸²ï¼Œå®ƒæ˜¯ç”±æœåŠ¡å™¨ç”Ÿæˆï¼Œç„¶åç›¸åº”ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ¥æ”¶ä¹‹åæŠŠå®ƒå­˜å‚¨åˆ°localstorageç­‰åœ°æ–¹ï¼Œä¹‹åå®¢æˆ·ç«¯æ¯æ¬¡å‘é€è¯·æ±‚éƒ½ä¼šåœ¨è¯·æ±‚å¤´ä¸­æºå¸¦tockenä¿¡æ¯ã€‚tokcen","categories":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/categories/é¡¹ç›®/"}],"tags":[{"name":"JWT","slug":"JWT","permalink":"https://xingxin-99.github.io/tags/JWT/"}],"keywords":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/categories/é¡¹ç›®/"}]},{"title":"æµ‹è¯•","slug":"æµ‹è¯•","date":"2023-08-25T05:52:19.000Z","updated":"2023-08-25T07:15:16.994Z","comments":true,"path":"2023/08/25/æµ‹è¯•/","link":"","permalink":"https://xingxin-99.github.io/2023/08/25/æµ‹è¯•/","excerpt":"","text":"","categories":[{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"https://xingxin-99.github.io/categories/æµ‹è¯•/"}],"tags":[{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"https://xingxin-99.github.io/tags/æµ‹è¯•/"}],"keywords":[{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"https://xingxin-99.github.io/categories/æµ‹è¯•/"}]},{"title":"é¡¹ç›®","slug":"é¡¹ç›®","date":"2023-08-25T05:51:45.000Z","updated":"2023-08-25T07:15:12.645Z","comments":true,"path":"2023/08/25/é¡¹ç›®/","link":"","permalink":"https://xingxin-99.github.io/2023/08/25/é¡¹ç›®/","excerpt":"","text":"","categories":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/categories/é¡¹ç›®/"}],"tags":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/tags/é¡¹ç›®/"}],"keywords":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/categories/é¡¹ç›®/"}]},{"title":"MySQL","slug":"MySQL","date":"2023-08-25T05:50:48.000Z","updated":"2023-08-25T07:15:46.000Z","comments":true,"path":"2023/08/25/MySQL/","link":"","permalink":"https://xingxin-99.github.io/2023/08/25/MySQL/","excerpt":"","text":"","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://xingxin-99.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://xingxin-99.github.io/tags/MySQL/"}],"keywords":[{"name":"MySQL","slug":"MySQL","permalink":"https://xingxin-99.github.io/categories/MySQL/"}]},{"title":"Redis","slug":"Redis","date":"2023-08-25T05:50:30.000Z","updated":"2023-08-25T07:22:28.702Z","comments":true,"path":"2023/08/25/Redis/","link":"","permalink":"https://xingxin-99.github.io/2023/08/25/Redis/","excerpt":"","text":"","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xingxin-99.github.io/categories/æŠ€æœ¯/"}],"tags":[],"keywords":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xingxin-99.github.io/categories/æŠ€æœ¯/"}]},{"title":"Spring","slug":"Spring","date":"2023-08-25T05:49:03.000Z","updated":"2023-08-25T07:15:18.553Z","comments":true,"path":"2023/08/25/Spring/","link":"","permalink":"https://xingxin-99.github.io/2023/08/25/Spring/","excerpt":"","text":"","categories":[{"name":"Spring","slug":"Spring","permalink":"https://xingxin-99.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://xingxin-99.github.io/tags/Spring/"}],"keywords":[{"name":"Spring","slug":"Spring","permalink":"https://xingxin-99.github.io/categories/Spring/"}]},{"title":"ç‚¹è¯„é¡¹ç›®","slug":"ç‚¹è¯„é¡¹ç›®","date":"2023-06-26T09:01:04.000Z","updated":"2023-08-26T10:55:40.952Z","comments":true,"path":"2023/06/26/ç‚¹è¯„é¡¹ç›®/","link":"","permalink":"https://xingxin-99.github.io/2023/06/26/ç‚¹è¯„é¡¹ç›®/","excerpt":"","text":"ä¸€ã€çŸ­ä¿¡ç™»é™†é›†ç¾¤Sessioné—®é¢˜æ¯ä¸ªTomcatæœåŠ¡å™¨éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„Sessionç©ºé—´ï¼Œå¤šä¸ªTomcatæœåŠ¡å™¨ä¸ä¼šå…±äº«Sessionå­˜å‚¨ç©ºé—´ï¼Œå› æ­¤å½“è¯·æ±‚åˆ‡æ¢åˆ°å…¶ä»–çš„TomcatæœåŠ¡å™¨æ—¶ï¼Œç”±äºè¯¥æœåŠ¡å™¨çš„Sessionä¸­å¹¶æ²¡æœ‰ä¿å­˜ç”¨æˆ·ç›¸å…³ä¿¡æ¯ï¼Œå› æ­¤è¯·æ±‚ä¼šè¢«æ‹¦æˆªï¼Œéœ€è¦ç”¨æˆ·é‡æ–°è¿›è¡Œç™»å½•æ ¡éªŒï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒæ„Ÿå˜å·®ã€‚è§£å†³æ–¹æ¡ˆï¼š Sessionæ‹·è´ åœ¨ä¸åŒçš„sessionä¸­å­˜å‚¨ç›¸åŒæ•°æ®ï¼Œæµªè´¹ç©ºé—´ ç»´æŠ¤æ•°æ®åŒæ­¥æµªè´¹èµ„æº æ•°æ®ä¸ä¸€è‡´ æ›¿ä»£Session sessionä¸­å­˜å‚¨çš„æ˜¯ç™»å½•æ ¡éªŒçš„æ•°æ®ï¼Œåœ¨æ¯æ¬¡è¯·æ±‚ä¸­éƒ½ä¼šè¢«è®¿é—®ã€‚è€Œsessionæ˜¯åŸºäºå†…å­˜çš„ï¼Œè¯»å†™æ•ˆç‡é«˜ã€‚å› æ­¤è¦æ±‚æ›¿ä»£å“è¦æ±‚æœ‰è¾ƒé«˜çš„è¯»å†™æ•ˆç‡ï¼ˆåŸºäºå†…å­˜ï¼‰ èƒ½å®ç°æ•°æ®å…±äº«ï¼ˆRedisç‹¬ç«‹äºTomcatä¹‹å¤–ï¼Œä»»ä½•ä¸€ä¸ªtomcatéƒ½èƒ½è®¿é—®åˆ°redisï¼‰ keyã€valueç»“æ„ Redisä¿å­˜æ•°æ®å°†éªŒè¯ç å’Œç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°redisä¸­ã€‚ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°redisä¸­æ—¶ï¼Œè€ƒè™‘åˆ°åç»­æ¯æ¬¡è¯·æ±‚éƒ½ä¼šé€šè¿‡keyï¼Œæ‰¾åˆ°valueï¼›é€šè¿‡åˆ¤æ–­valueæ˜¯å¦å­˜æ¥è¿›è¡Œç™»å½•æ ¡éªŒã€‚å› æ­¤éœ€è¦è®¾è®¡åˆé€‚çš„keyã€‚ key value phone:13507690339 9874 tocken: {name:;} ç‰¹æ®Šæƒ…å†µï¼šåœ¨æ‹¦æˆªå™¨ä¸­åªæ‹¦æˆªäº†å¿…é¡»ç™»å½•æ‰æœ‰æƒé™çœ‹åˆ°çš„é¡µé¢ï¼Œå¯¹äºé¦–é¡µç­‰è¿™ç§æ— éœ€ç™»å½•çš„é¡µé¢å¹¶æ²¡æœ‰æ‹¦æˆªã€‚å¦‚æœç”¨æˆ·ä¸€ç›´åœ¨è¿™ç§é¡µé¢ä¸­ï¼Œé‚£ä¹ˆtokcençš„æœ‰æ•ˆæœŸå°±ä¸ä¼šåˆ·æ–°ï¼Œå› æ­¤tockenåˆ°æ—¶é—´ä¹‹åä¼šå¤±æ•ˆã€‚éœ€æ±‚ï¼šåªè¦ç”¨æˆ·åœ¨æµè§ˆé¡µé¢ï¼Œå°±è®©tockenåˆ·æ–°ã€‚å› æ­¤è®¾ç½®ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨æ‹¦æˆªæ‰€æœ‰é¡µé¢ï¼Œç”¨äºåˆ·æ–°tockenï¼›ç¬¬äºŒä¸ªæ‹¦æˆªå™¨è¿›è¡Œèº«ä»½æ ¡éªŒã€‚ä¼˜åŒ–ï¼šä½¿ç”¨JWTæ¥è¿›è¡Œç™»å½•æ ¡éªŒã€‚è¿™æ ·å°±ä¸éœ€è¦å†å°†ç”¨æˆ·çš„ä¿¡æ¯ä¿å­˜åˆ°redisä¸­ï¼Œè€Œæ˜¯å¯ä»¥åœ¨tockenä¸­è·å–ç”¨æˆ·ä¿¡æ¯ã€‚ äºŒã€ç¼“å­˜ç¼“å­˜ï¼šæ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼Œä¸´æ—¶å­˜å‚¨æ•°æ®çš„åœ°æ–¹ï¼Œè¯»å†™æ€§èƒ½æ¯”è¾ƒé«˜å®é™…å¼€å‘ä¸­,ä¼šæ„ç­‘å¤šçº§ç¼“å­˜æ¥ä½¿ç³»ç»Ÿè¿è¡Œé€Ÿåº¦è¿›ä¸€æ­¥æå‡,ä¾‹å¦‚:æœ¬åœ°ç¼“å­˜ä¸redisä¸­çš„ç¼“å­˜å¹¶å‘ä½¿ç”¨æµè§ˆå™¨ç¼“å­˜ï¼šä¸»è¦æ˜¯å­˜åœ¨äºæµè§ˆå™¨ç«¯çš„ç¼“å­˜åº”ç”¨å±‚ç¼“å­˜ï¼šå¯ä»¥åˆ†ä¸ºtomcatæœ¬åœ°ç¼“å­˜ï¼Œæ¯”å¦‚ä¹‹å‰æåˆ°çš„mapï¼Œæˆ–è€…æ˜¯ä½¿ç”¨redisä½œä¸ºç¼“å­˜æ•°æ®åº“ç¼“å­˜ï¼šåœ¨æ•°æ®åº“ä¸­æœ‰ä¸€ç‰‡ç©ºé—´æ˜¯ buffer poolï¼Œå¢æ”¹æŸ¥æ•°æ®éƒ½ä¼šå…ˆåŠ è½½åˆ°mysqlçš„ç¼“å­˜ä¸­CPUç¼“å­˜ï¼šå½“ä»£è®¡ç®—æœºæœ€å¤§çš„é—®é¢˜æ˜¯ cpuæ€§èƒ½æå‡äº†ï¼Œä½†å†…å­˜è¯»å†™é€Ÿåº¦æ²¡æœ‰è·Ÿä¸Šï¼Œæ‰€ä»¥ä¸ºäº†é€‚åº”å½“ä¸‹çš„æƒ…å†µï¼Œå¢åŠ äº†cpuçš„L1ï¼ŒL2ï¼ŒL3çº§çš„ç¼“å­˜ ç¼“å­˜æ›´æ–° å·²ç»å­˜å‚¨åˆ°redisä¸­çš„æ•°æ®ï¼Œä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘æ›´æ–°æ“ä½œï¼Ÿ å†…å­˜æ·˜æ±° å½“Redisçš„å†…å­˜æ»¡äº†ä¹‹åï¼Œè§¦å‘å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œè‡ªåŠ¨æ·˜æ±°æ‰Redisä¸­çš„ä¸€éƒ¨åˆ†æ•°æ® è¶…æ—¶å‰”é™¤ å½“å‘Redisä¸­å­˜å‚¨æ•°æ®æ—¶ï¼Œè®¾ç½®æ•°æ®çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ°æœŸè‡ªåŠ¨åˆ é™¤ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶å‘ç°ç¼“å­˜ä¸å­˜åœ¨ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢ï¼Œå†å†™å…¥åˆ°ç¼“å­˜ä¸­ã€‚ä¸è¶³ï¼šè‹¥æ•°æ®åœ¨æœ‰æ•ˆæœŸå†…è¿›è¡Œäº†ä¿®æ”¹ï¼Œä»Redisä¸­è·å–çš„ä»ç„¶æ˜¯æ—§æ•°æ® ä¸»åŠ¨æ›´æ–° ç”±ç¨‹åºå‘˜ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œå½“ä¿®æ”¹æ•°æ®åº“æ—¶ï¼ŒåŒæ—¶æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®ã€‚ ä¸»åŠ¨æ›´æ–°ç­–ç•¥ Cache Aside Pattern ç¼“å­˜ç©¿é€ é¡¹ç›®ä¸­å¯¹å•†é“ºä¿¡æ¯è¿›è¡Œäº†ç¼“å­˜ï¼Œå¦‚æœåœ¨æŸä¸€æ—¶åˆ»æœ‰å¤§é‡è¯·æ±‚å»æŸ¥è¯¢äº†ä¸å­˜åœ¨çš„å•†é“ºï¼Œé€ æˆç¼“å­˜ç©¿é€ç°è±¡ï¼Œè¯¥æ€ä¹ˆè§£å†³ï¼Ÿ ç¼“å­˜ç©ºå¯¹è±¡å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œåˆ¤æ–­å•†é“ºä¿¡æ¯æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œè¿˜éœ€åˆ¤æ–­å•†é“ºå¯¹åº”çš„Keyç¼“å­˜çš„Valueæ˜¯å¦æ˜¯ç©ºå¯¹è±¡(â€œâ€)ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è¿”å›åº—é“ºä¸å­˜åœ¨çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœä¸æ˜¯ç©ºå¯¹è±¡çš„è¯ï¼Œåˆ™è¯´æ˜æ•°æ®åº“ä¸­æœ‰è¯¥å•†é“ºä¿¡æ¯çš„æ•°æ®ã€‚åˆ™åˆ°æ•°æ®åº“ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶å­˜å…¥åˆ°redisä¸­ã€‚ å¸ƒéš†è¿‡æ»¤å™¨å¢åŠ IDå¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹IDè§„å¾‹é˜²æ­¢è¢«çŒœåˆ°ä¸å­˜åœ¨æ•°æ®åº“ä¸­çš„IDï¼Œè€Œè¢«æ¶æ„çš„å‘è¿™äº›IDå‘èµ·å¤§é‡æŸ¥è¯¢è¯·æ±‚ å¯¹IDè¿›è¡Œæ ¼å¼æ ¡éªŒå…ˆå¯¹IDè¿›è¡Œæ ¡éªŒï¼ŒæŠŠä¸ç¬¦åˆæ ¼å¼çš„IDçš„è¯·æ±‚è¿‡æ»¤æ‰ å¯¹çƒ­ç‚¹å‚æ•°åšé™æµç¼“å­˜é›ªå´©è§£å†³æ–¹æ¡ˆ ä¸ºä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼ï¼ˆå¦‚æœæ˜¯åšäº†ç¼“å­˜é¢„çƒ­ï¼Œæ‰¹é‡å°†ä¸€æ‰¹keyæ·»åŠ è‡³ç¼“å­˜ï¼Œå¹¶è®¾ç½®TTLï¼Œé‚£ä¹ˆä¸ºäº†ä¸è®©è¿™æ‰¹keyåŒä¸€æ—¶é—´è¿‡æœŸè€Œå¯¼è‡´ç¼“å­˜è¡€å´©çš„é—®é¢˜ï¼Œå°†keyè®¾ç½®30min+äº§ç”Ÿçš„ä¸€ä¸ªéšæœºæ•°ï¼Œè®©TTLéšæœºï¼‰ åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§ï¼ˆè§£å†³å®•æœºå¯¼è‡´Redisé›ªå´©çš„æ€è·¯ï¼‰ ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµçš„ç­–ç•¥ï¼ˆæ¯”å¦‚å½“Redisçš„æ•´ä¸ªé›†ç¾¤éƒ½å®•æœºæ—¶ï¼Œæ·»åŠ å¿«é€Ÿå¤±è´¥ã€æ‹’ç»æœåŠ¡ç­‰ç­–ç•¥ï¼‰ ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜ï¼ˆå¤šä¸ªå±‚é¢å»ºç«‹ç¼“å­˜ï¼Œä¸€ä¸ªç¼“å­˜å´©æ‰äº†ï¼Œè¿˜æœ‰å…¶ä»–çš„ç¼“å­˜èµ·ä¸€ä¸ªç¼“å†²ä½œç”¨ï¼Œæµè§ˆå™¨æœ¬åœ°-&gt;Nginx-&gt;Redis-&gt;JVM-&gt;æ•°æ®åº“ï¼Œåƒäº¬ä¸œä¸ºå•†å“è¯¦æƒ…å°±åšäº†å¤šçº§ç¼“å­˜ï¼Œä»è€Œåº”å¯¹äº¿çº§ä»¥ä¸Šçš„å¹¶å‘ï¼‰ ç¼“å­˜å‡»ç©¿ç¼“å­˜å‡»ç©¿é—®é¢˜ä¹Ÿå«çƒ­ç‚¹Keyé—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®ï¼ˆæ¯”å¦‚ç§’æ€å•†å“ï¼‰å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚ï¼ˆæ¯”å¦‚è¿™ä¸ªæ•°æ®éœ€è¦å¤šè¡¨å…³è”è¿ç®—ï¼ŒæŸ¥å–æ¯”è¾ƒè€—æ—¶ï¼‰çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚è§£å†³æ–¹æ¡ˆï¼š äº’æ–¥é”ï¼ˆä¸€è‡´æ€§ï¼‰ä¼˜ç‚¹ï¼šæ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼ˆæ²¡æœ‰æ·»åŠ expireå­—æ®µï¼‰ ä¿è¯äº†å¼ºä¸€è‡´æ€§ å®ç°ç®€å•ç¼ºç‚¹ï¼šæ€§èƒ½è¾ƒä½ï¼ˆå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œç¼“å­˜é‡å»ºæ—¶ï¼Œå…¶ä»–æƒ³è¦è¯»å–è¯¥æ•°æ®çš„çº¿ç¨‹éƒ½ä¼šå¤„äºç­‰å¾…çŠ¶æ€ï¼‰ æœ‰æ­»é”é£é™© é€»è¾‘è¿‡æœŸï¼ˆå¯ç”¨æ€§ï¼‰ï¼ˆä¸€èˆ¬æ˜¯ä¸ºçƒ­ç‚¹Keyè®¾ç½®é€»è¾‘è¿‡æœŸï¼Œæ¯”å¦‚æŸä¸€ç§’æ€å•†å“è¯¦æƒ…ä¿¡æ¯ï¼Œå½“ç§’æ€å•†å“ä¸‹æ¶æ—¶ï¼Œå†æŠŠè¯¥keyä»Redisä¸­ç§»é™¤ã€‚ï¼‰ä¼˜ç‚¹ï¼šæ€§èƒ½è¾ƒå¥½ï¼Œçº¿ç¨‹æ— é¡»ç­‰å¾…ç¼ºç‚¹ï¼šä¸ä¿è¯ä¸€è‡´æ€§ æœ‰é¢å¤–å†…å­˜æ¶ˆè€—ï¼ˆæ·»åŠ äº†expireå­—æ®µï¼‰ å®ç°å¤æ‚åœ¨å‘Redisä¸­æ·»åŠ æ•°æ®æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªé€»è¾‘è¿‡æœŸå­—æ®µexpireï¼Œå€¼ä¸ºå­˜å…¥çš„ç³»ç»Ÿå½“å‰æ—¶é—´+æœ‰æ•ˆæœŸæµç¨‹ï¼šçº¿ç¨‹1æŸ¥è¯¢Redisï¼Œå‘ç°æ•°æ®è¿‡æœŸï¼Œåˆ™è·å–äº’æ–¥é”ï¼ŒåŒæ—¶å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹å»è¯»å–æ•°æ®åº“çš„æ•°æ®ï¼Œé‡å»ºç¼“å­˜ã€‚çº¿ç¨‹1ä»ç„¶è¯»å–æ—§æ•°æ®ï¼Œå¹¶ç¼“å­˜ã€‚æ­¤æ—¶å…¶ä»–çº¿ç¨‹ä»Redisä¸­æŸ¥è¯¢æ•°æ®ï¼Œå‘ç°é€»è¾‘è¿‡æœŸï¼Œå°è¯•è·å–äº’æ–¥é”æ¥é‡å»ºç¼“å­˜ã€‚ä½†è·å–äº’æ–¥é”å¤±è´¥ï¼Œåˆ™è¿”å›è¿‡æœŸæ•°æ®ã€‚ äº’æ–¥é”å®ç°ç”±äºRedisä¸­è®¾ç½®Keyæ—¶ï¼Œæœ‰ä¸€ä¸ªå‘½ä»¤SETNXï¼Œå®ƒåªæœ‰keyä¸å­˜åœ¨æ—¶ï¼Œæ‰ä¼šè®¾ç½®å€¼ï¼ŒåŒæ—¶è¿”å›ç»“æœ1ã€‚å¦‚æœkeyä¸å­˜åœ¨ï¼Œåˆ™è¿”å›0ã€‚å› æ­¤å¯ä»¥é€šè¿‡å®ƒæ¥å®ç°äº’æ–¥é”ï¼Œå¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è·å–äº’æ–¥é”ï¼Œåˆ™æ ¹æ®SETNXæ¥ä¸ºæŸä¸€ä¸ªkeyè®¾ç½®å€¼ï¼ŒåŒæ—¶è¿”å›trueï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹åˆ™çŸ¥é“è·å–é”æˆåŠŸã€‚å…¶ä»–çš„çº¿ç¨‹æƒ³è¦è·å–è¯¥äº’æ–¥é”æ—¶ï¼Œå‘ç°SETNXè¿”å›çš„ç»“æœä¸º0ï¼Œåˆ™çŸ¥é“å·²ç»æœ‰çº¿ç¨‹è·å–äº†è¯¥é”ã€‚å½“æŒæœ‰äº’æ–¥é”çš„çº¿ç¨‹è¿›è¡Œç¼“å­˜é‡å»ºåï¼Œè¦é‡Šæ”¾äº’æ–¥é”ï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹å°†ä¼šä¸€ç›´å¤„äºé‡è¯•ç­‰å¾…çŠ¶æ€ã€‚å¦å¤–ï¼Œè€ƒè™‘åˆ°å¦‚æœé‡Šæ”¾äº’æ–¥é”æ‰§è¡Œå¤±è´¥ï¼Œå¯¼è‡´é”æ²¡æœ‰é‡Šæ”¾æ‰ï¼Œå…¶ä»–çº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œå› æ­¤å¯ä»¥åœ¨SETNXæ—¶ï¼Œä¸ºäº’æ–¥é”çš„keyæ·»åŠ è¿‡æœŸæ—¶é—´ã€‚æ¯”å¦‚ç¼“å­˜é‡å»ºä¸šåŠ¡çš„æ—¶é—´å¯èƒ½ä¸º100msï¼Œåˆ™è®¾ç½®äº’æ–¥é”çš„è¿‡æœŸæ—¶é—´ä¸ºå®ƒçš„10å€å·¦å³ï¼Œè®¾ç½®ä¸º1000msã€‚ // è·å–é” private boolean tryLock(String key) { Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(key, &quot;1&quot;, 10, TimeUnit.SECONDS); return BooleanUtil.isTrue(flag); } // é‡Šæ”¾é” private void unlock(String key) { stringRedisTemplate.delete(key); } public Shop queryShopByIdSolvePenetrateWithWriteMutex(Long id) { String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id); //å¦‚æœredisæœªå‘½ä¸­æŸ¥æ•°æ®åº“ if (StrUtil.isNullOrUndefined(shopJson)){ //åœ¨æŸ¥æ•°æ®åº“ä¹‹å‰å…ˆè·å–é” String lockKey=LOCK_SHOP_KEY+id; try { boolean isLock = tryLock(lockKey); if (!isLock){ //å¦‚æœè·å–é”å¤±è´¥äº†ä¼‘çœ ä¸€æ®µæ—¶é—´åé‡è¯• Thread.sleep(50); return queryShopByIdSolvePenetrateWithWriteMutex(id); } //ä»¥ä¸‹ä¸ºè·å¾—é”æˆåŠŸ Shop shop = shopService.getById(id); //æ•°æ®åº“ä¹Ÿä¸å­˜åˆ™å†™å…¥ç©ºæ•°æ®åˆ°Redis if (shop==null){ // stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id,&quot;&quot;,CACHE_NULL_TTL,TimeUnit.MINUTES); queryShopByIdSolveBreakWithWriteNull(id); } //æ•°æ®åº“å­˜åœ¨åˆ™å°†æ•°æ®å†™è¿›redis shopJson = JSONUtil.toJsonStr(shop); stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY+id,shopJson,CACHE_SHOP_TTL,TimeUnit.MINUTES); //å†™è¿›ç¼“å­˜åå†é‡Šæ”¾é” } catch (InterruptedException e) { e.printStackTrace(); } finally { unlock(lockKey); } //é‡æ–°æŸ¥ä¸€éï¼Œå°±å¯ä»¥ä»redisè·å¾—æ•°æ® return queryShopByIdSolveBreakWithWriteNull(id); } //å¦‚æœå‘½ä¸­äº†redis,ä½†æ˜¯ä¸ºç©º,ç›´æ¥è¿”å›ç©ºå¯¹è±¡ if (StrUtil.isBlank(shopJson)){ return null; } //å¦‚æœå‘½ä¸­äº†redisä¸”ä¸ä¸ºç©º,é‡ç½®æ—¶é—´ stringRedisTemplate.expire(CACHE_SHOP_KEY+id,CACHE_SHOP_TTL,TimeUnit.MINUTES); Shop shop = JSONUtil.toBean(shopJson, Shop.class); return shop; } é€»è¾‘è¿‡æœŸå®ç° é€»è¾‘è¿‡æœŸå­—æ®µæ€ä¹ˆæ·»åŠ ï¼Ÿ ç›´æ¥åœ¨å®ä½“ç±»ä¸­æ·»åŠ é€»è¾‘è¿‡æœŸå­—æ®µï¼ˆè¿èƒŒå¼€é—­åŸåˆ™ï¼‰ è®¾è®¡ä¸€ä¸ªæ–°çš„ç±»ï¼Œç±»é‡Œæœ‰é€»è¾‘è¿‡æœŸå­—æ®µï¼Œè®©å®ä½“ç±»ç»§æ‰¿è¯¥ç±»ï¼ˆä»ç„¶è¿èƒŒå¼€é—­åŸåˆ™ï¼‰ è®¾è®¡ä¸€ä¸ªæ–°çš„ç±»ï¼Œç±»é‡Œæœ‰é€»è¾‘è¿‡æœŸä»¥åŠå®ä½“ç±»ä¸¤ä¸ªå±æ€§ï¼ˆé‡‡ç”¨ï¼‰ @Data public class RedisData { private LocalDateTime expireTime; private Object data; } é€»è¾‘è¿‡æœŸä»£ç å¦‚ä½•å®ç°ï¼Ÿ ç”±äºéœ€è¦å¼€å¯ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹å»æ‰§è¡Œç¼“å­˜é‡å»ºï¼Œå› æ­¤åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼ˆçº¿ç¨‹çš„åˆ›å»ºå’Œé”€é­‚ä¸ç”¨æˆ‘ä»¬å…³å¿ƒï¼‰ï¼Œå¹¶åœ¨çº¿ç¨‹æ± é‡Œå»æäº¤ç¼“å†²é‡å»ºçš„ä»»åŠ¡ã€‚ //åˆ›å»ºä¸€ä¸ªå›ºå®šçº¿ç¨‹æ±  private static final ExecutorService CACHE_REBUILD_EXECUTOR = Executors.newFixedThreadPool(10); /** * ç”¨é€»è¾‘è¿‡æœŸæ—¶é—´è§£å†³ç¼“å­˜ç©¿é€ * @param id * @return */ public Shop queryShopByIdSolvePenetrateWithWriteLogicalExpireTime(Long id) { String redisDataJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id); //å¦‚æœredisæœªå‘½ä¸­æŸ¥æ•°æ®åº“ if (StrUtil.isEmpty(redisDataJson)){ //æœªå‘½ä¸­è¯´æ˜ä¸æ˜¯çƒ­ç‚¹æ•°æ®ï¼ˆä¼šæŠŠçƒ­ç‚¹æ•°æ®è¿›è¡Œç¼“å­˜é¢„çƒ­ï¼Œå­˜å…¥åˆ°Redisä¸­ï¼‰ï¼Œè½¬å…¥å¤„ç†ç¼“å­˜å‡»ç©¿çš„å‡½æ•° return null; } //å¦‚æœå‘½ä¸­äº†redisä¸”ä¸ä¸ºç©ºï¼Œå°†å…¶ååºåˆ—åŒ–æˆå¯¹è±¡ï¼Œæ‹¿åˆ°é€»è¾‘è¿‡æœŸæ—¶é—´ RedisData redisData = JSONUtil.toBean(redisDataJson, RedisData.class); Shop shop = JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class); LocalDateTime expireTime = redisData.getExpireTime(); //å¦‚æœæ—¶é—´å·²ç»è¿‡æœŸï¼Œç›´æ¥è¿”å›æ—§æ•°æ®å¹¶å¼€å¯æ–°çº¿ç¨‹ä¿®æ”¹æ•°æ® if (expireTime.isBefore(LocalDateTime.now())){ //åœ¨å¼€å¯æ–°çº¿ç¨‹ä¹‹å‰è·å¾—é”ï¼Œé”çš„åç§°è¦ä¸é”çš„idå…³è”ï¼Œä¿®æ”¹ä¸åŒçš„idå¯ä»¥å¹¶è¡Œï¼Œä¸€æ ·çš„idæ‰éœ€è¦åŠ é” String lockKey=LOCK_SHOP_KEY+id; try { boolean isLock = tryLock(lockKey); //è·å–é”æˆåŠŸ if (isLock){ //å¼€å¯æ–°çº¿ç¨‹ç”¨çº¿ç¨‹æ± ï¼Œæ€§èƒ½æ¯”è‡ªå·±åˆ›å»ºçº¿ç¨‹å¥½ CACHE_REBUILD_EXECUTOR.execute(()-&gt;{ //é‡å»ºç¼“å­˜ saveShopWithExpireTimeToRedis(id,30L); }); } } catch (Exception e) { e.printStackTrace(); } finally { unlock(lockKey); } } return shop; } ä¸‰ã€ç§’æ€é—®é¢˜ä¼˜æƒ åˆ¸å­—æ®µç»“æ„ å…¨å±€å”¯ä¸€ID å¦‚æœè®¢å•IDä¸ºè‡ªå¢å‹ï¼Œä¼šå­˜åœ¨ä»€ä¹ˆæ ·çš„é—®é¢˜ï¼Ÿï¼ˆè®¢å•ç‰¹ç‚¹ï¼šæ•°æ®é‡å¤§ã€å”¯ä¸€ï¼‰ IDè§„å¾‹å¤ªæ˜æ˜¾ã€‚ç”±äºè®¢å•IDä¼šæš´éœ²ç»™ç”¨æˆ·ï¼Œå› æ­¤ç”¨æˆ·å¯ä»¥ä»IDæ¨æµ‹å‡ºä¸€äº›ä¿¡æ¯ã€‚ï¼ˆæ¯”å¦‚ï¼Œä»Šå¤©æŸä¸€ç”¨æˆ·ä¸‹è®¢å•æ—¶ï¼Œè®¢å•IDä¸º100ï¼›åˆ°ç¬¬äºŒå¤©ï¼Œä¸‹è®¢å•æ—¶è®¢å•IDä¸º200ï¼Œå› æ­¤å¦‚æœæ˜¯è‡ªå¢çš„è¯ï¼Œç”¨æˆ·å°±èƒ½æ¨æµ‹åˆ°åœ¨æ­¤æœŸé—´å–æ‰äº†100å•ã€‚ï¼‰ å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶ï¼ˆå¦‚æœé‡‡å–è‡ªå¢ï¼Œåˆ™ä¹‹åå¯¹è¡¨åšæ‹†åˆ†ï¼Œä¼šå‡ºç°è®¢å•é‡å¤ï¼‰ å…¨å±€å”¯ä¸€IDç”Ÿæˆç­–ç•¥æœ‰å“ªäº› UUIDï¼ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œæ— å•è°ƒé€’å¢çš„ç‰¹æ€§ï¼‰ Redisè‡ªå¢ snowflakeç®—æ³•ï¼ˆé‡‡ç”¨longç±»å‹64ä½æ•°å­—ï¼Œå’Œä¸‹é¢é‡‡ç”¨çš„Redisç”ŸæˆIDç­–ç•¥å¾ˆç›¸ä¼¼ï¼‰è‡ªå¢é‡‡ç”¨çš„å½“å‰æœºå™¨çš„è‡ªå¢ï¼Œè€ŒRedisæ˜¯ä¸ç®¡ç”¨çš„ä»»ä½•åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œéƒ½æ˜¯ç”¨çš„Redisä½œä¸ºè‡ªå¢ã€‚ æ•°æ®åº“è‡ªå¢ å…¨å±€IDç”Ÿæˆå™¨ï¼ˆæŠŠRedisä½œä¸ºå…¨å±€IDç”Ÿæˆå™¨ï¼‰ç”±äºRedisæ˜¯å…¨å±€çš„ï¼Œç‹¬ç«‹äºMysqlä¹‹å¤–çš„ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨Redisä¸­çš„è‡ªå¢æ•°å€¼æ¥å®ç°ç”Ÿæˆå…¨å±€å”¯ä¸€IDç‰¹ç‚¹ï¼š å”¯ä¸€æ€§ é«˜å¯ç”¨ï¼ˆæ‰¾è¯¥ç”Ÿæˆå™¨ç”ŸæˆIDæ—¶ï¼Œè¿™ä¸ªç”Ÿæˆå™¨ä¸èƒ½å®•æœºï¼‰ é«˜æ€§èƒ½ï¼ˆç”ŸæˆIDé€Ÿåº¦å¿«ï¼‰ é€’å¢æ€§ï¼ˆé€’å¢çš„è¯ï¼Œæ–¹ä¾¿å»ºç«‹å’Œç»´æŠ¤ç´¢å¼•ï¼‰ å®‰å…¨æ€§ï¼ˆä¸èƒ½è¢«ç”¨æˆ·çŒœæµ‹åˆ°IDè§„å¾‹ï¼‰ IDé‡‡ç”¨æ•°å€¼ç±»å‹ï¼ˆlongå‹8ä¸ªå­—èŠ‚ï¼‰ï¼Œæ•°å€¼ç±»å‹åœ¨æ•°æ®åº“ä¸­å ç”¨ç©ºé—´æ›´å°ä¸”å»ºç«‹ç´¢å¼•æ›´æ–¹ä¾¿å¦‚æœæ—¶é—´æˆ³ç›¸åŒï¼Œå¯ä»¥é€šè¿‡åºåˆ—å·æ¥ç”Ÿæˆä¸åŒID ä»£ç å®ç° ç”Ÿæˆçš„åºåˆ—å·ä¸ºä»€ä¹ˆè¿˜è¦æ‹¼æ¥ä¸Šæ—¶é—´ï¼Ÿ Reidsçš„è‡ªå¢æ•°å€¼ä¸Šé™2^64ï¼Œå¦‚æœå¯¹äºä¸€ä¸ªä¸šåŠ¡ï¼Œå…¨éƒ½æŒ‰ç…§ç›¸åŒçš„keyé€’å¢ï¼Œé‚£ä¹ˆç»è¿‡å‡ å¹´ä¹‹åå¯èƒ½å°±ä¼šå‡ºç°æ•°å€¼è¶…å‡ºçš„å¼‚å¸¸ã€‚è§£å†³ï¼ˆä¸€å¤©ä¸€ä¸ªkeyï¼‰ï¼šä»¥å¤©ä¸ºå•ä½ï¼Œæ‹¼ä¸Šæ—¶é—´ï¼Œæ¯ä¸€å¤©éƒ½æœ‰ä¸åŒçš„keyï¼Œè®©å…¶é‡æ–°é€’å¢ã€‚å¦å¤–è¿™ç§æ–¹å¼è¿˜å¯ä»¥èµ·åˆ°ä¸€ä¸ªç»Ÿè®¡çš„æ•ˆæœã€‚ long count = stringRedisTemplate.opsForValue().increment(&quot;icr:&quot; + keyPrefix); //å¹¶æ²¡æœ‰é‡‡å–è¿™ç§æ–¹æ¡ˆ // 2.ç”Ÿæˆåºåˆ—å· // 2.1.è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤© String date = now.format(DateTimeFormatter.ofPattern(&quot;yyyy:MM:dd&quot;)); // 2.2.è‡ªå¢é•¿ long count = stringRedisTemplate.opsForValue().increment(&quot;icr:&quot; + keyPrefix + &quot;:&quot; + date); å¦‚ä½•å°†æ—¶é—´æˆ³å’Œåºåˆ—å·è¿›è¡Œæ‹¼æ¥ï¼Ÿ ç”±äºè¿”å›çš„ä¸ºlongå‹ï¼Œå› æ­¤ä¸èƒ½åˆ©ç”¨Stringè¿›è¡Œç®€å•çš„æ‹¼æ¥ã€‚è®©æ—¶é—´æˆ³åœ¨é«˜ä½è€Œåºåˆ—å·åœ¨ä½ä½çš„è¯ï¼Œå¯ä»¥é€šè¿‡ä½è¿ç®—è®©æ—¶é—´æˆ³ç§»åŠ¨åˆ°é«˜ä½ï¼Œå†é€šè¿‡æˆ–è¿ç®—è®©åºåˆ—å·å¡«å……åœ¨ä½ä½ã€‚ timestamp &lt;&lt; COUNT_BITS | count æ•´ä½“ä»£ç å®ç°ï¼š public class RedisIdWorker { /** * å¼€å§‹æ—¶é—´æˆ³ï¼šä»¥2020å¹´0ç‚¹0åˆ†ä¸ºèµ·ç‚¹ */ private static final long BEGIN_TIMESTAMP = 1640995200L; /** * åºåˆ—å·çš„ä½æ•° */ private static final int COUNT_BITS = 32; private StringRedisTemplate stringRedisTemplate; public RedisIdWorker(StringRedisTemplate stringRedisTemplate) { this.stringRedisTemplate = stringRedisTemplate; } // keyPrefix:å¯ä»¥çœ‹åšæ˜¯ä¸šåŠ¡å‰ç¼€ï¼Œæ¯”å¦‚è®¢å•ä¸šåŠ¡ï¼Œåº—é“ºä¸šåŠ¡ç­‰ public long nextId(String keyPrefix) { // 1.ç”Ÿæˆæ—¶é—´æˆ³ LocalDateTime now = LocalDateTime.now(); long nowSecond = now.toEpochSecond(ZoneOffset.UTC); long timestamp = nowSecond - BEGIN_TIMESTAMP; // 2.ç”Ÿæˆåºåˆ—å· // 2.1.è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤© String date = now.format(DateTimeFormatter.ofPattern(&quot;yyyy:MM:dd&quot;)); // 2.2.è‡ªå¢é•¿ long count = stringRedisTemplate.opsForValue().increment(&quot;icr:&quot; + keyPrefix + &quot;:&quot; + date); // 3.æ‹¼æ¥å¹¶è¿”å› return timestamp &lt;&lt; COUNT_BITS | count; } } å®ç°ä¼˜æƒ ç§’æ€ä¸‹å•å¹³ä»·åŠµç‰¹ä»·åŠµï¼ˆåŠµä¿¡æ¯çš„è¡¥å……ï¼‰è®¢å•æ¥å£ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å• åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å• è¶…å–é—®é¢˜ å¦‚æœä½¿ç”¨ä¹è§‚é”ï¼Œæ¯æ¬¡åªèƒ½ä»¥æ•°æ®æ˜¯å¦å˜æ›´ä¸ºä¾æ®ï¼Œé‚£è¯¥æ€ä¹ˆä¼˜åŒ–ï¼Ÿ åˆ†æ®µé”ã€‚å°†åº“å­˜åˆ†åˆ°å¤šå¼ è¡¨é‡Œï¼Œæ¯æ¬¡é”ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼ˆç±»ä¼¼jdk1.7ä¸­çš„ConcurrentHashMapåˆ†æ®µé”çš„æ€æƒ³ï¼‰ ä¹è§‚é”ç‰ˆæœ¬å·æ³•CASæ³•ï¼ˆé€šè¿‡åº“å­˜æ•°æ®æœ¬èº«æœ‰æ²¡æœ‰å˜åŒ–æ¥åˆ¤æ–­èƒ½ä¸èƒ½è¿›è¡Œå‡åº“å­˜æ“ä½œï¼‰ //è·å–åº“å­˜ int stock = seckillVoucherService.getStockById(Id); // 6.æ‰£å‡åº“å­˜ boolean success = seckillVoucherService.update() .setSql(&quot;stock = stock - 1&quot;) // set stock = stock - 1 .eq(&quot;voucher_id&quot;, voucherId).eq(&quot;stock&quot;, stock) // where id = ? and stock &gt; 0 .update(); å¹¶å‘æµ‹è¯•ï¼ˆåœ¨è¿›è¡ŒCASä¼˜åŒ–è¶…å–é—®é¢˜åï¼Œè¿›è¡Œå¹¶å‘æµ‹è¯•ï¼Œå¼‚å¸¸æ¯”ä¾‹å¤§å¤§å¢åŠ ï¼‰æ¨¡æ‹Ÿ200ä¸ªå¹¶å‘è¯·æ±‚å¼‚å¸¸å€¼é«˜è¾¾90%åœ¨æœ€å¼€å§‹çš„è¯·æ±‚ä¸­å°±å‡ºç°åº“å­˜ä¸è¶³çš„é”™è¯¯ä¿¡æ¯åº“å­˜å–å‡º21ä»¶ç”Ÿæˆ21æ¡è®¢å•æ•°æ®ï¼ˆæ²¡æœ‰å‡ºç°è¶…å–é—®é¢˜ï¼‰åˆ†æé—®é¢˜åŸå› ï¼ˆè®¤ä¸ºåªè¦æœ‰çº¿ç¨‹æ›´æ”¹ï¼Œå°±ä¼šäº§ç”Ÿå¹¶å‘å®‰å…¨é—®é¢˜ï¼‰ï¼šåœ¨åº“å­˜æ•°é‡å……è¶³çš„æƒ…å†µä¸‹ï¼ŒåŒä¸€æ—¶é—´ä»ç„¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¯¹åº“å­˜æ›´æ–°æˆåŠŸï¼Œå…¶ä»–çº¿ç¨‹ç”±äºæŸ¥è¯¢åº“å­˜æ•°é‡å˜åŒ–ï¼Œå‡å¯¼è‡´æ›´æ–°å¤±è´¥ï¼ŒæˆåŠŸç‡è¿‡ä½ã€‚ä¼˜åŒ–ï¼š // 6.æ‰£å‡åº“å­˜ boolean success = seckillVoucherService.update() .setSql(&quot;stock = stock - 1&quot;) // set stock = stock - 1 .eq(&quot;voucher_id&quot;, voucherId).gt(&quot;stock&quot;, 0) // where id = ? and stock &gt; 0 .update(); å¹¶å‘æµ‹è¯•200ä¸ªå¹¶å‘è¯·æ±‚ï¼Œ100ä¸ªçº¿ç¨‹ä¸‹å•æˆåŠŸï¼Œå¼‚å¸¸50%ï¼Œç¬¦åˆé¢„æœŸæ•°æ®åº“ä¸­ä¼˜æƒ åˆ¸åº“å­˜ä¸º0æ•°æ®åº“ä¸­è®¢å•æ•°é‡ä¸º100 ä¸€äººä¸€å• å®ç°æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ å½“ç”¨æˆ·ä¸‹å•æ—¶ï¼Œå…ˆæ ¹æ®ç”¨æˆ·idå’Œä¼˜æƒ åˆ¸idæŸ¥è¯¢è®¢å•è¡¨ä¸­æ˜¯å¦å·²ç»å­˜åœ¨äº†è¯¥è®¢å•ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›å¼‚å¸¸ç»“æœã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™èµ°ä¸‹å•é€»è¾‘ã€‚è§£å†³æ€è·¯ï¼šæ ¹æ®æŸ¥è¯¢å‡ºæ¥çš„è®¢å•æ•°é‡ï¼Œåˆ¤æ–­æ˜¯å¦é‡å¤ä¸‹å• // 5.1.æŸ¥è¯¢è®¢å• int count = query().eq(&quot;user_id&quot;, userId).eq(&quot;voucher_id&quot;, voucherId).count(); // 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨ if (count &gt; 0) { // ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº† log.error(&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;); return; } å¹¶å‘æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·å‘èµ·çš„200ä¸ªè¯·æ±‚ï¼‰ç”±äºå‘é€çš„è¯·æ±‚å¤´ä¸­æºå¸¦çš„æ˜¯ç›¸åŒçš„tockenï¼Œå› æ­¤æœåŠ¡å™¨è¯†åˆ«ä¸ºåŒä¸€ä¸ªç”¨æˆ·å¤±è´¥æ¯”ä¾‹95%åº“å­˜æ•°é‡ï¼š-10ï¼ˆ100 -&gt; 90ï¼‰è®¢å•æ•°é‡ï¼š10 ï¼ˆ0 -&gt; 10ï¼‰ ä¸ºä»€ä¹ˆå®ç°äº†ä¸€äººä¸€å•çš„é€»è¾‘åï¼Œä»ç„¶å‡ºç°äº†ä¸€ä¸ªç”¨æˆ·ä¸‹å¤šä¸ªè®¢å•çš„é—®é¢˜ï¼Ÿ è¿™ä»ç„¶æ˜¯å› ä¸ºå¤šçº¿ç¨‹å¹¶å‘æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶æŸ¥è¯¢å¾—åˆ°äº†countä¸º0ï¼Œç„¶åè¿›è¡Œäº†æ‰£å‡åº“å­˜çš„æ“ä½œã€‚å’Œåº“å­˜è¶…å–é—®é¢˜ç±»ä¼¼ã€‚è§£å†³æ€è·¯ï¼šå°†æŸ¥è¯¢è®¢å•æ•°é‡å’Œç”Ÿæˆè®¢å•å˜æˆåŸå­æ€§æ“ä½œSycronizedé”è§£å†³ @Transactional public Result createVoucherOrder(Long voucherId) { // 5.ä¸€äººä¸€å• Long userId = UserHolder.getUser().getId(); //å¦‚æœç›´æ¥é”userIdï¼Œæ¯æ¬¡é”ä½çš„å…¶å®æ˜¯ä¸åŒçš„userIdå¯¹è±¡ï¼Œå› æ­¤æ²¡æœ‰ä½œç”¨ synchronized (userId.toString().intern()) { // 5.1.æŸ¥è¯¢è®¢å• int count = query().eq(&quot;user_id&quot;, userId).eq(&quot;voucher_id&quot;, voucherId).count(); // 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨ if (count &gt; 0) { // ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº† return Result.fail(&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;); } // 6.æ‰£å‡åº“å­˜ boolean success = seckillVoucherService.update() .setSql(&quot;stock = stock - 1&quot;) // set stock = stock - 1 .eq(&quot;voucher_id&quot;, voucherId).gt(&quot;stock&quot;, 0) // where id = ? and stock &gt; 0 .update(); if (!success) { // æ‰£å‡å¤±è´¥ return Result.fail(&quot;åº“å­˜ä¸è¶³ï¼&quot;); } // 7.åˆ›å»ºè®¢å• VoucherOrder voucherOrder = new VoucherOrder(); // 7.1.è®¢å•id long orderId = redisIdWorker.nextId(&quot;order&quot;); voucherOrder.setId(orderId); // 7.2.ç”¨æˆ·id voucherOrder.setUserId(userId); // 7.3.ä»£é‡‘åˆ¸id voucherOrder.setVoucherId(voucherId); save(voucherOrder); // 7.è¿”å›è®¢å•id return Result.ok(orderId); } } å¦‚æœä»…ä»…é‡‡ç”¨ä¸Šè¿°è¿™ç§æ–¹å¼ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡æäº¤å‰ï¼Œé”å·²ç»é‡Šæ”¾ï¼Œæ­¤æ—¶åˆ›å»ºè®¢å•çš„è®°å½•è¿˜æœªå†™å…¥åˆ°æ•°æ®åº“ä¸­ã€‚å› æ­¤å¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹è·å–é”ï¼Œå¹¶åˆ›å»ºè®¢å•ï¼Œä»ç„¶é€ æˆå¤šçº¿ç¨‹å¹¶å‘ä¸å®‰å…¨çš„æƒ…å†µã€‚è§£å†³æ€è·¯ï¼šå…ˆè·å–é”-&gt;æ‰§è¡Œé€»è¾‘ï¼Œæäº¤äº‹åŠ¡-&gt;å†é‡Šæ”¾é”ã€‚ public Result seckillVoucher(Long voucherId) { // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸ SeckillVoucher voucher = seckillVoucherService.getById(voucherId); // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹ if (voucher.getBeginTime().isAfter(LocalDateTime.now())) { // å°šæœªå¼€å§‹ return Result.fail(&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;); } // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ if (voucher.getEndTime().isBefore(LocalDateTime.now())) { // å°šæœªå¼€å§‹ return Result.fail(&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;); } // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ if (voucher.getStock() &lt; 1) { // åº“å­˜ä¸è¶³ return Result.fail(&quot;åº“å­˜ä¸è¶³ï¼&quot;); } // 5.ä¸€äººä¸€å• Long userId = UserHolder.getUser().getId(); synchronized (userId.toString().intern()) { Object proxy = AopContext.currentProxy(); return proxy.createVoucherOrder(voucherId); } } @Transactional public Result createVoucherOrder(Long voucherId) { // 5.ä¸€äººä¸€å• Long userId = UserHolder.getUser().getId(); //å¦‚æœç›´æ¥é”userIdï¼Œæ¯æ¬¡é”ä½çš„å…¶å®æ˜¯ä¸åŒçš„userIdå¯¹è±¡ï¼Œå› æ­¤æ²¡æœ‰ä½œç”¨ // 5.1.æŸ¥è¯¢è®¢å• int count = query().eq(&quot;user_id&quot;, userId).eq(&quot;voucher_id&quot;, voucherId).count(); // 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨ if (count &gt; 0) { // ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº† return Result.fail(&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;); } // 6.æ‰£å‡åº“å­˜ boolean success = seckillVoucherService.update() .setSql(&quot;stock = stock - 1&quot;) // set stock = stock - 1 .eq(&quot;voucher_id&quot;, voucherId).gt(&quot;stock&quot;, 0) // where id = ? and stock &gt; 0 .update(); if (!success) { // æ‰£å‡å¤±è´¥ return Result.fail(&quot;åº“å­˜ä¸è¶³ï¼&quot;); } // 7.åˆ›å»ºè®¢å• VoucherOrder voucherOrder = new VoucherOrder(); // 7.1.è®¢å•id long orderId = redisIdWorker.nextId(&quot;order&quot;); voucherOrder.setId(orderId); // 7.2.ç”¨æˆ·id voucherOrder.setUserId(userId); // 7.3.ä»£é‡‘åˆ¸id voucherOrder.setVoucherId(voucherId); save(voucherOrder); // 7.è¿”å›è®¢å•id return Result.ok(orderId); } ä¸ºä»€ä¹ˆæ²¡æœ‰ç›´æ¥è°ƒç”¨createVoucherOrder()ï¼Œè€Œæ˜¯é€šè¿‡è°ƒç”¨ä»£ç†å¯¹è±¡çš„createVoucherOrder()çš„æ–¹æ³•ï¼Ÿ Springä¸­çš„äº‹åŠ¡å¤±æ•ˆçš„ä¸€ç§æƒ…å†µã€‚å¦‚æœç›´æ¥è°ƒç”¨createVoucherOrder()ï¼Œç”±äºå®ƒå¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œå› æ­¤ä¸å…·æœ‰äº‹åŠ¡åŠŸèƒ½ã€‚å¹¶å‘æµ‹è¯•200ä¸ªè¯·æ±‚ä¸­åªæœ‰ä¸€ä¸ªè¯·æ±‚èƒ½ä¸‹å•æˆåŠŸï¼Œæ»¡è¶³è¦æ±‚åº“å­˜-1è®¢å•+1 ä¸Šè¿°è¿™ç§æ–¹å¼ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ åœ¨å•ä½“å¼æƒ…å†µä¸‹èƒ½ä¿è¯ä¸€äººä¸€å•çš„ä¸šåŠ¡éœ€æ±‚ã€‚ä½†è‹¥å°†ä¸šåŠ¡ç³»ç»Ÿéƒ¨ç½²åˆ°å¤šå°æœåŠ¡å™¨ä¸Šï¼Œä»ç„¶ä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚è™½ç„¶ä»ç„¶æ˜¯å¯¹åŒä¸€ä¸ªuserIdä¸Šé”ï¼Œä½†ç”±äºä¸åŒçš„æœåŠ¡å™¨éƒ½æ‹¥æœ‰è‡ªå·±çš„JVMï¼ŒJVMå¸¸é‡æ± ä¸­çš„userIdå¯¹è±¡æ˜¯ä¸åŒçš„ï¼Œå› æ­¤å®ƒä»¬å…³è”çš„é”ç›‘è§†å™¨ä¹Ÿä¸åŒã€‚å½“æœåŠ¡å™¨1ä¸­çš„çº¿ç¨‹1è·å–äº†äº’æ–¥é”åï¼Œæœ‰çº¿ç¨‹2æƒ³è¦è·å–æœåŠ¡å™¨2çš„äº’æ–¥é”ï¼Œå®ƒå‘ç°é”ç›‘è§†å™¨ä¸ºç©ºï¼Œå› æ­¤ä»ç„¶èƒ½è·å–äº’æ–¥é”æˆåŠŸï¼Œå¯¼è‡´ä»ç„¶å‡ºç°ä¸€äººä¸‹å¤šå•çš„é—®é¢˜ã€‚è§£å†³æ€è·¯ï¼šè®©æ‰€æœ‰çš„JVMå…±äº«ä¸€æŠŠé”ï¼ˆåˆ†å¸ƒå¼é”ï¼‰ å››ã€åˆ†å¸ƒå¼é”åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„ç»“æœï¼Œæ³¨æ„ï¼šè¿™ä¸ªåœ°æ–¹è¯´çš„å¯è§æ€§å¹¶ä¸æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­æŒ‡çš„å†…å­˜å¯è§æ€§ï¼Œåªæ˜¯è¯´å¤šä¸ªè¿›ç¨‹ä¹‹é—´éƒ½èƒ½æ„ŸçŸ¥åˆ°å˜åŒ–çš„æ„æ€äº’æ–¥ï¼šäº’æ–¥æ˜¯åˆ†å¸ƒå¼é”çš„æœ€åŸºæœ¬çš„æ¡ä»¶ï¼Œä½¿å¾—ç¨‹åºä¸²è¡Œæ‰§è¡Œé«˜å¯ç”¨ï¼ˆä¸»è¦çœ‹æ˜¯å¦æ”¯æŒé›†ç¾¤æ¨¡å¼ï¼‰ï¼šç¨‹åºä¸æ˜“å´©æºƒï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½ä¿è¯è¾ƒé«˜çš„å¯ç”¨æ€§é«˜æ€§èƒ½ï¼šç”±äºåŠ é”æœ¬èº«å°±è®©æ€§èƒ½é™ä½ï¼Œæ‰€æœ‰å¯¹äºåˆ†å¸ƒå¼é”æœ¬èº«éœ€è¦ä»–å°±è¾ƒé«˜çš„åŠ é”æ€§èƒ½å’Œé‡Šæ”¾é”æ€§èƒ½å®‰å…¨æ€§ï¼ˆæ¯”å¦‚é”çš„é‡Šæ”¾ï¼‰ï¼šå®‰å…¨ä¹Ÿæ˜¯ç¨‹åºä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯å¸¸è§çš„åˆ†å¸ƒå¼é”ï¼š åˆ†å¸ƒå¼é”å®ç°å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š è·å–é”ï¼š äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é” éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false é‡Šæ”¾é”ï¼š æ‰‹åŠ¨é‡Šæ”¾ è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´ æ ¸å¿ƒæ€è·¯ï¼šåˆ©ç”¨redis çš„setNxå‘½ä»¤ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œäº†SETNXåï¼Œredis ä¸­å°±æœ‰è¿™ä¸ªkey äº†ï¼Œè¿”å›äº†1ï¼Œå¦‚æœç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºä»–æŠ¢åˆ°äº†é”ï¼Œé‚£ä¹ˆä»–å»æ‰§è¡Œä¸šåŠ¡ï¼Œç„¶åå†åˆ é™¤é”ï¼Œé€€å‡ºé”é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€å®šæ—¶é—´åé‡è¯•å³å¯ é—®é¢˜ï¼šæ‰§è¡ŒEXPIREæŒ‡ä»¤å¯ä»¥ä¸ºé”è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä½†æ˜¯å¦‚æœåœ¨SETNXä¹‹åï¼ŒEXPIREä¹‹å‰ï¼ŒæœåŠ¡å™¨å®•æœºäº†ï¼Œå¯¼è‡´æ²¡æœ‰ä¸ºé”è®¾ç½®ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ€ä¹ˆåŠï¼Ÿ åœ¨SETå‘½ä»¤åå¯ä»¥è·Ÿä¸Šè®¸å¤šå‚æ•°ï¼Œå…¶ä¸­å°±åŒ…æ‹¬NXä¸EXï¼Œå¦‚æœåŠ ä¸Šäº†NXï¼Œé‚£ä¹ˆæ­¤æ—¶æ•ˆæœå°±å’ŒSETNXç­‰ä»·ã€‚åŒæ—¶åœ¨åŠ ä¸ŠEXè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå°†è¿™ä¸¤æ¡æŒ‡ä»¤ç»“åˆä¸ºä¸€æ¡æŒ‡ä»¤ã€‚é”æ¥å£ public interface ILock { /** * å°è¯•è·å–é” * @param timeoutSec é”æŒæœ‰çš„è¶…æ—¶æ—¶é—´ï¼Œè¿‡æœŸåè‡ªåŠ¨é‡Šæ”¾ * @return trueä»£è¡¨è·å–é”æˆåŠŸ; falseä»£è¡¨è·å–é”å¤±è´¥ */ boolean tryLock(long timeoutSec); /** * é‡Šæ”¾é” */ void unlock(); } å®ç°ç‰ˆæœ¬1ï¼ˆä½¿ç”¨Redisçš„SetNXåˆ†å¸ƒå¼é”æ¥ä¸ºåˆ›å»ºè®¢å•ä¸šåŠ¡åŠ é”ï¼‰public class SimpleRedisLock implements ILock { private String name; private StringRedisTemplate stringRedisTemplate; public SimpleRedisLock(String name, StringRedisTemplate stringRedisTemplate) { this.name = name; this.stringRedisTemplate = stringRedisTemplate; } private static final String KEY_PREFIX = &quot;lock:&quot;; //keyä¸ºä¸šåŠ¡ç›¸å…³ï¼Œå€¼ä¸ºçº¿ç¨‹id @Override public boolean tryLock(long timeoutSec) { // è·å–çº¿ç¨‹æ ‡ç¤º String threadId = Thread.currentThread().getId(); // è·å–é” Boolean success = stringRedisTemplate.opsForValue() .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS); //ç”±äºä¼šæ‹†ç®±ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸ return Boolean.TRUE.equals(success); } @Override public void unlock() { // é‡Šæ”¾é” stringRedisTemplate.delete(KEY_PREFIX + name); } } } ä¸šåŠ¡ä»£ç ä¼˜åŒ–ï¼ˆä¸€äººä¸€å•ï¼Œæ›¿æ¢Sycronizedï¼‰ @Override public Result seckillVoucher(Long voucherId) { // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸ SeckillVoucher voucher = seckillVoucherService.getById(voucherId); // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹ if (voucher.getBeginTime().isAfter(LocalDateTime.now())) { // å°šæœªå¼€å§‹ return Result.fail(&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;); } // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ if (voucher.getEndTime().isBefore(LocalDateTime.now())) { // å°šæœªå¼€å§‹ return Result.fail(&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;); } // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ if (voucher.getStock() &lt; 1) { // åº“å­˜ä¸è¶³ return Result.fail(&quot;åº“å­˜ä¸è¶³ï¼&quot;); } Long userId = UserHolder.getUser().getId(); //-------------------------------------------------------------------------------- //åˆ›å»ºé”å¯¹è±¡(æ–°å¢ä»£ç ) SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate); //è·å–é”å¯¹è±¡ boolean isLock = lock.tryLock(1200); //åŠ é”å¤±è´¥ if (!isLock) { return Result.fail(&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;); } try { //è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡) IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy(); return proxy.createVoucherOrder(voucherId); } finally { //é‡Šæ”¾é” lock.unlock(); } } ä¸Šè¿°æ–¹æ³•ä»ç„¶ä¼šå­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ çº¿ç¨‹1è·å–é”åç”±äºæŸä¸ªåŸå› é˜»å¡ï¼Œå¯¼è‡´ä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œï¼Œé”çš„è¿‡æœŸæ—¶é—´å·²ç»åˆ°äº†ï¼Œå› æ­¤é”è‡ªåŠ¨é‡Šæ”¾ã€‚æ­¤æ—¶çº¿ç¨‹2è·å–é”å¹¶æ‰§è¡Œä¸šåŠ¡ï¼Œè€Œçº¿ç¨‹1ä¸šåŠ¡æ¢å¤ï¼Œæ‰§è¡Œä¸šåŠ¡å®Œæ¯•åä»ç„¶ä¼šæ‰§è¡Œé‡Šæ”¾é”çš„ä»£ç ã€‚æ­¤æ—¶çº¿ç¨‹3å¯ä»¥è·å–é”ï¼Œç»§ç»­æ‰§è¡Œä¸šåŠ¡ï¼Œå¯¼è‡´ä»ç„¶ä¼šå‡ºç°å¹¶å‘å®‰å…¨é—®é¢˜ã€‚ å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜ï¼Ÿ åœ¨çº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™å»åˆ¤æ–­é”æ ‡è¯†æ˜¯å¦å’Œå½“å‰ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œæ‰é‡Šæ”¾é”ã€‚ å®ç°ç‰ˆæœ¬2ï¼ˆè§£å†³çº¿ç¨‹è¯¯åˆ é”é—®é¢˜ï¼‰éœ€æ±‚ï¼šä¿®æ”¹ä¹‹å‰çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæ»¡è¶³ï¼šåœ¨è·å–é”æ—¶å­˜å…¥çº¿ç¨‹æ ‡ç¤ºï¼ˆå¯ä»¥ç”¨UUIDè¡¨ç¤ºï¼‰åœ¨é‡Šæ”¾é”æ—¶å…ˆè·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´ å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é” å¦‚æœä¸ä¸€è‡´åˆ™ä¸é‡Šæ”¾é” æ ¸å¿ƒé€»è¾‘ï¼šåœ¨å­˜å…¥é”æ—¶ï¼Œæ”¾å…¥è‡ªå·±çº¿ç¨‹çš„æ ‡è¯†ï¼Œåœ¨åˆ é™¤é”æ—¶ï¼Œåˆ¤æ–­å½“å‰è¿™æŠŠé”çš„æ ‡è¯†æ˜¯ä¸æ˜¯è‡ªå·±å­˜å…¥çš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œåˆ é™¤ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä¸è¿›è¡Œåˆ é™¤ã€‚ ä¸ºä»€ä¹ˆä½¿ç”¨UUIDï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨çº¿ç¨‹IDï¼Ÿ ç”±äºçº¿ç¨‹IDåœ¨æ¯ä¸ªJVMå†…éƒ¨éƒ½æ˜¯é€’å¢çš„ï¼Œå› æ­¤å¯èƒ½ä¼šå‡ºç°ä¸åŒçš„æœåŠ¡å™¨ä¸­çº¿ç¨‹IDç›¸åŒçš„æƒ…å†µï¼Œå¯¼è‡´å‡ºç°å†²çªã€‚è·å–é” private static final String ID_PREFIX = UUID.randomUUID().toString(true) + &quot;-&quot;; @Override public boolean tryLock(long timeoutSec) { // è·å–çº¿ç¨‹æ ‡ç¤º String threadId = ID_PREFIX + Thread.currentThread().getId(); // è·å–é” Boolean success = stringRedisTemplate.opsForValue() .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS); return Boolean.TRUE.equals(success); } é‡Šæ”¾é” public void unlock() { // è·å–çº¿ç¨‹æ ‡ç¤º String threadId = ID_PREFIX + Thread.currentThread().getId(); // è·å–é”ä¸­çš„æ ‡ç¤º String id = stringRedisTemplate.opsForValue().get(KEY_PREFIX + name); // åˆ¤æ–­æ ‡ç¤ºæ˜¯å¦ä¸€è‡´ if(threadId.equals(id)) { // é‡Šæ”¾é” stringRedisTemplate.delete(KEY_PREFIX + name); } } ä¸Šè¿°ä»£ç ä»ç„¶å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼ˆæç«¯è¯¯åˆ æƒ…å†µï¼‰ çº¿ç¨‹1æ‰§è¡Œä¸šåŠ¡ï¼Œåœ¨åˆ¤æ–­é”æ ‡è¯†æ˜¯å¦ä¸€è‡´ï¼Œè¦é‡Šæ”¾é”ä¹‹å‰ï¼Œå‘ç”Ÿäº†é˜»å¡ï¼ˆæ¯”å¦‚FULL GCï¼‰ã€‚åœ¨é˜»å¡è¿‡ç¨‹ä¸­ï¼Œé”è¶…æ—¶é‡Šæ”¾ã€‚æ­¤æ—¶çº¿ç¨‹2è·å–é”å¹¶æ‰§è¡Œï¼Œä½†çº¿ç¨‹1æ¢å¤æ‰§è¡Œï¼Œé‚£ä¹ˆå°±é‡Šæ”¾æ‰çº¿ç¨‹2çš„é”ï¼Œå¯¼è‡´ä»ç„¶å‡ºç°å¹¶å‘å®‰å…¨é—®é¢˜ã€‚é—®é¢˜åŸå› æ‰€åœ¨ï¼šé”æ ‡å¿—åˆ¤æ–­å’Œé‡Šæ”¾éåŸå­æ€§ å®ç°ç‰ˆæœ¬3ï¼ˆLuaè„šæœ¬å°†æŸ¥è¯¢é”æ ‡å¿—å’Œé‡Šæ”¾é”å˜æˆåŸå­æ€§æ“ä½œï¼‰Redisæä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Rediså‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚Luaæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒçš„åŸºæœ¬è¯­æ³•å¤§å®¶å¯ä»¥å‚è€ƒç½‘ç«™ï¼šhttps://www.runoob.com/lua/lua-tutorial.htmlï¼Œè¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨luaå»æ“ä½œredisï¼Œåˆèƒ½ä¿è¯ä»–çš„åŸå­æ€§ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§åŠ¨ä½œäº†ï¼Œä½œä¸ºJavaç¨‹åºå‘˜è¿™ä¸€å—å¹¶ä¸ä½œä¸€ä¸ªç®€å•è¦æ±‚ï¼Œå¹¶ä¸éœ€è¦å¤§å®¶è¿‡äºç²¾é€šï¼Œåªéœ€è¦çŸ¥é“ä»–æœ‰ä»€ä¹ˆä½œç”¨å³å¯ã€‚è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œè¯­æ³•å¦‚ä¸‹ï¼šredis.call(â€˜å‘½ä»¤åç§°â€™, â€˜keyâ€™, â€˜å…¶å®ƒå‚æ•°â€™, â€¦)ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œset name jackï¼Œåˆ™è„šæœ¬æ˜¯è¿™æ ·ï¼š # æ‰§è¡Œ set name jack redis.call(&#39;set&#39;, &#39;name&#39;, &#39;jack&#39;) ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦å…ˆæ‰§è¡Œset name Roseï¼Œå†æ‰§è¡Œget nameï¼Œåˆ™è„šæœ¬å¦‚ä¸‹ï¼š # å…ˆæ‰§è¡Œ set name jack redis.call(&#39;set&#39;, &#39;name&#39;, &#39;Rose&#39;) # å†æ‰§è¡Œ get name local name = redis.call(&#39;get&#39;, &#39;name&#39;) # è¿”å› return name é€šè¿‡EVALå‘½ä»¤æ‰§è¡Œè„šæœ¬æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å›ä¸€ä¸‹æˆ‘ä»¬é‡Šæ”¾é”çš„é€»è¾‘ï¼šé‡Šæ”¾é”çš„ä¸šåŠ¡æµç¨‹æ˜¯è¿™æ ·çš„ 1ã€è·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤º 2ã€åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šçš„æ ‡ç¤ºï¼ˆå½“å‰çº¿ç¨‹æ ‡ç¤ºï¼‰ä¸€è‡´ 3ã€å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”ï¼ˆåˆ é™¤ï¼‰ 4ã€å¦‚æœä¸ä¸€è‡´åˆ™ä»€ä¹ˆéƒ½ä¸åšå¦‚æœç”¨Luaè„šæœ¬æ¥è¡¨ç¤ºåˆ™æ˜¯è¿™æ ·çš„ï¼šæœ€ç»ˆæˆ‘ä»¬æ“ä½œredisçš„æ‹¿é”æ¯”é”åˆ é”çš„luaè„šæœ¬å°±ä¼šå˜æˆè¿™æ · -- è¿™é‡Œçš„ KEYS[1] å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1] å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º -- è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´ if (redis.call(&#39;GET&#39;, KEYS[1]) == ARGV[1]) then -- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é” return redis.call(&#39;DEL&#39;, KEYS[1]) end -- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å› return 0 ä»£ç å®ç° //è®¾ç½®staticï¼Œåœ¨ç±»åˆå§‹åŒ–å°±åŠ è½½è„šæœ¬ï¼Œä¸å¿…ä¹‹åæ¯æ¬¡ä½¿ç”¨æ—¶é‡å¤åŠ è½½è„šæœ¬ private static final DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT; //Redisè„šæœ¬ static { UNLOCK_SCRIPT = new DefaultRedisScript&lt;&gt;(); //è®¾ç½®è„šæœ¬å­˜æ”¾ä½ç½® UNLOCK_SCRIPT.setLocation(new ClassPathResource(&quot;unlock.lua&quot;)); //è®¾ç½®è„šæœ¬è¿”å›å€¼ç±»å‹ UNLOCK_SCRIPT.setResultType(Long.class); } public void unlock() { // è°ƒç”¨luaè„šæœ¬ stringRedisTemplate.execute( UNLOCK_SCRIPT, Collections.singletonList(KEY_PREFIX + name), ID_PREFIX + Thread.currentThread().getId()); } // ç»è¿‡ä»¥ä¸Šä»£ç æ”¹é€ åï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå®ç° æ‹¿é”æ¯”é”åˆ é”çš„åŸå­æ€§åŠ¨ä½œäº†~ äº”ã€åˆ†å¸ƒå¼é”ï¼ˆRedissionï¼‰åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼šé‡å…¥é—®é¢˜ï¼šé‡å…¥é—®é¢˜æ˜¯æŒ‡ è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œæ¯”å¦‚HashTableè¿™æ ·çš„ä»£ç ä¸­ï¼Œä»–çš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨synchronizedä¿®é¥°çš„ï¼Œå‡å¦‚ä»–åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¸å°±æ­»é”äº†å—ï¼Ÿæ‰€ä»¥å¯é‡å…¥é”ä»–çš„ä¸»è¦æ„ä¹‰æ˜¯é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬çš„synchronizedå’ŒLocké”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚ä¸å¯é‡è¯•ï¼šæ˜¯æŒ‡ç›®å‰çš„åˆ†å¸ƒå¼åªèƒ½å°è¯•ä¸€æ¬¡ï¼Œæˆ‘ä»¬è®¤ä¸ºåˆç†çš„æƒ…å†µæ˜¯ï¼šå½“çº¿ç¨‹åœ¨è·å¾—é”å¤±è´¥åï¼Œä»–åº”è¯¥èƒ½å†æ¬¡å°è¯•è·å¾—é”ã€‚è¶…æ—¶é‡Šæ”¾ï¼šæˆ‘ä»¬åœ¨åŠ é”æ—¶å¢åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„æˆ‘ä»¬å¯ä»¥é˜²æ­¢æ­»é”ï¼Œä½†æ˜¯å¦‚æœå¡é¡¿çš„æ—¶é—´è¶…é•¿ï¼Œè™½ç„¶æˆ‘ä»¬é‡‡ç”¨äº†luaè¡¨è¾¾å¼é˜²æ­¢åˆ é”çš„æ—¶å€™ï¼Œè¯¯åˆ åˆ«äººçš„é”ï¼Œä½†æ˜¯æ¯•ç«Ÿæ²¡æœ‰é”ä½ï¼Œæœ‰å®‰å…¨éšæ‚£ä¸»ä»ä¸€è‡´æ€§ï¼š å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œå½“æˆ‘ä»¬å‘é›†ç¾¤å†™æ•°æ®æ—¶ï¼Œä¸»æœºéœ€è¦å¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œè€Œä¸‡ä¸€åœ¨åŒæ­¥è¿‡å»ä¹‹å‰ï¼Œä¸»æœºå®•æœºäº†ï¼Œå°±ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚ Redissonå¯é‡å…¥é”åŸç†Redissionå¯é‡å…¥é”çš„è®¾è®¡æ€æƒ³å’ŒReentranlockç›¸ä¼¼ï¼Œé€šè¿‡valueå€¼æ¥è®°å½•å½“å‰é”çš„é‡å…¥æ¬¡æ•°ã€‚åœ¨åˆ†å¸ƒå¼é”ä¸­ï¼Œé‡‡ç”¨hashç»“æ„æ¥å­˜å‚¨é”ï¼Œå¤§keyè¡¨ç¤ºè¿™æŠŠé”æ˜¯å¦å­˜åœ¨ï¼Œå°keyæŒ‡å‘æŒæœ‰é”çš„çº¿ç¨‹ï¼ŒvalueæŒ‡å‘å½“å‰è¢«é‡å…¥çš„æ¬¡æ•°ã€‚å› æ­¤å½“ä¸€ä¸ªçº¿ç¨‹æƒ³æŒæœ‰é”æ—¶ï¼Œå®ƒé¦–å…ˆåˆ¤æ–­è¯¥é”æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è·å–é”ï¼Œå¹¶åœ¨hashç»“æ„ä¸­æ·»åŠ key\\valueã€‚å¦‚æœçº¿ç¨‹ä¸­æœ‰å¦ä¸€ä¸ªæ–¹æ³•ä»ç„¶æƒ³è·å–è¯¥é”ï¼Œåˆ™é¦–å…ˆåˆ¤æ–­æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªçº¿ç¨‹idï¼Œå¦‚æœæ˜¯ï¼Œåˆ™vlaueå€¼+1ã€‚å’ŒRedissonå®ç°å¯é‡å…¥é”çš„é€»è¾‘ä¸€æ ·ï¼ŒåŒæ ·æ˜¯é€šè¿‡å“ˆå¸Œ+luaè„šæœ¬æ¥å®ç°çš„ã€‚ Redissoné”é‡è¯•åŠè¶…æ—¶é‡Šæ”¾Redissonè§£å†³ä¸»ä»ä¸€è‡´æ€§ï¼ˆè”é”multiLockï¼‰ é—®é¢˜å¼•å…¥ï¼šRedisçš„ä¸»èŠ‚ç‚¹æ‰§è¡Œäº†SETNXæ“ä½œåï¼Œè¯¥å‘½ä»¤è¿˜æœªåŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹å°±å·²ç»å®•æœºã€‚æ­¤æ—¶Redisé€šè¿‡å“¨å…µæ¨¡å¼é€‰å–ä¸€ä¸ªæ–°çš„ä»èŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œä½†æ˜¯æ–°ä¸»èŠ‚ç‚¹æ‰§è¡Œç›¸åŒçš„SETNXåè¿”å›1ï¼Œå¯¼è‡´æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å¾—äº†é”ï¼Œå‡ºç°å¹¶å‘å®‰å…¨é—®é¢˜ã€‚ Redissonæ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Ÿ æ—¢ç„¶ä¸»ä»èŠ‚ç‚¹æ¨¡å¼ä¸‹ï¼Œä¸»ä»èŠ‚ç‚¹ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´å‹çš„é—®é¢˜ã€‚å› æ­¤Redisè®¾ç½®å¤šä¸ªç»“ç‚¹ï¼Œå¹¶æŠŠæ¯ä¸ªç»“ç‚¹éƒ½ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç»“ç‚¹ï¼Œå³å¯è¿›è¡Œå†™ä¹Ÿå¯è¿›è¡Œè¯»ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¦è·å–é”ï¼Œé‚£ä¹ˆå®ƒåœ¨å¤šä¸ªç»“ç‚¹ä¸‹åŒæ—¶è·å¾—é”æˆåŠŸæ‰ç®—æˆåŠŸï¼Œåªè¦æœ‰ä¸€ä¸ªç»“ç‚¹æ²¡æœ‰æˆåŠŸï¼Œé‚£ä¹ˆå°±ä¼šè·å–é”å¤±è´¥ã€‚å¦‚æœæƒ³æé«˜å¯ç”¨æ€§ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªç»“ç‚¹ï¼Œå†é…ç½®ä»èŠ‚ç‚¹ã€‚å¦‚æœæ­¤æ—¶æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹å®•æœºï¼Œä¸”é”æ•°æ®è¿˜æœªåŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¦è·å–è¯¥é”æ—¶ï¼Œå°½ç®¡åœ¨è¯¥ä»èŠ‚ç‚¹è®¾ç½®SETNXè¿”å›1ï¼Œä½†å…¶ä»–ä¸¤ä¸ªç»“ç‚¹è®¾ç½®SETNXå‡è¿”å›0ï¼Œå› æ­¤å³ä½¿ä»èŠ‚ç‚¹è¿˜æœªåŒæ­¥é”æ•°æ®ï¼Œç”±äºè¿™ç§æœºåˆ¶ï¼Œä»ç„¶ä¿è¯äº†å¤šçº¿ç¨‹ä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚ å…­ã€ç§’æ€ä¼˜åŒ–å¯¹ç›®å‰ä¼˜æƒ åˆ¸ç³»ç»Ÿè¿›è¡Œå¹¶å‘æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿ1000ä¸ªç”¨æˆ·åŒæ—¶ä¸‹å•ï¼‰å¹³å‡å“åº”æ—¶é—´è¾¾åˆ°497msï¼ˆä¸šåŠ¡è€—æ—¶è¾ƒé•¿ï¼‰ åˆ†æä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„åŸå›  ç§’æ€ä¸šåŠ¡è¿›è¡Œå„æ“ä½œæ˜¯ä¸€ä¸ªä¸²è¡Œçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå»æ•°æ®åº“ä¸­æŸ¥è¯¢æˆ–è€…æ‰§è¡Œå†™æ“ä½œï¼Œç›¸å¯¹è¾ƒä¸ºè€—æ—¶ã€‚ å¦‚ä½•è¿›è¡Œä¼˜åŒ–ï¼Ÿï¼ˆæé«˜å¹¶å‘èƒ½åŠ›ã€å‡è½»æ•°æ®åº“å‹åŠ›ï¼‰ å°†æŸ¥è¯¢ä¼˜æƒ åˆ¸åº“å­˜ã€åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ä»¥åŠæŸ¥è¯¢è®¢å•ã€æ ¡éªŒä¸€äººä¸€å•çš„å·¥ä½œä¸å‡åº“å­˜ã€åˆ›å»ºè®¢å•çš„å·¥ä½œåˆ†ç¦»å¼€ï¼Œå¼€å¯ä¸¤ä¸ªç‹¬ç«‹çš„çº¿ç¨‹å»åˆ†åˆ«å®Œæˆä¸¤ä¸ªå·¥ä½œã€‚å°†è€—æ—¶æ¯”è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾å…¥åˆ°redisä¸­ï¼Œæ¯”å¦‚æ˜¯å¦åº“å­˜è¶³å¤Ÿï¼Œæ¯”å¦‚æ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿™æ ·çš„æ“ä½œï¼Œåªè¦è¿™ç§é€»è¾‘å¯ä»¥å®Œæˆï¼Œå°±æ„å‘³ç€æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•å®Œæˆçš„ï¼Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œå¿«é€Ÿçš„é€»è¾‘åˆ¤æ–­ï¼Œæ ¹æœ¬å°±ä¸ç”¨ç­‰ä¸‹å•é€»è¾‘èµ°å®Œï¼Œæˆ‘ä»¬ç›´æ¥ç»™ç”¨æˆ·è¿”å›æˆåŠŸï¼Œ å†åœ¨åå°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹æ…¢æ…¢çš„å»æ‰§è¡Œqueueé‡Œè¾¹çš„æ¶ˆæ¯ï¼Œè¿™æ ·ç¨‹åºä¸å°±è¶…çº§å¿«äº†å—ï¼Ÿè€Œä¸”ä¹Ÿä¸ç”¨æ‹…å¿ƒçº¿ç¨‹æ± æ¶ˆè€—æ®†å°½çš„é—®é¢˜ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬çš„ç¨‹åºä¸­å¹¶æ²¡æœ‰æ‰‹åŠ¨ä½¿ç”¨ä»»ä½•çº¿ç¨‹æ± ï¼Œå½“ç„¶è¿™é‡Œè¾¹æœ‰ä¸¤ä¸ªéš¾ç‚¹ç¬¬ä¸€ä¸ªéš¾ç‚¹æ˜¯æˆ‘ä»¬æ€ä¹ˆåœ¨redisä¸­å»å¿«é€Ÿæ ¡éªŒä¸€äººä¸€å•ï¼Œè¿˜æœ‰åº“å­˜åˆ¤æ–­ç¬¬äºŒä¸ªéš¾ç‚¹æ˜¯ç”±äºæˆ‘ä»¬æ ¡éªŒå’Œtomcatä¸‹å•æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•çŸ¥é“åˆ°åº•å“ªä¸ªå•ä»–æœ€åæ˜¯å¦æˆåŠŸï¼Œæˆ–è€…æ˜¯ä¸‹å•å®Œæˆï¼Œä¸ºäº†å®Œæˆè¿™ä»¶äº‹æˆ‘ä»¬åœ¨redisæ“ä½œå®Œä¹‹åï¼Œæˆ‘ä»¬ä¼šå°†ä¸€äº›ä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›ä¿¡æ¯ä¸¢åˆ°å¼‚æ­¥queueä¸­å»ï¼Œåç»­æ“ä½œä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥æŸ¥è¯¢æˆ‘ä»¬tomcatä¸­çš„ä¸‹å•é€»è¾‘æ˜¯å¦å®Œæˆäº†ã€‚å®ç°æ€è·¯ï¼šRediså­˜å‚¨æ•°æ®çš„ç»“æ„åº“å­˜æ•°æ®ï¼škey: åº“å­˜idï¼Œvalue:åº“å­˜æ•°é‡ä¸€äººä¸€å•æ•°æ®ï¼škeyï¼šåº“å­˜idï¼Œvalueï¼šä¿å­˜ç”¨æˆ·idçš„seté›†åˆã€‚ä¸ºäº†åœ¨Redisä¸­æ ¡éªŒä¸€äººä¸€å•çš„é€»è¾‘ï¼Œå› æ­¤åªè¦ä¸€ä¸ªç”¨æˆ·ä¸‹å•æˆåŠŸï¼Œå°±æŠŠè¿™ä¸ªç”¨æˆ·idæ”¾å…¥åˆ°ä¸€ä¸ªseté›†åˆä¸­ã€‚åç»­ç”¨æˆ·æƒ³ç»§ç»­ä¸‹å•æ—¶ï¼Œå¦‚æœåˆ¤æ–­setä¸­æœ‰è¿™ä¸ªå€¼ï¼Œå°±åˆ¤æ–­å·²ç»ä¸‹è¿‡å•ã€‚å½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³åªéœ€è¦å¯¼redisä¸­å»æ ¹æ®keyæ‰¾å¯¹åº”çš„valueæ˜¯å¦å¤§äº0å³å¯ï¼Œå¦‚æœä¸å……è¶³ï¼Œåˆ™ç›´æ¥ç»“æŸï¼Œå¦‚æœå……è¶³ï¼Œç»§ç»­åœ¨redisä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡æ•°æ®ï¼Œè¯´æ˜ä»–å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡è®°å½•ï¼Œåˆ™å°†userIdå’Œä¼˜æƒ å·å­˜å…¥åˆ°redisä¸­ï¼Œå¹¶ä¸”è¿”å›0ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œå¯ä»¥ä½¿ç”¨luaæ¥æ“ä½œã€‚å½“ä»¥ä¸Šåˆ¤æ–­é€»è¾‘èµ°å®Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å½“å‰redisä¸­è¿”å›çš„ç»“æœæ˜¯å¦æ˜¯0 ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä¸‹å•ï¼Œåˆ™å°†ä¹‹å‰è¯´çš„ä¿¡æ¯å­˜å…¥åˆ°åˆ°queueä¸­å»ï¼Œç„¶åè¿”å›ï¼Œç„¶åå†æ¥ä¸ªçº¿ç¨‹å¼‚æ­¥çš„ä¸‹å•ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡è¿”å›çš„è®¢å•idæ¥åˆ¤æ–­æ˜¯å¦ä¸‹å•æˆåŠŸã€‚ æ”¹è¿›ä¸šåŠ¡1ï¼ˆåŸºäºJDKé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ï¼‰éœ€æ±‚ï¼š æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­ åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ— å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½ é—®é¢˜ï¼šä¿å­˜ä¼˜æƒ åˆ¸åº“å­˜ä¿¡æ¯åˆ°Redisä¸­æ—¶ï¼Œéœ€è¦è®¾ç½®è¿‡æœŸæ—¶é—´å—ï¼Ÿ ä¸éœ€è¦ï¼Œä¼˜æƒ åˆ¸è®¾ç½®äº†ç§’æ€å¼€å§‹æ—¶é—´ä¸ç»“æŸæ—¶é—´ï¼Œå½“ç»“æŸæ—¶é—´åˆ°äº†ï¼Œæ·»åŠ åˆ é™¤ä¼˜æƒ åˆ¸çš„é€»è¾‘ã€‚å¦‚æœåˆ é™¤é€»è¾‘å¤±è´¥ï¼Œç”±äºRedisæœ‰æ•°æ®æ·˜æ±°ç­–ç•¥ï¼Œç”±äºè¿™ä¸ªä¼˜æƒ åˆ¸ä¸‹æ¶åå°±ä¸å†ä¼šè¢«ä½¿ç”¨ï¼Œå› æ­¤å½“Rediså†…å­˜è¾¾åˆ°é˜ˆå€¼ä¹‹åï¼Œä¹Ÿä¼šè§¦å‘æ·˜æ±°ç­–ç•¥æŠŠå®ƒä»Redisä¸­æ·˜æ±°æ‰ã€‚ä¿å­˜åº“å­˜ä¿¡æ¯åˆ°Redisä¸­ @Override @Transactional public void addSeckillVoucher(Voucher voucher) { // ä¿å­˜ä¼˜æƒ åˆ¸ save(voucher); // ä¿å­˜ç§’æ€ä¿¡æ¯ SeckillVoucher seckillVoucher = new SeckillVoucher(); seckillVoucher.setVoucherId(voucher.getId()); seckillVoucher.setStock(voucher.getStock()); seckillVoucher.setBeginTime(voucher.getBeginTime()); seckillVoucher.setEndTime(voucher.getEndTime()); seckillVoucherService.save(seckillVoucher); // ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­ //SECKILL_STOCK_KEY è¿™ä¸ªå˜é‡å®šä¹‰åœ¨RedisConstansä¸­ //private static final String SECKILL_STOCK_KEY =&quot;seckill:stock:&quot; stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString()); } å®Œæ•´luaè¡¨è¾¾å¼ -- 1.å‚æ•°åˆ—è¡¨ -- 1.1.ä¼˜æƒ åˆ¸id local voucherId = ARGV[1] -- 1.2.ç”¨æˆ·id local userId = ARGV[2] -- 1.3.è®¢å•id local orderId = ARGV[3] -- 2.æ•°æ®key -- 2.1.åº“å­˜key local stockKey = &#39;seckill:stock:&#39; .. voucherId -- 2.2.è®¢å•key local orderKey = &#39;seckill:order:&#39; .. voucherId -- 3.è„šæœ¬ä¸šåŠ¡ -- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey if(tonumber(redis.call(&#39;get&#39;, stockKey)) &lt;= 0) then -- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1 return 1 end -- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId if(redis.call(&#39;sismember&#39;, orderKey, userId) == 1) then -- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2 return 2 end -- 3.4.æ‰£åº“å­˜ incrby stockKey -1 redis.call(&#39;incrby&#39;, stockKey, -1) -- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId redis.call(&#39;sadd&#39;, orderKey, userId) -- 3.6.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œ XADD stream.orders * k1 v1 k2 v2 ... redis.call(&#39;xadd&#39;, &#39;stream.orders&#39;, &#39;*&#39;, &#39;userId&#39;, userId, &#39;voucherId&#39;, voucherId, &#39;id&#39;, orderId) return 0 //å¼‚æ­¥å¤„ç†çº¿ç¨‹æ±  private static final ExecutorService SECKILL_ORDER_EXECUTOR = Executors.newSingleThreadExecutor(); //åœ¨ç±»åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œå› ä¸ºå½“è¿™ä¸ªç±»åˆå§‹åŒ–å¥½äº†ä¹‹åï¼Œéšæ—¶éƒ½æ˜¯æœ‰å¯èƒ½è¦æ‰§è¡Œçš„ @PostConstruct private void init() { SECKILL_ORDER_EXECUTOR.submit(new VoucherOrderHandler()); } // ç”¨äºçº¿ç¨‹æ± å¤„ç†çš„ä»»åŠ¡ // å½“åˆå§‹åŒ–å®Œæ¯•åï¼Œå°±ä¼šå»ä»å¯¹åˆ—ä¸­å»æ‹¿ä¿¡æ¯ private class VoucherOrderHandler implements Runnable{ @Override public void run() { while (true){ try { // 1.è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ VoucherOrder voucherOrder = orderTasks.take(); // 2.åˆ›å»ºè®¢å• handleVoucherOrder(voucherOrder); } catch (Exception e) { log.error(&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;, e); } } } private void handleVoucherOrder(VoucherOrder voucherOrder) { //1.è·å–ç”¨æˆ· Long userId = voucherOrder.getUserId(); // 2.åˆ›å»ºé”å¯¹è±¡ RLock redisLock = redissonClient.getLock(&quot;lock:order:&quot; + userId); // 3.å°è¯•è·å–é” boolean isLock = redisLock.lock(); // 4.åˆ¤æ–­æ˜¯å¦è·å¾—é”æˆåŠŸ if (!isLock) { // è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–è€…é‡è¯• log.error(&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;); return; } try { //æ³¨æ„ï¼šç”±äºæ˜¯springçš„äº‹åŠ¡æ˜¯æ”¾åœ¨threadLocalä¸­ï¼Œæ­¤æ—¶çš„æ˜¯å¤šçº¿ç¨‹ï¼Œäº‹åŠ¡ä¼šå¤±æ•ˆ proxy.createVoucherOrder(voucherOrder); } finally { // é‡Šæ”¾é” redisLock.unlock(); } } //a private BlockingQueue&lt;VoucherOrder&gt; orderTasks =new ArrayBlockingQueue&lt;&gt;(1024 * 1024); @Override public Result seckillVoucher(Long voucherId) { Long userId = UserHolder.getUser().getId(); long orderId = redisIdWorker.nextId(&quot;order&quot;); // 1.æ‰§è¡Œluaè„šæœ¬ Long result = stringRedisTemplate.execute( SECKILL_SCRIPT, Collections.emptyList(), voucherId.toString(), userId.toString(), String.valueOf(orderId) ); int r = result.intValue(); // 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0 if (r != 0) { // 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼ return Result.fail(r == 1 ? &quot;åº“å­˜ä¸è¶³&quot; : &quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;); } VoucherOrder voucherOrder = new VoucherOrder(); // 2.3.è®¢å•id long orderId = redisIdWorker.nextId(&quot;order&quot;); voucherOrder.setId(orderId); // 2.4.ç”¨æˆ·id voucherOrder.setUserId(userId); // 2.5.ä»£é‡‘åˆ¸id voucherOrder.setVoucherId(voucherId); // 2.6.æ”¾å…¥é˜»å¡é˜Ÿåˆ— orderTasks.add(voucherOrder); //3.è·å–ä»£ç†å¯¹è±¡ proxy = (IVoucherOrderService)AopContext.currentProxy(); //4.è¿”å›è®¢å•id return Result.ok(orderId); } @Transactional public void createVoucherOrder(VoucherOrder voucherOrder) { Long userId = voucherOrder.getUserId(); // 5.1.æŸ¥è¯¢è®¢å• int count = query().eq(&quot;user_id&quot;, userId).eq(&quot;voucher_id&quot;, voucherOrder.getVoucherId()).count(); // 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨ if (count &gt; 0) { // ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº† log.error(&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†&quot;); return ; } // 6.æ‰£å‡åº“å­˜ boolean success = seckillVoucherService.update() .setSql(&quot;stock = stock - 1&quot;) // set stock = stock - 1 .eq(&quot;voucher_id&quot;, voucherOrder.getVoucherId()).gt(&quot;stock&quot;, 0) // where id = ? and stock &gt; 0 .update(); if (!success) { // æ‰£å‡å¤±è´¥ log.error(&quot;åº“å­˜ä¸è¶³&quot;); return ; } save(voucherOrder); } å½“å‰çš„ç§’æ€ä¸šåŠ¡è¿˜å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ å†…å­˜é™åˆ¶ã€‚å½“å‰çš„ç§’æ€ä»»åŠ¡æ˜¯åŸºäºjdkçš„é˜»å¡é˜Ÿåˆ—å®ç°ï¼Œè¿™ä¸ªé˜»å¡é˜Ÿåˆ—ä½¿ç”¨çš„JVMçš„å†…å­˜ï¼Œå¦‚æœå¯¹é˜»å¡é˜Ÿåˆ—ä¸è¿›è¡Œé™åˆ¶ï¼Œé‚£ä¹ˆé«˜å¹¶å‘æƒ…å†µä¸‹ä¼šæœ‰å¾ˆå¤šè®¢å•å¯¹è±¡åˆ›å»ºå¹¶æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå¯¼è‡´å‡ºç°å†…å­˜æº¢å‡ºçš„é£é™©ã€‚å› æ­¤åˆ›å»ºé˜»å¡é˜Ÿåˆ—æ—¶è¦ä¸ºå…¶è®¾ç½®ä¸€ä¸ªé•¿åº¦ä¸Šé™ï¼Œå¦‚æœé˜Ÿåˆ—å­˜æ»¡ï¼Œé‚£ä¹ˆæ–°çš„è®¢å•å°±æ— æ³•æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚ æ•°æ®å®‰å…¨ï¼ˆJVMå†…å­˜æ²¡æœ‰æŒä¹…åŒ–æœºåˆ¶ï¼‰ã€‚å¦‚æœç³»ç»Ÿå®•æœºå¯¼è‡´å­˜å‚¨åˆ°é˜Ÿåˆ—ä¸­çš„æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆç”¨æˆ·æ”¶åˆ°äº†ä¸‹å•æˆåŠŸæ¶ˆæ¯ï¼Œä½†æ•°æ®åº“ä¸­å´æ²¡æœ‰ï¼Œå¯¼è‡´äº†å‡ºç°ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ æ”¹è¿›ä¸šåŠ¡2ï¼ˆåŸºäºRedisæ¶ˆæ¯é˜Ÿåˆ—å®ç°ç§’æ€ï¼‰åŸºäºæ¶ˆæ¯é˜Ÿåˆ—è§£å†³äº†ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç‹¬ç«‹äºJVMä¹‹å¤–ï¼Œå› æ­¤æ²¡æœ‰å†…å­˜é™åˆ¶ã€‚å¦å¤–ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šå¯¹å­˜æ”¾å…¶ä¸­çš„æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–ï¼Œå¦‚æœæ¶ˆè´¹è€…æ²¡æœ‰å¯¹æ¶ˆæ¯è¿›è¡Œç¡®è®¤ï¼Œåˆ™æ¶ˆæ¯åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸€ç›´å­˜åœ¨ã€‚ä¸‹ä¸€æ¬¡å†æŠ•é€’ç»™æ¶ˆè´¹è€…è®©æ¶ˆè´¹è€…ç»§ç»­å¤„ç†ï¼Œç›´åˆ°æ¶ˆè´¹è€…è¿›è¡Œç¡®è®¤ï¼Œæ‰å°†æ­¤æ¶ˆæ¯è¿›è¡Œç§»é™¤ã€‚ åŸºäºRedisçš„listå®ç°æ¶ˆæ¯é˜Ÿåˆ—Redisçš„listç»“æ„åº•å±‚æ˜¯é€šè¿‡åŒå‘é“¾è¡¨å®ç°çš„ï¼Œå› æ­¤é™åˆ¶ç”Ÿäº§è€…ä»ä¸€è¾¹pushï¼ˆLPUSHå‘½ä»¤ï¼‰ï¼Œè€Œæ¶ˆè´¹è€…ä»å¦ä¸€è¾¹popï¼ˆRPOPå‘½ä»¤ï¼‰ï¼Œå³å®ç°äº†æ¶ˆæ¯é˜Ÿåˆ—çš„æ¨¡å‹ã€‚å¦å¤–ï¼Œå½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å¤„äºé˜»å¡çŠ¶æ€ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨Listçš„BLPOPã€BRPOPå‘½ä»¤ï¼Œå½“listä¸­æ— æ¶ˆæ¯æ—¶ï¼Œä¾¿ä¼šå¤„äºé˜»å¡ç­‰å¾…çš„çŠ¶æ€ã€‚ åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ ä¼˜ç‚¹ï¼š åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™ åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯ å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§ ç¼ºç‚¹ï¼š æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±ï¼ˆæ‰§è¡Œå®ŒBRPOPä¹‹åï¼Œå°±æŠŠæ¶ˆæ¯ä»listä¸­ç§»é™¤ï¼Œå› æ­¤ä»listå–å‡ºæ¶ˆæ¯åå¦‚æœå‡ºç°äº†å¼‚å¸¸ï¼Œæ¶ˆæ¯å°±ä¼šä¸¢å¤±äº†ï¼‰ åªæ”¯æŒå•æ¶ˆè´¹è€…ï¼ˆæ‹¿å‡ºæ¶ˆæ¯åå°±ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå…¶ä»–æ¶ˆè´¹è€…æ‹¿ä¸åˆ°æ¶ˆæ¯ï¼‰ åŸºäºRedisçš„PubSubå®ç°æ¶ˆæ¯é˜Ÿåˆ—PubSubï¼ˆå‘å¸ƒè®¢é˜…ï¼‰æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚SUBSCRIBE channel [channel] ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“ PUBLISH channel msg ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯ PSUBSCRIBE pattern[pattern] ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿä¼˜ç‚¹ï¼š é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹ ç¼ºç‚¹ï¼š ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼ˆRedisçš„æ•°æ®æ˜¯æœ‰æŒä¹…åŒ–æœºåˆ¶ï¼Œä½†PubSubæ˜¯å¦ä¸€ç§å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œå¹¶ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼‰ æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤± æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±ï¼ˆæ¶ˆè´¹è€…æœ‰ç¼“å­˜åŒºåŸŸï¼Œå¦‚æœå¤„ç†ä¸€ä¸ªæ¶ˆæ¯æ—¶æ—¶é—´è¿‡ä¹…ï¼Œå…¶ä»–æ¶ˆæ¯åˆ°è¾¾åå­˜å‚¨åˆ°ç¼“å­˜åŒºä¸­ï¼Œç¼“å­˜åŒºæ»¡äº†åæ¶ˆæ¯å°±ä¼šä¸¢å¤±ï¼‰ åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—Stream æ˜¯ Redis 5.0 å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼ˆæ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼‰ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ å•æ¶ˆè´¹æ¨¡å¼ å‘½ä»¤ ä»‹ç» XADD å‘é˜Ÿåˆ—ä¸­æ·»åŠ æ¶ˆæ¯ XREAD è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ XLEN è¯»å–é˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„é•¿åº¦ å‘é€æ¶ˆæ¯çš„å‘½ä»¤ï¼šä¾‹å¦‚ï¼šè¯»å–æ¶ˆæ¯çš„æ–¹å¼ä¹‹ä¸€ï¼šXREADä¾‹å¦‚ï¼Œä½¿ç”¨XREADè¯»å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼šXREADé˜»å¡æ–¹å¼ï¼Œè¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼šæ·»åŠ åˆ°Stremé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–ï¼Œä¸ä¼šå‡ºç°å…¶ä»–æ¶ˆè´¹è€…è¯»äº†ä¹‹åï¼Œæ¶ˆæ¯å°±ä»é˜Ÿåˆ—ä¸­ä¸¢å¤±æ‰çš„æƒ…å†µã€‚åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ªç¯çš„è°ƒç”¨XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹ ä¸Šè¿°çš„é˜Ÿåˆ—å®ç°å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ æ¶ˆæ¯æ¼è¯»ã€‚æˆ‘ä»¬æŒ‡å®šèµ·å§‹IDä¸º$æ—¶ï¼Œä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæˆ‘ä»¬å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œåˆ™ä¸‹æ¬¡è·å–æ—¶ä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°æ¼è¯»æ¶ˆæ¯çš„é—®é¢˜ã€‚STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ï¼š æ¶ˆæ¯å¯å›æº¯ï¼ˆæ¶ˆæ¯æ·»åŠ åˆ°é˜Ÿåˆ—åä¸ä¼šæ¶ˆå¤±ï¼Œå¯å›çœ‹ï¼‰ ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å– å¯ä»¥é˜»å¡è¯»å– æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™© æ¶ˆè´¹è€…ç»„ å•æ¶ˆè´¹å’Œæ¶ˆè´¹è€…ç»„æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ æ¶ˆè´¹è€…ç»„æ˜¯å°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚ç”¨æ¥è§£å†³æ¶ˆæ¯æ¼è¯»çš„é—®é¢˜ã€‚ç‰¹ç‚¹ï¼š æ¶ˆæ¯åˆ†æµã€‚é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šè¢«åˆ†åˆ°ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼ŒåŠ å¿«äº†æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦ï¼Œé¿å…å‡ºç°æ¶ˆæ¯å †ç§¯çš„æƒ…å†µã€‚ æ¶ˆæ¯æ ‡ç¤ºã€‚æ¶ˆè´¹è€…ç»„ä¸­ç»´æŠ¤äº†ä¸€ä¸ªè®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯çš„æ ‡è¯†ï¼Œé€šè¿‡è¯¥æ ‡è¯†ï¼Œå¯ä»¥ç¡®ä¿æ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹ï¼Œ é¿å…å‡ºç°æ¶ˆæ¯æ¼è¯»çš„æƒ…å†µã€‚ æ¶ˆæ¯ç¡®è®¤ã€‚æ¶ˆè´¹è€…è·å–æ¶ˆæ¯ä¹‹åï¼Œæ¶ˆæ¯ä¼šå¤„äºpendingçŠ¶æ€ï¼Œå¹¶ä¸”å¤„äºpendingçŠ¶æ€çš„æ¶ˆæ¯ä¼šå­˜å…¥åˆ°pending-listä¸­ã€‚å¦‚æœæ¶ˆæ¯å¤„ç†å®Œæ¯•ï¼Œéœ€è¦XACKç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯å·²è¢«å¤„ç†ï¼Œå¹¶ä¼šä»pendinglistä¸­ç§»é™¤ã€‚è¯¥æœºåˆ¶ç¡®ä¿äº†æ¶ˆæ¯è‡³å°‘ä¼šè¢«æ¶ˆè´¹ä¸€æ¬¡ã€‚å¦‚æœRediså®•æœºï¼Œåœ¨æ¢å¤åå¯ä»¥åˆ°pending-listä¸­æ‰¾åˆ°è¿˜æœªå®Œæˆå¤„ç†çš„æ¶ˆæ¯ï¼Œç»§ç»­å¤„ç†ã€‚ åŸºæœ¬å‘½ä»¤åˆ›å»ºæ¶ˆè´¹è€…ç»„ XGROUP CREAT key groupName ID [MKSTREAM] åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„ XGROUP DESTORY key groupName ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€… XGROUP CREATECONSUMER key groupname consumername åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­çš„æŒ‡å®šæ¶ˆè´¹è€… XGROUP DELCONSUMER key groupname consumername ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯ XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...] groupï¼šæ¶ˆè´¹ç»„åç§° consumerï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€… countï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡ BLOCK millisecondsï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´ NOACKï¼šæ— éœ€æ‰‹åŠ¨ACKï¼Œæ¶ˆæ¯æŠ•é€’åˆ°æ¶ˆè´¹è€…åä¼šè‡ªåŠ¨ç¡®è®¤ STREAMS keyï¼šæŒ‡å®šé˜Ÿåˆ—åç§° IDï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹IDï¼š â€œ&gt;â€ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹ï¼ˆæ­£å¸¸æƒ…å†µä¸‹è¯»æœªæ¶ˆè´¹çš„æ¶ˆæ¯ï¼‰ å…¶å®ƒï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹ï¼ˆå‡ºç°å¼‚å¸¸æ—¶ï¼Œä»pending-listä¸­è¯»å–å·²æ¶ˆè´¹ä½†æœªå¤„ç†æˆåŠŸçš„æ¶ˆæ¯ï¼‰ ç¡®è®¤æ¶ˆæ¯ XACK key group ID [ID ...] æ¶ˆè´¹è€…ç»„ç›‘å¬æ¶ˆæ¯æ€è·¯ï¼ˆç¡®ä¿æ¶ˆæ¯è‡³å°‘ä¼šè¢«æ¶ˆè´¹ä¸€æ¬¡ï¼‰ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œç”±æ¶ˆè´¹è€…ç»„æ¥ç›‘å¬é˜Ÿåˆ—ä¸­æœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯ï¼›å¦‚æœç›‘å¬è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œåˆ™åœ¨æ•è·å¼‚å¸¸çš„å¤„ç†é€»è¾‘ä¸­å»å¤„ç†å·²æ¶ˆè´¹ä½†è¿˜æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œå½“è¿™äº›æœªç¡®è®¤çš„æ¶ˆæ¯å¤„ç†å®Œæ¯•åï¼Œå†ç›‘å¬æœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚ä»£ç å®ç°STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤ç‰¹ç‚¹ï¼š æ¶ˆæ¯å¯å›æº¯ å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦ å¯ä»¥é˜»å¡è¯»å– æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©ï¼ˆæœ‰æœ€åä¸€æ¬¡è¢«å¤„ç†æ¶ˆæ¯çš„æ ‡è¯†ï¼Œæ¯æ¬¡è¯»å–æ—¶ï¼Œå¯ä»ä¸Šä¸€æ¬¡æ¶ˆè´¹æ¶ˆæ¯åçš„ä¸€æ¡æ¶ˆæ¯è¯»å–ï¼‰ æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ ä½¿ç”¨Streamé˜Ÿåˆ—è¿˜å­˜åœ¨ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ ä¾èµ–äºRedisæŒä¹…åŒ–ï¼Œä»ç„¶å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±çš„é£é™© Streamåªæ”¯æŒæ¶ˆè´¹è€…ç¡®è®¤ï¼Œå¹¶ä¸æ”¯æŒç”Ÿäº§è€…ç¡®è®¤ï¼Œå› æ­¤å¦‚æœç”Ÿäº§è€…æ¶ˆæ¯ä¸¢å¤±ï¼Œè¿˜éœ€è¦è€ƒè™‘å¦‚ä½•è§£å†³ ä»£ç å®ç°å…·ä½“æ€è·¯ï¼šåœ¨redisé‡Œè¿›è¡Œåº“å­˜åˆ¤æ–­+ä¸€äººä¸€å•åˆ¤æ–­åï¼Œå°†åº“å­˜idã€ç”¨æˆ·idã€è®¢å•idå‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå®Œæˆååˆ¤æ–­æ˜¯å¦å¯ä»¥ä¸‹å•æˆåŠŸï¼Œå¦‚æœå¯ä»¥ï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®ã€‚ç„¶åå¼€å¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹å®Œæˆå¼‚æ­¥ä¸‹å•çš„åŠŸèƒ½ã€‚åœ¨è¿›è¡Œå¼‚æ­¥ä¸‹å•æ—¶ï¼Œå¼€å¯çš„çº¿ç¨‹ä¸€ç›´ç›‘å¬é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚å¦‚æœç›‘å¬åˆ°æ¶ˆæ¯ï¼Œåˆ™æ‰§è¡Œå¤„ç†ï¼Œå¹¶è¿”å›å¯¹è¯¥æ¶ˆæ¯çš„ç¡®è®¤ã€‚å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ï¼Œåˆ™è¦å¤„ç†å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ã€‚luaè„šæœ¬ -- 1.å‚æ•°åˆ—è¡¨ -- 1.1.ä¼˜æƒ åˆ¸id local voucherId = ARGV[1] -- 1.2.ç”¨æˆ·id local userId = ARGV[2] -- 1.3.è®¢å•id local orderId = ARGV[3] -- 2.æ•°æ®key -- 2.1.åº“å­˜key local stockKey = &#39;seckill:stock:&#39; .. voucherId -- 2.2.è®¢å•key local orderKey = &#39;seckill:order:&#39; .. voucherId -- 3.è„šæœ¬ä¸šåŠ¡ -- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey if(tonumber(redis.call(&#39;get&#39;, stockKey)) &lt;= 0) then -- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1 return 1 end -- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId if(redis.call(&#39;sismember&#39;, orderKey, userId) == 1) then -- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2 return 2 end -- 3.4.æ‰£åº“å­˜ incrby stockKey -1 redis.call(&#39;incrby&#39;, stockKey, -1) -- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId redis.call(&#39;sadd&#39;, orderKey, userId) -- 3.6.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œ XADD stream.orders * k1 v1 k2 v2 ... redis.call(&#39;xadd&#39;, &#39;stream.orders&#39;, &#39;*&#39;, &#39;userId&#39;, userId, &#39;voucherId&#39;, voucherId, &#39;id&#39;, orderId) return 0 VoucherOrderServiceImpl private class VoucherOrderHandler implements Runnable { @Override public void run() { while (true) { try { // 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt; List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read( Consumer.from(&quot;g1&quot;, &quot;c1&quot;), StreamReadOptions.empty().count(1).block(Duration.ofSeconds(2)), StreamOffset.create(&quot;stream.orders&quot;, ReadOffset.lastConsumed()) ); // 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º if (list == null || list.isEmpty()) { // å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯ continue; } // è§£ææ•°æ® MapRecord&lt;String, Object, Object&gt; record = list.get(0); Map&lt;Object, Object&gt; value = record.getValue(); VoucherOrder voucherOrder = BeanUtil.fillBeanWithMap(value, new VoucherOrder(), true); // 3.åˆ›å»ºè®¢å• createVoucherOrder(voucherOrder); // 4.ç¡®è®¤æ¶ˆæ¯ XACK stringRedisTemplate.opsForStream().acknowledge(&quot;s1&quot;, &quot;g1&quot;, record.getId()); } catch (Exception e) { log.error(&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;, e); //å¤„ç†å¼‚å¸¸æ¶ˆæ¯ handlePendingList(); } } } private void handlePendingList() { while (true) { try { // 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0 List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read( Consumer.from(&quot;g1&quot;, &quot;c1&quot;), StreamReadOptions.empty().count(1), StreamOffset.create(&quot;stream.orders&quot;, ReadOffset.from(&quot;0&quot;)) ); // 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º if (list == null || list.isEmpty()) { // å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯ break; } // è§£ææ•°æ® MapRecord&lt;String, Object, Object&gt; record = list.get(0); Map&lt;Object, Object&gt; value = record.getValue(); VoucherOrder voucherOrder = BeanUtil.fillBeanWithMap(value, new VoucherOrder(), true); // 3.åˆ›å»ºè®¢å• createVoucherOrder(voucherOrder); // 4.ç¡®è®¤æ¶ˆæ¯ XACK stringRedisTemplate.opsForStream().acknowledge(&quot;s1&quot;, &quot;g1&quot;, record.getId()); } catch (Exception e) { log.error(&quot;å¤„ç†penddingè®¢å•å¼‚å¸¸&quot;, e); try{ Thread.sleep(20); }catch(Exception e){ e.printStackTrace(); } } } } public Result seckillVoucher(Long voucherId) { Long userId = UserHolder.getUser().getId(); long orderId = redisIdWorker.nextId(&quot;order&quot;); // 1.æ‰§è¡Œluaè„šæœ¬ Long result = stringRedisTemplate.execute( SECKILL_SCRIPT, Collections.emptyList(), voucherId.toString(), userId.toString(), String.valueOf(orderId) ); int r = result.intValue(); // 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0 if (r != 0) { // 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼ return Result.fail(r == 1 ? &quot;åº“å­˜ä¸è¶³&quot; : &quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;); } // 3.è¿”å›è®¢å•id return Result.ok(orderId); } } å¹¶å‘æµ‹è¯• ä¸ƒã€è¾¾äººæ¢åº—æ•°æ®è¡¨tb_blogï¼ˆæ¢åº—ç¬”è®°è¡¨ï¼‰tb_blog_comments æ¥å£ ä»‹ç» è¿”å›å€¼ /blog å‘å¸ƒæ¢åº—ç¬”è®°æ¥å£ /blog/{id} æŸ¥çœ‹æ¢åº—ç¬”è®°æ¥å£ ç¬”è®°ä¿¡æ¯+ç”¨æˆ·ä¿¡æ¯ /blog/like/id ç‚¹èµæ¢åº—ç¬”è®°æ¥å£ /blog/likes/{id} ç‚¹èµæ¢åº—ç¬”è®°åˆ—è¡¨æ¥å£ å‘å¸ƒæ¢åº—ç¬”è®°ä¸Šä¼ ç…§ç‰‡å’Œå‘å¸ƒå›¾æ–‡æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¥å£ï¼Œç”¨æˆ·éœ€è¦ä¸Šä¼ å›¾ç‰‡æ—¶è°ƒç”¨ä¸Šä¼ å›¾ç‰‡çš„æ¥å£ï¼Œç„¶åæ¥å£ä¼šè¿”å›å›¾ç‰‡çš„åç§°ä¿¡æ¯ã€‚åé¢è°ƒç”¨å‘å¸ƒç¬”è®°çš„æ¥å£æ—¶ï¼Œä¼šæŠŠå›¾ç‰‡çš„åç§°ä¼ åˆ°æ¥å£ä¸­ã€‚ æŸ¥çœ‹æ¢åº—ç¬”è®° ç‚¹èµæ¢åº—ç¬”è®° å®ç°1@GetMapping(&quot;/likes/{id}&quot;) public Result queryBlogLikes(@PathVariable(&quot;id&quot;) Long id) { //ä¿®æ”¹ç‚¹èµæ•°é‡ blogService.update().setSql(&quot;liked = liked +1 &quot;).eq(&quot;id&quot;,id).update(); return Result.ok(); } é—®é¢˜ï¼šæ²¡æœ‰å¯¹ç‚¹èµé‡è¿›è¡Œé™åˆ¶ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥ä¸ºåŒä¸€ç¯‡æ¢åº—ç¬”è®°ç‚¹å¤šä¸ªèµ å®ç°2éœ€æ±‚ï¼š åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤ºï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„isLikeå±æ€§ï¼‰ å®ç°æ­¥éª¤ï¼š ç»™Blogç±»ä¸­æ·»åŠ ä¸€ä¸ªisLikeå­—æ®µï¼Œæ ‡ç¤ºæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµ ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisçš„seté›†åˆåˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµè¿‡åˆ™ç‚¹èµæ•°+1ï¼Œå·²ç‚¹èµè¿‡åˆ™ç‚¹èµæ•°-1 ä¿®æ”¹æ ¹æ®idæŸ¥è¯¢Blogçš„ä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç‚¹è¿‡èµçš„æ€è·¯æœ‰å“ªäº›ï¼Ÿ å»ºç«‹ä¸€ä¸ªç‚¹èµè¡¨ï¼Œé‡Œé¢åŒ…æ‹¬Blog IDä»¥åŠUser IDï¼Œå½“è¦åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹è¿‡èµï¼Œåˆ™æ ¹æ®Blog IDå’ŒUser IDåˆ°æ•°æ®åº“ä¸­å»æŸ¥è¯¢ã€‚ï¼ˆæ•°æ®åº“å‹åŠ›å¤§ã€ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œå¯¼è‡´æ€§èƒ½ä½ï¼‰ ä½¿ç”¨Redisçš„seté›†åˆ ä»£ç å®ç°ï¼š åœ¨Blogä¸­æ·»åŠ isLikeå­—æ®µ @TableField(exist = false) private Boolean isLike; ä¿®æ”¹ä»£ç  @Override public Result likeBlog(Long id){ // 1.è·å–ç™»å½•ç”¨æˆ· Long userId = UserHolder.getUser().getId(); // 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ String key = BLOG_LIKED_KEY + id; Boolean isMember = stringRedisTemplate.opsForSet().isMember(key, userId.toString()); if(BooleanUtil.isFalse(isMember)){ //3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ //3.1 æ•°æ®åº“ç‚¹èµæ•°+1 boolean isSuccess = update().setSql(&quot;liked = liked + 1&quot;).eq(&quot;id&quot;, id).update(); //3.2 ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ if(isSuccess){ stringRedisTemplate.opsForSet().add(key,userId.toString()); } }else{ //4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ //4.1 æ•°æ®åº“ç‚¹èµæ•°-1 boolean isSuccess = update().setSql(&quot;liked = liked - 1&quot;).eq(&quot;id&quot;, id).update(); //4.2 æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤ if(isSuccess){ stringRedisTemplate.opsForSet().remove(key,userId.toString()); } } ç‚¹èµæ’è¡Œæ¦œ(è¶Šæ—©è¶Šé å‰) æ€è€ƒï¼šç‚¹èµçš„ä¿¡æ¯éƒ½ä¿å­˜åœ¨äº†Redisä¸­ï¼Œé‚£Rediså®•æœºäº†ï¼Œç‚¹èµä¿¡æ¯ä¸¢å¤±äº†æ€ä¹ˆåŠï¼Ÿï¼ˆRedisæ•°æ®æŒä¹…åŒ–ï¼‰ å¯ä»¥éš”ä¸€å®šæ—¶é—´å°±å°†Redisä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œé˜²æ­¢Rediså®•æœºæ•°æ®å…¨éƒ¨ä¸¢å¤±ã€‚Redisä¸­æä¾›saveä»¥åŠbgsaveæŒ‡ä»¤æ¥ç”ŸæˆRDBæ–‡ä»¶ï¼ŒäºŒè€…çš„ä¸»è¦åŒºåˆ«æ˜¯ç”ŸæˆRDBæ–‡ä»¶çš„ä»»åŠ¡æ˜¯å¦æ˜¯äº¤ç”±ä¸»çº¿ç¨‹æ¥æ‰§è¡Œã€‚ æ‰§è¡Œäº† save å‘½ä»¤ï¼Œå°±ä¼šåœ¨ä¸»çº¿ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç”±äºå’Œæ‰§è¡Œæ“ä½œå‘½ä»¤åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥å¦‚æœå†™å…¥ RDB æ–‡ä»¶çš„æ—¶é—´å¤ªé•¿ï¼Œä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼› æ‰§è¡Œäº† bgsave å‘½ä»¤ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸»çº¿ç¨‹çš„é˜»å¡ï¼› å¦å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œè®©Redisæ¯ä¸ªä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡bgsaveæŒ‡ä»¤ save 900 1 save 300 10 save 60 10000 // åªè¦æ»¡è¶³ä¸Šé¢æ¡ä»¶çš„ä»»æ„ä¸€ä¸ªï¼Œå°±ä¼šæ‰§è¡Œ bgsaveï¼Œå®ƒä»¬çš„æ„æ€åˆ†åˆ«æ˜¯ï¼š // 900 ç§’ä¹‹å†…ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œäº†è‡³å°‘ 1 æ¬¡ä¿®æ”¹ï¼› // 300 ç§’ä¹‹å†…ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œäº†è‡³å°‘ 10 æ¬¡ä¿®æ”¹ï¼› // 60 ç§’ä¹‹å†…ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œäº†è‡³å°‘ 10000 æ¬¡ä¿®æ”¹ã€‚ é€šå¸¸å¯èƒ½è®¾ç½®è‡³å°‘ 5 åˆ†é’Ÿæ‰ä¿å­˜ä¸€æ¬¡å¿«ç…§ï¼Œè¿™æ—¶å¦‚æœ Redis å‡ºç°å®•æœºç­‰æƒ…å†µï¼Œåˆ™æ„å‘³ç€æœ€å¤šå¯èƒ½ä¸¢å¤± 5 åˆ†é’Ÿæ•°æ®ã€‚è¿™å°±æ˜¯ RDB å¿«ç…§çš„ç¼ºç‚¹ï¼Œåœ¨æœåŠ¡å™¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œä¸¢å¤±çš„æ•°æ®ä¼šæ¯” AOF æŒä¹…åŒ–çš„æ–¹å¼æ›´å¤šï¼Œå› ä¸º RDB å¿«ç…§æ˜¯å…¨é‡å¿«ç…§çš„æ–¹å¼ï¼Œå› æ­¤æ‰§è¡Œçš„é¢‘ç‡ä¸èƒ½å¤ªé¢‘ç¹ï¼Œå¦åˆ™ä¼šå½±å“ Redis æ€§èƒ½ï¼Œè€Œ AOF æ—¥å¿—å¯ä»¥ä»¥ç§’çº§çš„æ–¹å¼è®°å½•æ“ä½œå‘½ä»¤ï¼Œæ‰€ä»¥ä¸¢å¤±çš„æ•°æ®å°±ç›¸å¯¹æ›´å°‘ã€‚ å¯¹äºRedisä¸­å¯ä»¥ç”¨åšç‚¹èµåˆ—è¡¨çš„æ•°æ®ç±»å‹åˆ†æListåº•å±‚æ˜¯é“¾è¡¨ï¼Œå› æ­¤å¦‚æœå‘Listä¸­é€šè¿‡RPUSHæ·»åŠ ç‚¹èµç”¨æˆ·ï¼Œé€šè¿‡LINDEXè·å–åˆ—è¡¨å¤´éƒ¨å…ƒç´ ï¼Œå°±å®ç°äº†ç‚¹èµåˆ—è¡¨æ’åºåŠŸèƒ½ã€‚ä½†LIstå…ƒç´ ä¸ä¿è¯å”¯ä¸€ï¼Œä¸”ç”±äºåº•å±‚æ˜¯é“¾è¡¨ï¼Œå› æ­¤åªèƒ½é€šè¿‡ç´¢å¼•è·å–å…ƒç´ ã€‚å¦‚æœæƒ³é€šè¿‡å…ƒç´ è¿›è¡ŒæŸ¥æ‰¾ï¼Œé‚£éœ€è¦éå†é“¾è¡¨ã€‚å› æ­¤Listå¹¶ä¸é€‚åˆç”¨ä½œç‚¹èµåˆ—è¡¨ã€‚Setå’ŒSortedSetåº•å±‚æ˜¯å“ˆå¸Œè¡¨ï¼Œå®ƒä»¬å¯ä»¥æ ¹æ®å…ƒç´ æ¥å¿«é€Ÿå®šä½åˆ°æŒ‡å®šä½ç½®ã€‚ç”±äºSortedSetä¼šä¸ºæ¯ä¸€ä¸ªå…ƒç´ å…³è”ä¸€ä¸ªåˆ†æ•°ï¼Œå› æ­¤å¦‚æœè¦å®ç°æ’åºåŠŸèƒ½çš„è¯ï¼Œéœ€è¦ä½¿ç”¨SortedSetã€‚ç”±äºä¸šåŠ¡ä¸­æƒ³æ˜¾ç¤ºç‚¹èµæ—¶é—´æœ€é å‰çš„äº”ä½ç”¨æˆ·ï¼Œå› æ­¤å¯ä»¥ç”¨æ—¶é—´æˆ³ä½œä¸ºåˆ†æ•°ï¼ˆæ—¶é—´æˆ³å¤©ç„¶å‡åºï¼‰ã€‚ æŒ‡ä»¤ æè¿° ZSCORE key member è·å–æŒ‡å®šå…ƒç´ çš„scoreï¼Œå…ƒç´ å­˜åœ¨è¿”å›scoreï¼Œå…ƒç´ ä¸å­˜åœ¨è¿”å›nil ZRANGE key min max è¿”å›SortedSetä¸­æŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ï¼Œå…¶ä¸­æˆå‘˜æŒ‰ä»å°åˆ°å¤§æ’åº ä¿®æ”¹ä¸šåŠ¡ä»£ç 1ç‚¹èµä»£ç ï¼ˆå°†Setæ›¿æ¢ä¸ºZSetï¼Œç”±äºZSetä¸­æ²¡æœ‰isMemberæŒ‡ä»¤ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ZSCOREæŒ‡ä»¤æ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼‰ @Override public Result likeBlog(Long id) { // 1.è·å–ç™»å½•ç”¨æˆ· Long userId = UserHolder.getUser().getId(); // 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ String key = BLOG_LIKED_KEY + id; Double score = stringRedisTemplate.opsForZSet().score(key, userId.toString()); if (score == null) { // 3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ // 3.1.æ•°æ®åº“ç‚¹èµæ•° + 1 boolean isSuccess = update().setSql(&quot;liked = liked + 1&quot;).eq(&quot;id&quot;, id).update(); // 3.2.ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ zadd key value score if (isSuccess) { stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis()); } } else { // 4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ // 4.1.æ•°æ®åº“ç‚¹èµæ•° -1 boolean isSuccess = update().setSql(&quot;liked = liked - 1&quot;).eq(&quot;id&quot;, id).update(); // 4.2.æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤ if (isSuccess) { stringRedisTemplate.opsForZSet().remove(key, userId.toString()); } } return Result.ok(); } private void isBlogLiked(Blog blog) { // 1.è·å–ç™»å½•ç”¨æˆ· UserDTO user = UserHolder.getUser(); if (user == null) { // ç”¨æˆ·æœªç™»å½•ï¼Œæ— éœ€æŸ¥è¯¢æ˜¯å¦ç‚¹èµ return; } Long userId = user.getId(); // 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ String key = &quot;blog:liked:&quot; + blog.getId(); Double score = stringRedisTemplate.opsForZSet().score(key, userId.toString()); blog.setIsLike(score != null); } ç‚¹èµåˆ—è¡¨æŸ¥è¯¢ä»£ç BlogController @GetMapping(&quot;/likes/{id}&quot;) public Result queryBlogLikes(@PathVariable(&quot;id&quot;) Long id) { return blogService.queryBlogLikes(id); } BlogService @Override public Result queryBlogLikes(Long id) { String key = BLOG_LIKED_KEY + id; // 1.æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ· zrange key 0 4 Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, 0, 4); if (top5 == null || top5.isEmpty()) { return Result.ok(Collections.emptyList()); } // 2.è§£æå‡ºå…¶ä¸­çš„ç”¨æˆ·id List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList()); //select ... from tb_user where id in (?,?) List&lt;UserDTO&gt; userDTOS = userService.listByIds(ids) .stream() .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class)) .collect(Collectors.toList()); // 4.è¿”å› return Result.ok(userDTOS); } æµ‹è¯•(ç‚¹èµå¹¶æœªå¦‚é¢„æœŸçš„æŒ‰ç…§æ—¶é—´æˆ³ä»å°åˆ°å¤§æ’åˆ—)é¢„æƒ³ç»“æœï¼šæŒ‰æ—¶é—´æˆ³ç”±å°åˆ°å¤§è¿›è¡Œæ’åˆ—ï¼Œå…ˆç‚¹èµçš„åœ¨å‰ï¼Œåç‚¹èµçš„åœ¨åï¼Œå³ç‚¹èµåè“è‰²å¤´åƒæ’åœ¨é»„è‰²å¤´åƒä¹‹åã€‚åˆ†æåŸå› ï¼š **æŸ¥çœ‹æ¥å£è¿”å›çš„å“åº”ä¿¡æ¯ **è¿”å›ç»“æœçš„é¡ºåºå‡ºç°é”™è¯¯ï¼Œå½“å‰ç™»å½•ç”¨æˆ·ä¸ºå°é±¼åŒå­¦ï¼Œå°é±¼åŒå­¦ç‚¹èµååº”æ’åœ¨ç¬¬äºŒä½ï¼Œä½†å®é™…ä¸Šå´æ’åœ¨äº†ç¬¬ä¸€ä½ã€‚ **åˆ†æä½¿ç”¨Mybatisè¿›è¡ŒæŸ¥è¯¢æ—¶ä¼ å…¥çš„å‚æ•°æ˜¯å¦æ­£ç¡® ä¼ å…¥çš„å‚æ•°å…ˆ5å†1ç¬¦åˆé¢„æœŸ **æ£€æŸ¥SQLè¯­å¥ï¼ˆè¿™é‡Œå‡ºç°é”™è¯¯ï¼‰ ä½¿ç”¨inæŸ¥è¯¢ï¼Œä¼ å…¥çš„é¡ºåºæ˜¯5,1ï¼Œä½†æŸ¥å‡ºçš„é¡ºåºæ˜¯1,5ã€‚ **è§£å†³ï¼šé€šè¿‡Order by filed é€šè¿‡æ‰‹åŠ¨æŒ‡å®šidçš„é¡ºåºæ¥å¯¹å…¶è¿›è¡Œé™åˆ¶ ä¿®æ”¹ä¸šåŠ¡ä»£ç 2@Override public Result queryBlogLikes(Long id) { String key = BLOG_LIKED_KEY + id; // 1.æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ· zrange key 0 4 Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, 0, 4); if (top5 == null || top5.isEmpty()) { return Result.ok(Collections.emptyList()); } // 2.è§£æå‡ºå…¶ä¸­çš„ç”¨æˆ·id List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList()); String idStr = StrUtil.join(&quot;,&quot;, ids); // 3.æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ· WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1) List&lt;UserDTO&gt; userDTOS = userService.query() .in(&quot;id&quot;, ids).last(&quot;ORDER BY FIELD(id,&quot; + idStr + &quot;)&quot;).list() .stream() .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class)) .collect(Collectors.toList()); // 4.è¿”å› return Result.ok(userDTOS); } ç»“æœ å…«ã€å¥½å‹å…³æ³¨æ¥å£ æ¥å£ æè¿° å‚æ•° å“åº” /follow/1/true å…³æ³¨/å–å…³ç”¨æˆ· 1ï¼šè¢«å…³æ³¨ç”¨æˆ·id trueï¼šå…³æ³¨ falseï¼šå–æ¶ˆå…³æ³¨ /follow/or/not/1 æ˜¯å¦å…³æ³¨ç”¨æˆ· 1ï¼šè¢«å…³æ³¨ç”¨æˆ·id trueï¼šæœªå…³æ³¨è¦è¿›è¡Œå…³æ³¨ falseï¼šå·²å…³æ³¨ æ•°æ®è¡¨ å…³æ³¨å’Œå–å…³é¦–å…ˆå½“ç‚¹è¿›åšå®¢æ—¶é¦–å…ˆä¼šåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å…³æ³¨äº†åšä¸»æŸ¥è¯¢ç»“æœæœªå…³æ³¨ï¼Œåˆ™å‰ç«¯æŒ‰é”®ä¼šæ˜¾ç¤ºå…³æ³¨æŒ‰é’®ç‚¹å‡»å‘èµ·å…³æ³¨è¯·æ±‚æ—¶ï¼Œä¼ å‚ä¸ºtrueï¼Œè¡¨ç¤ºè¦è¿›è¡Œå…³æ³¨ ä»£ç å®ç°FollowController //å…³æ³¨ @PutMapping(&quot;/{id}/{isFollow}&quot;) public Result follow(@PathVariable(&quot;id&quot;) Long followUserId, @PathVariable(&quot;isFollow&quot;) Boolean isFollow) { return followService.follow(followUserId, isFollow); } //å–æ¶ˆå…³æ³¨ @GetMapping(&quot;/or/not/{id}&quot;) public Result isFollow(@PathVariable(&quot;id&quot;) Long followUserId) { return followService.isFollow(followUserId); } FollowService // å–æ¶ˆå…³æ³¨service @Override public Result isFollow(Long followUserId) { // 1.è·å–ç™»å½•ç”¨æˆ· Long userId = UserHolder.getUser().getId(); // 2.æŸ¥è¯¢æ˜¯å¦å…³æ³¨ select count(*) from tb_follow where user_id = ? and follow_user_id = ? Integer count = query().eq(&quot;user_id&quot;, userId).eq(&quot;follow_user_id&quot;, followUserId).count(); // 3.åˆ¤æ–­ return Result.ok(count &gt; 0); } // å…³æ³¨service @Override public Result follow(Long followUserId, Boolean isFollow) { // 1.è·å–ç™»å½•ç”¨æˆ· Long userId = UserHolder.getUser().getId(); String key = &quot;follows:&quot; + userId; // 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³ if (isFollow) { // 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ® Follow follow = new Follow(); follow.setUserId(userId); follow.setFollowUserId(followUserId); boolean isSuccess = save(follow); } else { // 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ? remove(new QueryWrapper&lt;Follow&gt;() .eq(&quot;user_id&quot;, userId).eq(&quot;follow_user_id&quot;, followUserId)); } return Result.ok(); } å…±åŒå…³æ³¨åˆ†æï¼šå…±åŒå…³æ³¨å³æ‰¾åˆ°äº†åšä¸»å’Œç™»å½•ç”¨æˆ·å…³æ³¨åˆ—è¡¨çš„äº¤é›†ï¼Œåœ¨Redisä¸­çš„seté›†åˆä¸­æœ‰SINTERæŒ‡ä»¤æ¥å¾—åˆ°å¤šä¸ªkeyçš„äº¤é›†ã€‚ä¸šåŠ¡ä»£ç æ”¹è¿›ï¼šç”±äºä¹‹å‰åœ¨å…³æ³¨å’Œå–æ¶ˆæ—¶ï¼ŒåªæŠŠæ•°æ®ä¿å­˜åˆ°äº†æ•°æ®åº“ä¸­ï¼Œå› æ­¤ç°åœ¨éœ€è¦æ”¹è¿›ä¸šåŠ¡ä»£ç ï¼ŒæŠŠç”¨æˆ·åŠç”¨æˆ·å…³æ³¨ä»¥keyï¼ˆå½“å‰ç”¨æˆ·idï¼‰ï¼Œvalue(set)çš„å½¢å¼ä¿å­˜è‡³Redisä¸­ã€‚ @Override public Result follow(Long followUserId, Boolean isFollow) { // 1.è·å–ç™»å½•ç”¨æˆ· Long userId = UserHolder.getUser().getId(); String key = &quot;follows:&quot; + userId; // 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³ if (isFollow) { // 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ® Follow follow = new Follow(); follow.setUserId(userId); follow.setFollowUserId(followUserId); boolean isSuccess = save(follow); if (isSuccess) { // æŠŠå…³æ³¨ç”¨æˆ·çš„idï¼Œæ”¾å…¥redisçš„seté›†åˆ sadd userId followerUserId stringRedisTemplate.opsForSet().add(key, followUserId.toString()); } } else { // 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ? boolean isSuccess = remove(new QueryWrapper&lt;Follow&gt;() .eq(&quot;user_id&quot;, userId).eq(&quot;follow_user_id&quot;, followUserId)); if (isSuccess) { // æŠŠå…³æ³¨ç”¨æˆ·çš„idä»Redisé›†åˆä¸­ç§»é™¤ stringRedisTemplate.opsForSet().remove(key, followUserId.toString()); } } return Result.ok(); } è·å–å¤šä¸ªseté›†åˆçš„äº¤é›† @Override public Result followCommons(Long id) { // 1.è·å–å½“å‰ç”¨æˆ· Long userId = UserHolder.getUser().getId(); String key = &quot;follows:&quot; + userId; // 2.æ±‚äº¤é›† String key2 = &quot;follows:&quot; + id; Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2); if (intersect == null || intersect.isEmpty()) { // æ— äº¤é›† return Result.ok(Collections.emptyList()); } // 3.è§£æidé›†åˆ List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList()); // 4.æŸ¥è¯¢ç”¨æˆ· List&lt;UserDTO&gt; users = userService.listByIds(ids) .stream() .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class)) .collect(Collectors.toList()); return Result.ok(users); } æ•ˆæœå±•ç¤º å…³æ³¨æ¨é€ï¼ˆFeedæµï¼‰Feedæµçš„å®ç°æœ‰ä¸¤ç§æ¨¡å¼ï¼š Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ã€‚å¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½ æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½èµ·åˆ°åä½œç”¨ æœ¬é¡¹ç›®ä¸­çš„ä¸ªäººé¡µé¢ï¼Œæ˜¯åŸºäºå…³æ³¨çš„å¥½å‹æ¥åšFeedæµï¼Œå› æ­¤ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ **æ‹‰æ¨¡å¼ æ¯ä¸ªç”¨æˆ·å‘äº†Blogä¹‹åï¼Œéƒ½ä¼šæŠŠæ¶ˆæ¯å­˜å…¥åˆ°å…¶å¯¹åº”çš„å‘ä»¶ç®±ä¸­ã€‚ç²‰ä¸åªæœ‰åœ¨æµè§ˆæ—¶æ‰ä¼šæŠŠå…³æ³¨åšä¸»çš„Blogä¿¡æ¯æ¨é€åˆ°è‡ªå·±çš„æ”¶ä»¶ç®±ä¸­ã€‚ ä¼˜ç‚¹ï¼šèŠ‚çº¦ç©ºé—´ï¼Œå› ä¸ºèµµå…­åœ¨è¯»ä¿¡æ¯æ—¶ï¼Œå¹¶æ²¡æœ‰é‡å¤è¯»å–ï¼Œè€Œä¸”è¯»å–å®Œä¹‹åå¯ä»¥æŠŠä»–çš„æ”¶ä»¶ç®±è¿›è¡Œæ¸…é™¤ã€‚ ç¼ºç‚¹ï¼šå»¶è¿Ÿï¼Œå½“ç”¨æˆ·è¯»å–æ•°æ®æ—¶æ‰å»å…³æ³¨çš„äººé‡Œè¾¹å»è¯»å–æ•°æ®ï¼Œå‡è®¾ç”¨æˆ·å…³æ³¨äº†å¤§é‡çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šæ‹‰å–æµ·é‡çš„å†…å®¹ï¼Œå¯¹æœåŠ¡å™¨å‹åŠ›å·¨å¤§ã€‚ æ¨æ¨¡å¼ç”¨æˆ·æ²¡æœ‰å‘ä»¶ç®±ï¼Œåªæœ‰æ”¶ä»¶ç®±ã€‚å½“ç”¨æˆ·å‘äº†æ¶ˆæ¯ä¹‹åï¼Œå°†æ¶ˆæ¯æ¨é€åˆ°æ‰€æœ‰ç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ã€‚ä¼˜ç‚¹ï¼šæ—¶æ•ˆå¿«ï¼Œä¸ç”¨ä¸´æ—¶æ‹‰å–ã€‚ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œå‡è®¾ä¸€ä¸ªå¤§Vå†™ä¿¡æ¯ï¼Œå¾ˆå¤šäººå…³æ³¨ä»–ï¼Œ å°±ä¼šå†™å¾ˆå¤šæ•°æ®åˆ°æ¯ä¸ªç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ã€‚ **æ¨æ‹‰ç»“åˆ **æ¨æ‹‰æ¨¡å¼å°†ç”¨æˆ·åˆ†ä¸ºå¤§Vå’Œæ™®é€šç”¨æˆ·ï¼Œå°†ç²‰ä¸åˆ†ä¸ºæ´»è·ƒç²‰ä¸å’Œæ™®é€šç²‰ä¸ã€‚å¯¹äºæ™®é€šç”¨æˆ·æ¥è¯´ï¼Œç”±äºå…¶ç²‰ä¸æ•°é‡è¾ƒå°‘ï¼Œå› æ­¤ä½¿ç”¨æ¨æ¨¡å¼ï¼Œåœ¨å‘é€æ¶ˆæ¯æ—¶å¹¶æ²¡æœ‰ä½¿ç”¨å‘ä»¶ç®±ï¼Œè€Œæ˜¯å°†æ¶ˆæ¯ç›´æ¥å‘é€åˆ°æ¯ä¸ªç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ã€‚å¯¹äºå¤§Vç”¨æˆ·æ¥è¯´ï¼Œå…¶ç²‰ä¸ä½“é‡è¾ƒå¤§ï¼Œä½†ç²‰ä¸ä¸­ç»å¤§å¤šæ•°ä¸ºæ™®é€šç²‰ä¸ï¼Œæ´»è·ƒç²‰ä¸å æ¯”è¾ƒå°‘ã€‚å› æ­¤å¯¹äºæ´»è·ƒç²‰ä¸é‡‡å–æ¨æ¨¡å¼ï¼Œè€Œå¯¹äºä¸ç»å¸¸ä¸Šçº¿çš„æ™®é€šç²‰ä¸ä½¿ç”¨æ‹‰æ¨¡å¼ï¼Œåªæœ‰ç²‰ä¸ä¸Šçº¿éœ€è¦æµè§ˆæ¶ˆæ¯æ—¶æ‰ä»å¤§Vçš„å‘ä»¶ç®±ä¸­æ‹‰å»æ¶ˆæ¯åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ã€‚ ä¸šåŠ¡åˆ†æéœ€æ±‚ï¼š ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®± æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ç”¨Redisçš„æ•°æ®ç»“æ„å®ç° æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢ è¦æ±‚æ¨é€åˆ°æ”¶ä»¶ç®±çš„blogä¿¡æ¯æŒ‰ç…§æ—¶é—´æˆ³æ’åºï¼Œé‚£ä¹ˆRedisä¸­çš„Listå’ŒZSetéƒ½èƒ½æ»¡è¶³è¿™ä¸ªéœ€æ±‚ã€‚è¦æ±‚æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢ã€‚Liståº•å±‚æ˜¯é“¾è¡¨ï¼Œå› æ­¤æ˜¯æœ‰è§’æ ‡çš„ã€‚å¯ä»¥é€šè¿‡Listä¸­çš„LRANGE key start topæ¥è·å–æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ã€‚è€ŒZSetè™½ç„¶æ²¡æœ‰è§’æ ‡ï¼Œä½†æ˜¯åœ¨ZSetä¸­æœ‰æ’åï¼Œå› æ­¤å¯ä»¥é€šè¿‡ZRANGE key start topæ¥è·å–æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ã€‚é‚£è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼ŸFeedæµçš„åˆ†é¡µé—®é¢˜Feedæµçš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œç”±äºæˆ‘ä»¬æ¯æ¬¡å¸Œæœ›è¯»å–æœ€æ–°æ•°æ®ï¼Œä»æœ€æ–°æ•°æ®è¯»å–æ—¶ï¼Œæ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œè¿™ä¼šå¯¼è‡´è¯»å–åˆ°é‡å¤çš„æ•°æ®ã€‚å› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚æ¨¡æ‹ŸæŒ‰è„šæ ‡æŸ¥è¯¢ï¼Œè¯»å–åˆ°äº†é‡å¤æ•°æ®è§£å†³è®¾ç½®ä¸€ä¸ªlastè®°å½•ä¸Šä¸€æ¬¡åˆ†é¡µçš„ä½ç½®æ€»ç»“List åªæ”¯æŒè§’æ ‡æŸ¥è¯¢ï¼Œä¸€æ—¦æ’å…¥äº†æ–°æ•°æ®ï¼Œè§’æ ‡å°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤ä¸æ”¯æŒæ»šåŠ¨åˆ†é¡µã€‚å¦‚æœZSetæŒ‰ç…§æ’åæŸ¥è¯¢ï¼ˆè§’æ ‡ï¼‰ï¼Œå’ŒListä¸€æ ·ä¹Ÿä¸æ”¯æŒæ»šåŠ¨åˆ†é¡µã€‚ä½†æ˜¯ZSetè¿˜æ”¯æŒæŒ‰scoreå€¼çš„èŒƒå›´è¿›è¡ŒæŸ¥è¯¢ï¼Œå°†scoreæŒ‰ä»å¤§åˆ°å°è¿›è¡Œæ’åˆ—ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½è®°å½•æœ€å°æ—¶é—´æˆ³ï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶æ‰¾åˆ°æ¯”è¿™ä¸ªæ—¶é—´æˆ³æ›´å°çš„ï¼Œä»è€Œå®ç°æ»šåŠ¨åˆ†é¡µã€‚é€šè¿‡ZRANGEBYSCORE key max minå®ç° æ€è€ƒï¼šé€šè¿‡ZRANGEBYSCORE key max minå®ç°ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ ZRANGEBYSCORE z1 1000 0 withscores limit 0 3ï¼Œå®ƒè¡¨ç¤ºåœ¨è¿›è¡ŒæŸ¥è¯¢æ—¶ä»z1çš„setä¸­æŸ¥è¯¢ä»1000å¼€å§‹çš„ç¬¬1æ¡è®°å½•ï¼ˆåŒ…å«ï¼‰çš„ä¸‰æ¡æ•°æ®ZRANGEBYSCORE z1 6 0 withscores limit 1 3ï¼Œå®ƒè¡¨ç¤ºåœ¨è¿›è¡ŒæŸ¥è¯¢æ—¶ä»z1çš„setä¸­æŸ¥è¯¢ä»6å¼€å§‹çš„ç¬¬ä¸€æ¡è®°å½•åï¼ˆä¸åŒ…å«ï¼‰ä¸‰æ¡æ•°æ®ã€‚å› æ­¤å¦‚æœå¤šä¸ªç”¨æˆ·åˆ†æ•°ç›¸åŒï¼Œå¦‚æœå›ºå®šoffsetä¸º1ï¼Œå®ƒåªä¼šç•¥è¿‡ä¸€æ¡åˆ†æ•°ä¸º6çš„è®°å½•ï¼Œå› æ­¤è¿˜æ˜¯ä¼šå‡ºç°é‡å¤é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé™¤äº†éœ€è¦è®°å½•ä¸Šä¸€æ¬¡åˆ†é¡µçš„æœ€å°å€¼åˆ†æ•°å¤–ï¼Œè¿˜éœ€è¦è®°å½•æœ‰å¤šå°‘ä¸ªæœ€å°å€¼åˆ†æ•°ï¼Œå¹¶æŠŠå®ƒä½œä¸ºlimitçš„offsetå‚æ•°ã€‚ ä»£ç å®ç°ï¼ˆFeedæµ+Sortedsetæ»šåŠ¨åˆ†é¡µï¼‰æ”¹é€ ä»£ç ï¼Œå½“ç”¨æˆ·ä¿å­˜Blogåï¼Œå°†Blogä¿¡æ¯æ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ @Override public Result saveBlog(Blog blog) { // 1.è·å–ç™»å½•ç”¨æˆ· UserDTO user = UserHolder.getUser(); blog.setUserId(user.getId()); // 2.ä¿å­˜æ¢åº—ç¬”è®° boolean isSuccess = save(blog); if(!isSuccess){ return Result.fail(&quot;æ–°å¢ç¬”è®°å¤±è´¥!&quot;); } // 3.æŸ¥è¯¢ç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸ select * from tb_follow where follow_user_id = ? List&lt;Follow&gt; follows = followService.query().eq(&quot;follow_user_id&quot;, user.getId()).list(); // 4.æ¨é€ç¬”è®°idç»™æ‰€æœ‰ç²‰ä¸ for (Follow follow : follows) { // 4.1.è·å–ç²‰ä¸id Long userId = follow.getUserId(); // 4.2.æ¨é€ String key = FEED_KEY + userId; stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis()); } // 5.è¿”å›id return Result.ok(blog.getId()); } ä»æ”¶ä»¶ç®±ä¸­åˆ†é¡µæŸ¥è¯¢æ¨é€Blogä¿¡æ¯ @Data public class ScrollResult { private List&lt;?&gt; list; private Long minTime; private Integer offset; } @GetMapping(&quot;/of/follow&quot;) public Result queryBlogOfFollow( @RequestParam(&quot;lastId&quot;) Long max, @RequestParam(value = &quot;offset&quot;, defaultValue = &quot;0&quot;) Integer offset){ return blogService.queryBlogOfFollow(max, offset); } @Override public Result queryBlogOfFollow(Long max, Integer offset) { // 1.è·å–å½“å‰ç”¨æˆ· Long userId = UserHolder.getUser().getId(); // 2.æŸ¥è¯¢æ”¶ä»¶ç®± ZREVRANGEBYSCORE key Max Min LIMIT offset count String key = FEED_KEY + userId; Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet() .reverseRangeByScoreWithScores(key, 0, max, offset, 2); // 3.éç©ºåˆ¤æ–­ if (typedTuples == null || typedTuples.isEmpty()) { return Result.ok(); } // 4.è§£ææ•°æ®ï¼šblogIdã€minTimeï¼ˆæ—¶é—´æˆ³ï¼‰ã€offset List&lt;Long&gt; ids = new ArrayList&lt;&gt;(typedTuples.size()); long minTime = 0; // 2 int os = 1; // 2 for (ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples) { // 5 4 4 2 2 // 4.1.è·å–id ids.add(Long.valueOf(tuple.getValue())); // 4.2.è·å–åˆ†æ•°(æ—¶é—´æˆ³ï¼‰ long time = tuple.getScore().longValue(); if(time == minTime){ os++; }else{ minTime = time; os = 1; } } os = minTime == max ? os : os + offset; // 5.æ ¹æ®idæŸ¥è¯¢blog String idStr = StrUtil.join(&quot;,&quot;, ids); List&lt;Blog&gt; blogs = query().in(&quot;id&quot;, ids).last(&quot;ORDER BY FIELD(id,&quot; + idStr + &quot;)&quot;).list(); for (Blog blog : blogs) { // 5.1.æŸ¥è¯¢blogæœ‰å…³çš„ç”¨æˆ· queryBlogUser(blog); // 5.2.æŸ¥è¯¢blogæ˜¯å¦è¢«ç‚¹èµ isBlogLiked(blog); } // 6.å°è£…å¹¶è¿”å› ScrollResult r = new ScrollResult(); r.setList(blogs); r.setOffset(os); r.setMinTime(minTime); return Result.ok(r); } ä¹ã€é™„è¿‘å•†æˆ·GEOä»‹ç»GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„å‘½ä»¤æœ‰ï¼š GEOADDï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰ GEODISTï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å› GEOHASHï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å› GEOPOSï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡ GEORADIUSï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.ä»¥åå·²åºŸå¼ƒ GEOSEARCHï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½ GEOSEARCHSTOREï¼šä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚ 6.2.æ–°åŠŸèƒ½ ä¸šåŠ¡ä»‹ç»å•†æˆ·æ•°æ®è¡¨è¯·æ±‚ä¿¡æ¯ä¿å­˜åœ¨Redisä¸­çš„æ•°æ®æ ¼å¼GEOåº•å±‚æ˜¯Zsetæ•°æ®ç»“æ„ï¼Œå…¶ä¸­ä¼šæŠŠmemberä½œä¸ºvalueï¼ŒæŠŠç»çº¬åº¦è®¡ç®—å‡ºä¸€ä¸ªå€¼ä½œä¸ºscoreå­˜å…¥åˆ°Redisçš„GEOä¸­ç”±äºåœ¨é¦–é¡µä¸­ï¼Œæˆ‘ä»¬ä¼šç‚¹è¿›å»ä¸€ä¸ªå…·ä½“ç±»å‹ï¼Œåœ¨è¿™ä¸ªå…·ä½“ç±»å‹ä¸­æŸ¥çœ‹è·ç¦»ç”±å°åˆ°å¤§æ’åºçš„å•†é“ºä¿¡æ¯ã€‚ä¸ºäº†æŒ‰ç…§typeæ¥å¯¹æ•°æ®è¿›è¡Œç­›é€‰ï¼Œå› æ­¤ä½¿ç”¨ç±»å‹ä½œä¸ºkeyï¼Œå•†æˆ·idä½œä¸ºmemberï¼Œå¾€GEOä¸­å­˜å…¥ä¿¡æ¯ã€‚ä¹‹ååœ¨è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œå°±ç›´æ¥è·å–æŸä¸€ä¸ªç±»å‹å¯¹åº”çš„GEOæ•°æ®å³å¯ã€‚å°†å•†é“ºä¿¡æ¯é¢„çƒ­åˆ°Redisä¸­ @Test void loadShopData() { // 1.æŸ¥è¯¢åº—é“ºä¿¡æ¯ List&lt;Shop&gt; list = shopService.list(); // 2.æŠŠåº—é“ºåˆ†ç»„ï¼ŒæŒ‰ç…§typeIdåˆ†ç»„ï¼ŒtypeIdä¸€è‡´çš„æ”¾åˆ°ä¸€ä¸ªé›†åˆ Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId)); // 3.åˆ†æ‰¹å®Œæˆå†™å…¥Redis for (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) { // 3.1.è·å–ç±»å‹id Long typeId = entry.getKey(); String key = SHOP_GEO_KEY + typeId; // 3.2.è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ List&lt;Shop&gt; value = entry.getValue(); List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = new ArrayList&lt;&gt;(value.size()); // 3.3.å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member for (Shop shop : value) { // stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString()); locations.add(new RedisGeoCommands.GeoLocation&lt;&gt;( shop.getId().toString(), new Point(shop.getX(), shop.getY()) )); } stringRedisTemplate.opsForGeo().add(key, locations); } } @GetMapping(&quot;/of/type&quot;) public Result queryShopByType( @RequestParam(&quot;typeId&quot;) Integer typeId, @RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;) Integer current, @RequestParam(value = &quot;x&quot;, required = false) Double x, @RequestParam(value = &quot;y&quot;, required = false) Double y ) { return shopService.queryShopByType(typeId, current, x, y); } @Override public Result queryShopByType(Integer typeId, Integer current, Double x, Double y) { // 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢ if (x == null || y == null) { // ä¸éœ€è¦åæ ‡æŸ¥è¯¢ï¼ŒæŒ‰æ•°æ®åº“æŸ¥è¯¢ Page&lt;Shop&gt; page = query() .eq(&quot;type_id&quot;, typeId) .page(new Page&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE)); // è¿”å›æ•°æ® return Result.ok(page.getRecords()); } // 2.è®¡ç®—åˆ†é¡µå‚æ•° int from = (current - 1) * SystemConstants.DEFAULT_PAGE_SIZE; int end = current * SystemConstants.DEFAULT_PAGE_SIZE; // 3.æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µã€‚ç»“æœï¼šshopIdã€distance String key = SHOP_GEO_KEY + typeId; GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo() // GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE .search( key, GeoReference.fromCoordinate(x, y), new Distance(5000), RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end) ); // 4.è§£æå‡ºid if (results == null) { return Result.ok(Collections.emptyList()); } List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent(); if (list.size() &lt;= from) { // æ²¡æœ‰ä¸‹ä¸€é¡µäº†ï¼Œç»“æŸ return Result.ok(Collections.emptyList()); } // 4.1.æˆªå– from ~ endçš„éƒ¨åˆ† List&lt;Long&gt; ids = new ArrayList&lt;&gt;(list.size()); Map&lt;String, Distance&gt; distanceMap = new HashMap&lt;&gt;(list.size()); list.stream().skip(from).forEach(result -&gt; { // 4.2.è·å–åº—é“ºid String shopIdStr = result.getContent().getName(); ids.add(Long.valueOf(shopIdStr)); // 4.3.è·å–è·ç¦» Distance distance = result.getDistance(); distanceMap.put(shopIdStr, distance); }); // 5.æ ¹æ®idæŸ¥è¯¢Shop String idStr = StrUtil.join(&quot;,&quot;, ids); List&lt;Shop&gt; shops = query().in(&quot;id&quot;, ids).last(&quot;ORDER BY FIELD(id,&quot; + idStr + &quot;)&quot;).list(); for (Shop shop : shops) { shop.setDistance(distanceMap.get(shop.getId().toString()).getValue()); } // 6.è¿”å› return Result.ok(shops); }","categories":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/categories/é¡¹ç›®/"}],"tags":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/tags/é¡¹ç›®/"}],"keywords":[{"name":"é¡¹ç›®","slug":"é¡¹ç›®","permalink":"https://xingxin-99.github.io/categories/é¡¹ç›®/"}]},{"title":"Java","slug":"Java","date":"2023-06-24T14:06:19.000Z","updated":"2023-08-25T07:19:09.402Z","comments":true,"path":"2023/06/24/Java/","link":"","permalink":"https://xingxin-99.github.io/2023/06/24/Java/","excerpt":"","text":"Java","categories":[{"name":"Java","slug":"Java","permalink":"https://xingxin-99.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://xingxin-99.github.io/tags/Java/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://xingxin-99.github.io/categories/Java/"}]},{"title":"Mybatis","slug":"Mybatis","date":"2023-05-25T08:18:45.000Z","updated":"2023-08-26T10:54:11.949Z","comments":true,"path":"2023/05/25/Mybatis/","link":"","permalink":"https://xingxin-99.github.io/2023/05/25/Mybatis/","excerpt":"","text":"ä¸€ã€Mybatisæ¦‚è¿° äºŒã€Mybatiså…¥é—¨ç¨‹åºmavenä¸­ä¸ºä»€ä¹ˆæ”¾åœ¨resourceç›®å½•ä¸‹çš„èµ„æºï¼Œç­‰äºæ”¾åœ¨ç±»çš„æ ¹è·¯å¾„ä¸‹åœ¨ Maven é¡¹ç›®ä¸­ï¼Œsrc/main/resources ç›®å½•ä¸‹çš„èµ„æºæ–‡ä»¶ä¼šè¢«æ‰“åŒ…è¿›ç”Ÿæˆçš„ Jar æˆ– War åŒ…ä¸­ï¼Œå¹¶æ”¾åœ¨ç±»è·¯å¾„çš„æ ¹ç›®å½•ä¸‹ã€‚è¿™æ˜¯å› ä¸º Maven åœ¨æ„å»ºé¡¹ç›®æ—¶ä¼šæŠŠ src/main/resources ç›®å½•ä½œä¸ºç±»è·¯å¾„çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥æ‰€æœ‰æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½ä¼šè¢«æ‰“åŒ…è¿›å»ã€‚åœ¨ Java é¡¹ç›®ä¸­ï¼Œç±»è·¯å¾„æŒ‡çš„æ˜¯ JVM ç”¨æ¥æœç´¢ç±»å’Œèµ„æºæ–‡ä»¶çš„è·¯å¾„ã€‚ç±»è·¯å¾„çš„æ ¹ç›®å½•æ˜¯æŒ‡èƒ½å¤Ÿç›´æ¥è¢« JVM æœç´¢åˆ°çš„ç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½å¯ä»¥ç›´æ¥ç”¨ ClassLoader åŠ è½½ã€‚åœ¨ Maven é¡¹ç›®ä¸­ï¼Œsrc/main/resources ç›®å½•ä¸­çš„æ–‡ä»¶å°±æ˜¯æ”¾åœ¨è¿™ä¸ªæ ¹ç›®å½•ä¸‹çš„ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æŠŠæŸä¸ªèµ„æºæ–‡ä»¶æ”¾åœ¨ src/main/resources ç›®å½•ä¸‹ï¼Œå®ƒå°±ç›¸å½“äºæ”¾åœ¨äº†ç±»è·¯å¾„çš„æ ¹ç›®å½•ä¸‹ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ ClassLoader åŠ è½½ï¼Œæ— éœ€æŒ‡å®šè·¯å¾„ã€‚è¿™ä¹Ÿæ˜¯ Maven ä¸­æ¨èçš„ä¸€ç§èµ„æºæ–‡ä»¶çš„ç»„ç»‡æ–¹å¼ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­è®¿é—®å’Œä½¿ç”¨è¿™äº›æ–‡ä»¶ã€‚ public class mybatisTest { public static void main(String[] args) { SqlSession sqlSession=null; try { SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder(); InputStream is = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;); SqlSessionFactory sqlSessionFactory = sqlSessionFactoryBuilder.build(is); sqlSession =sqlSessionFactory.openSession(); int count = sqlSession.insert(&quot;car_insert&quot;); System.out.println(count); sqlSession.commit(); } catch (IOException e) { if(sqlSession!=null){ sqlSession.rollback(); } throw new RuntimeException(e); }finally { if(sqlSession!=null){ sqlSession.close(); } } } } Junitä»‹ç» public class MathService{ public int sum(int a, int b){ return a+b; } } public class MathServiceTest{ MathService mathService = new MathService(); @Test public void Testsum(){ int actual = mathService.sum(1,2); int expected = 3; Assert.assertEquals(expected,actual); } } æ—¥å¿—æ¡†æ¶ &lt;settings&gt; &lt;setting name=&quot;logImpl&quot; value=&quot;STDOUT_LOGGING&quot; /&gt; &lt;/settings&gt; Mybatiså·¥å…·ç±» public class mybatisUtil { private mybatisUtil(){ } private static SqlSessionFactory sqlSessionFactory; static { try { SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder(); sqlSessionFactory = sqlSessionFactoryBuilder.build(Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;)); } catch (IOException e) { throw new RuntimeException(e); } } public static SqlSession openSession(){ return sqlSessionFactory.openSession(); } } ä¸‰ã€ä½¿ç”¨Mybatiså®ŒæˆCRUD &lt;mapper namespace=&quot;com.star.mybatis&quot;&gt; &lt;insert id=&quot;car_insert&quot;&gt; insert into t_car(id,car_num,brand,guide_price,produce_time,car_type) values (null,#{carNum},#{brand},#{guidePrice},#{produceTime},#{carType}) &lt;/insert&gt; &lt;delete id=&quot;car_delete&quot;&gt; delete from t_car where id=#{i} &lt;/delete&gt; &lt;select id=&quot;car_select&quot; resultType=&quot;com.star.mybatis.introduction.pojo.Car&quot;&gt; select * from t_car where id=#{id} &lt;/select&gt; &lt;select id=&quot;car_selectall&quot; resultType=&quot;com.star.mybatis.introduction.pojo.Car&quot;&gt; select * from t_car &lt;/select&gt; &lt;/mapper&gt; public class mybatisTest { @Test public void deletetest(){ SqlSession sqlSession = mybatisUtil.openSession(); int count = sqlSession.delete(&quot;car_delete&quot;,6); System.out.println(count); sqlSession.commit(); sqlSession.close(); } @Test public void testInsert(){ Car car = new Car(null,&quot;001&quot;,&quot;é•¿å®‰&quot;,325.00,&quot;2023-04-03&quot;,&quot;ç‡ƒæ²¹&quot;); SqlSession sqlSession = mybatisUtil.openSession(); int count = sqlSession.insert(&quot;car_insert&quot;,car); System.out.println(count); sqlSession.commit(); sqlSession.close(); } @Test public void testSelect(){ SqlSession sqlSession = mybatisUtil.openSession(); Car car = sqlSession.selectOne(&quot;car_select&quot;,8); System.out.println(car); } @Test public void testSelectAll(){ SqlSession sqlSession = mybatisUtil.openSession(); List&lt;Car&gt; cars = sqlSession.selectList(&quot;car_selectall&quot;); cars.forEach(car -&gt; System.out.println(car)); } } å››ã€Mybatisæ ¸å¿ƒé…ç½®æ–‡ä»¶è¯¦è§£ äº”ã€åœ¨WEBä¸­åº”ç”¨Mybatisæ–¹æ³•ä½œç”¨åŸŸæ–¹æ³•ä½œç”¨åŸŸæ˜¯æŒ‡å˜é‡ã€å¸¸é‡å’Œå¯¹è±¡åœ¨æ–¹æ³•ä¸­çš„å¯è§æ€§å’Œç”Ÿå‘½å‘¨æœŸã€‚åœ¨æ–¹æ³•å†…éƒ¨å£°æ˜çš„å˜é‡å’Œå¸¸é‡åªåœ¨æ–¹æ³•å†…éƒ¨å¯è§ï¼Œå½“æ–¹æ³•æ‰§è¡Œç»“æŸæ—¶ï¼Œå®ƒä»¬ä¹Ÿéšä¹‹æ¶ˆå¤±ã€‚å¯¹è±¡çš„ä½œç”¨åŸŸå¯ä»¥è¶…å‡ºæ–¹æ³•ï¼Œä¾‹å¦‚ä¸€ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨æ–¹æ³•å¤–éƒ¨ä¹Ÿå¯ä»¥è¢«ä½¿ç”¨ï¼Œç›´åˆ°å®ƒè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚æ–¹æ³•ä½œç”¨åŸŸçš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯ï¼Œæ–¹æ³•å†…éƒ¨çš„å˜é‡åæˆ–å‚æ•°åå¯ä»¥ä¸ç±»çš„æˆå‘˜å˜é‡åæˆ–å‚æ•°åç›¸åŒï¼Œä½†æ˜¯æ–¹æ³•å†…éƒ¨çš„å˜é‡æˆ–å‚æ•°ä¼šè¦†ç›–ç±»çš„æˆå‘˜å˜é‡æˆ–å‚æ•°ï¼Œç›´åˆ°æ–¹æ³•æ‰§è¡Œç»“æŸã€‚åº”ç”¨ä½œç”¨åŸŸåº”ç”¨ä½œç”¨åŸŸæ˜¯æŒ‡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸç›¸åŒï¼Œå³åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œåœ¨åº”ç”¨ç¨‹åºå…³é—­æ—¶é”€æ¯ã€‚åœ¨Springæ¡†æ¶ä¸­ï¼Œåº”ç”¨ä½œç”¨åŸŸçš„å¯¹è±¡é€šå¸¸ä½¿ç”¨å•ä¾‹æ¨¡å¼åˆ›å»ºã€‚åœ¨åº”ç”¨ä½œç”¨åŸŸä¸‹åˆ›å»ºçš„å¯¹è±¡å¯ä»¥åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å…±äº«ï¼Œå› æ­¤åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨åŒä¸€ä¸ªå¯¹è±¡å¯ä»¥æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œåœ¨Webåº”ç”¨ç¨‹åºä¸­ï¼Œå¯ä»¥åœ¨åº”ç”¨ä½œç”¨åŸŸä¸‹åˆ›å»ºä¸€ä¸ªå…±äº«çš„æ•°æ®æºå¯¹è±¡ï¼Œä»¥ä¾¿å¤šä¸ªçº¿ç¨‹å…±äº«è¿™ä¸ªå¯¹è±¡ï¼Œé¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯æ•°æ®æºå¯¹è±¡çš„å¼€é”€ã€‚è¯·æ±‚ä½œç”¨åŸŸè¯·æ±‚ä½œç”¨åŸŸæ˜¯æŒ‡åœ¨ä¸€æ¬¡ HTTP è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ä¸­æ‰€åˆ›å»ºçš„å¯¹è±¡çš„ä½œç”¨åŸŸã€‚å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»è¯·æ±‚çš„å¼€å§‹åˆ°å“åº”çš„ç»“æŸã€‚åœ¨ä¸€ä¸ª HTTP è¯·æ±‚ä¸­ï¼Œé€šè¿‡ HttpServletRequest å¯¹è±¡å¯ä»¥è·å–è¯·æ±‚ä½œç”¨åŸŸï¼Œå¯ä»¥å°†å¯¹è±¡å­˜æ”¾åœ¨è¯·æ±‚ä½œç”¨åŸŸä¸­ï¼Œç„¶ååœ¨æ•´ä¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­å…±äº«è¿™äº›å¯¹è±¡ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¯·æ±‚ä½œç”¨åŸŸå¯ä»¥ç”¨äºåœ¨ä¸åŒçš„é¡µé¢ä¹‹é—´ä¼ é€’æ•°æ®ã€‚ä¸ºä»€ä¹ˆSqlSessionFactoryçš„ä½œç”¨åŸŸä¸ºåº”ç”¨ä½œç”¨åŸŸMyBatisä¸­çš„SqlSessionFactoryæ˜¯ä¸€ä¸ªé‡é‡çº§çš„å¯¹è±¡ï¼Œä¸»è¦è´Ÿè´£åˆ›å»ºå’Œç®¡ç†SqlSessionï¼Œå…¶åˆ›å»ºè¿‡ç¨‹åŒ…å«äº†åŠ è½½é…ç½®æ–‡ä»¶ã€è§£ææ˜ å°„æ–‡ä»¶ã€åˆ›å»ºæ•°æ®åº“è¿æ¥ç­‰æ“ä½œï¼Œå› æ­¤åœ¨åˆ›å»ºSqlSessionFactoryå¯¹è±¡æ—¶ä¼šè€—è´¹è¾ƒå¤šçš„èµ„æºå’Œæ—¶é—´ã€‚è€Œä¸”ï¼Œä¸€ä¸ªSqlSessionFactoryå¯¹è±¡ä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦åˆ›å»ºä¸€æ¬¡ï¼Œå¹¶åœ¨åº”ç”¨ç”Ÿå‘½å‘¨æœŸå†…æŒç»­ä½¿ç”¨ï¼Œå› æ­¤å°†å…¶ä½œç”¨åŸŸè®¾ç½®ä¸ºåº”ç”¨ä½œç”¨åŸŸæ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚å¦‚æœå°†SqlSessionFactoryçš„ä½œç”¨åŸŸè®¾ç½®ä¸ºæ–¹æ³•æˆ–è¯·æ±‚ä½œç”¨åŸŸï¼Œé‚£ä¹ˆæ¯æ¬¡æ‰§è¡Œæ“ä½œéƒ½éœ€è¦é‡æ–°åˆ›å»ºå’Œé”€æ¯SqlSessionFactoryå¯¹è±¡ï¼Œä¼šå¯¼è‡´ä¸å¿…è¦çš„èµ„æºæµªè´¹å’Œæ€§èƒ½ä¸‹é™ã€‚è€Œå°†å…¶ä½œç”¨åŸŸè®¾ç½®ä¸ºä¼šè¯ä½œç”¨åŸŸä¹Ÿä¸å¤ªåˆé€‚ï¼Œå› ä¸ºSqlSessionFactoryæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ªSqlSessionFactoryå¯¹è±¡ï¼Œå› æ­¤åœ¨ä¼šè¯ä½œç”¨åŸŸä¸­å¯èƒ½ä¼šé€ æˆä¸å¿…è¦çš„èµ„æºæµªè´¹å’Œçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä¸ºä»€ä¹ˆSqlSessionçš„ä½œç”¨åŸŸä¸ºè¯·æ±‚ä½œç”¨åŸŸåœ¨ä½¿ç”¨ MyBatis è¿›è¡Œæ•°æ®åº“æ“ä½œæ—¶ï¼Œæ¯ä¸ª SqlSession éƒ½ä»£è¡¨äº†ä¸€æ¬¡å¯¹æ•°æ®åº“çš„æ“ä½œä¼šè¯ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚éœ€è¦æ“ä½œæ•°æ®åº“å¤šæ¬¡ï¼Œå› æ­¤éœ€è¦å¤šæ¬¡åˆ›å»º SqlSession å¯¹è±¡ã€‚ç”±äº SqlSession æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ª SqlSession å¯¹è±¡å®ä¾‹æ—¢éœ€è¦æ—¶é—´åˆå ç”¨å†…å­˜ï¼Œæ‰€ä»¥ä¸ºäº†æ›´å¥½åœ°æ§åˆ¶èµ„æºçš„å¼€é”€ï¼Œå°† SqlSession çš„ä½œç”¨åŸŸè®¾ç½®ä¸ºè¯·æ±‚ä½œç”¨åŸŸæ˜¯æ¯”è¾ƒåˆé€‚çš„é€‰æ‹©ã€‚å°† SqlSession çš„ä½œç”¨åŸŸè®¾ç½®ä¸ºè¯·æ±‚ä½œç”¨åŸŸå¯ä»¥ä¿è¯æ¯ä¸ªè¯·æ±‚éƒ½èƒ½è·å–åˆ°ä¸€ä¸ªç‹¬ç«‹çš„ SqlSession å®ä¾‹ï¼Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜å’Œå¹¶å‘è®¿é—®çš„å†²çªã€‚åŒæ—¶ï¼Œç”±äºæ¯ä¸ª SqlSession å¯¹è±¡å®ä¾‹åªå­˜åœ¨äºè¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šé•¿æ—¶é—´å ç”¨å†…å­˜ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°é¿å…å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼Œæå‡äº†åº”ç”¨ç¨‹åºçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚ å…­ã€ä½¿ç”¨javassistç”Ÿæˆç±»ä¸ƒã€MyBatisä¸­æ¥å£ä»£ç†æœºåˆ¶åŠä½¿ç”¨ å…«ã€Mybatisçš„å°æŠ€å·§ ä¹ã€Mybatiså‚æ•°å¤„ç†åã€MybatisæŸ¥è¯¢è¯­å¥ä¸“é¢˜ åä¸€ã€åŠ¨æ€SQL åä¸€ã€Mybatisé«˜çº§æ˜ å°„åŠå»¶è¿ŸåŠ è½½ åäºŒã€Mybatisç¼“å­˜ åä¸‰ã€Mybatisé€†å‘å·¥ç¨‹ åå››ã€Mybatisåˆ†é¡µæ’ä»¶ åäº”ã€Mybatisæ³¨è§£å¼å¼€å‘ åå…­ã€Mybatisé¢è¯•é—®é¢˜Mybatisä¸­çš„åŠ¨æ€SQLMybatisä¸­çš„åŠ¨æ€SQLæ˜¯æŒ‡å¯ä»¥æ ¹æ®å®é™…æƒ…å†µç”Ÿæˆä¸åŒSQLè¯­å¥çš„ä¸€ç§ç‰¹æ®Šè¯­æ³•ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒåŠ¨æ€SQLæ˜¯ç”¨æ¥æ„å»ºå¤æ‚çš„SQLè¯­å¥çš„ï¼Œä¾‹å¦‚æ ¹æ®ä¸åŒæ¡ä»¶æ‹¼æ¥whereè¯­å¥ã€æ ¹æ®ä¼ å…¥çš„å‚æ•°æ„å»ºä¸åŒçš„æŸ¥è¯¢æ¡ä»¶ç­‰ã€‚Mybatisä¸­æä¾›äº†ä¸€äº›å†…ç½®çš„åŠ¨æ€SQLè¯­å¥ï¼Œä¾‹å¦‚ifã€chooseã€whenã€otherwiseç­‰ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è‡ªç”±ç»„åˆä½¿ç”¨ï¼Œä»è€Œæ„å»ºå‡ºçµæ´»å¤šå˜çš„SQLè¯­å¥ã€‚åŒæ—¶ï¼ŒMybatisä¹Ÿæ”¯æŒä½¿ç”¨OGNLè¡¨è¾¾å¼æ¥å¤„ç†åŠ¨æ€SQLï¼Œå¯ä»¥å®ç°æ›´åŠ çµæ´»çš„æ¡ä»¶ç»„åˆã€‚æŒæ¡åŠ¨æ€SQLçš„ä½¿ç”¨ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…æ›´åŠ æ–¹ä¾¿åœ°æ„å»ºå‡ºçµæ´»ã€é«˜æ•ˆçš„æ•°æ®è®¿é—®é€»è¾‘ï¼Œæå‡åº”ç”¨çš„æ€§èƒ½å’Œæ‰©å±•æ€§ã€‚Mybatisä¸­çš„ä¸€å¯¹å¤šæ˜ å°„åœ¨ Mybatis ä¸­ï¼Œä¸€å¯¹å¤šæ˜ å°„æ˜¯æŒ‡ä¸€ä¸ªå®ä½“ç±»ä¸­åŒ…å«ä¸€ä¸ªé›†åˆå±æ€§ï¼Œè¯¥é›†åˆå±æ€§ä¸­åŒ…å«å¤šä¸ªä¸å¦ä¸€ä¸ªå®ä½“ç±»çš„å¯¹åº”å…³ç³»ï¼Œå³ä¸€ä¸ªå®ä½“ç±»ä¸å¦ä¸€ä¸ªå®ä½“ç±»æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç­çº§å®ä½“ç±»åŒ…å«å¤šä¸ªå­¦ç”Ÿå®ä½“ç±»ï¼Œé‚£ä¹ˆç­çº§å®ä½“ç±»å°±æ˜¯ä¸€çš„ä¸€æ–¹ï¼Œå­¦ç”Ÿå®ä½“ç±»å°±æ˜¯å¤šçš„ä¸€æ–¹ã€‚åœ¨ Mybatis ä¸­å®ç°ä¸€å¯¹å¤šæ˜ å°„ï¼Œéœ€è¦ä½¿ç”¨ Mybatis æä¾›çš„ association å’Œ collection æ ‡ç­¾ã€‚association æ ‡ç­¾ç”¨äºå®šä¹‰å•ä¸ªå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œè€Œ collection æ ‡ç­¾åˆ™ç”¨äºå®šä¹‰é›†åˆå¯¹è±¡ä¹‹é—´çš„å…³ç³»ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨æ˜ å°„æ–‡ä»¶ä¸­ï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€çš„ä¸€æ–¹çš„æŸ¥è¯¢è¯­å¥ï¼Œå¹¶ä½¿ç”¨ association æ ‡ç­¾å°†å¤šçš„ä¸€æ–¹çš„æŸ¥è¯¢ç»“æœæ˜ å°„åˆ°ä¸€çš„ä¸€æ–¹ä¸­ã€‚ç„¶åï¼Œå†å®šä¹‰å¤šçš„ä¸€æ–¹çš„æŸ¥è¯¢è¯­å¥ï¼Œå¹¶ä½¿ç”¨ collection æ ‡ç­¾å°†å¤šçš„ä¸€æ–¹çš„æŸ¥è¯¢ç»“æœæ˜ å°„åˆ°ä¸€çš„ä¸€æ–¹çš„é›†åˆå±æ€§ä¸­ã€‚Mybatisä¸­#{}å’Œ${}çš„åŒºåˆ«åœ¨Mybatisä¸­ï¼Œ#{}å’Œ${}éƒ½æ˜¯ç”¨æ¥è¡¨ç¤ºå‚æ•°å ä½ç¬¦çš„ï¼Œä½†æ˜¯å®ƒä»¬çš„ä½œç”¨æ˜¯ä¸åŒçš„ã€‚ #{}ç”¨äºè¡¨ç¤ºä¸€ä¸ªå ä½ç¬¦ï¼ŒMybatisä¼šå°†ä¼ å…¥çš„å‚æ•°è‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼Œç„¶åå°†è½¬æ¢åçš„å€¼å®‰å…¨åœ°æ’å…¥åˆ°SQLè¯­å¥ä¸­ã€‚è¿™ç§æ–¹å¼å¯ä»¥æœ‰æ•ˆåœ°é˜²æ­¢SQLæ³¨å…¥çš„é£é™©ã€‚${}ä¹Ÿç”¨äºè¡¨ç¤ºä¸€ä¸ªå ä½ç¬¦ï¼Œä½†æ˜¯å®ƒä¸ä¼šå¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œå¤„ç†ï¼Œç›´æ¥å°†ä¼ å…¥çš„å­—ç¬¦ä¸²åµŒå…¥åˆ°SQLè¯­å¥ä¸­ã€‚è¿™ç§æ–¹å¼å­˜åœ¨SQLæ³¨å…¥çš„é£é™©ï¼Œåº”è¯¥å°½é‡é¿å…ä½¿ç”¨ã€‚å› æ­¤ï¼Œå»ºè®®åœ¨Mybatisä¸­ä½¿ç”¨#{}ä½œä¸ºå‚æ•°å ä½ç¬¦ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚ä½¿ç”¨ #{} æ—¶ï¼ŒMybatis ä¼šå°† SQL è¯­å¥ä¸­çš„ #{} æ›¿æ¢æˆä¸€ä¸ª ? å ä½ç¬¦ï¼Œå¹¶ä½¿ç”¨ PreparedStatement æ¥æ‰§è¡Œ SQL è¯­å¥ï¼Œè¿™æ ·å°±å¯ä»¥é¿å… SQL æ³¨å…¥ç­‰å®‰å…¨é—®é¢˜ã€‚åŒæ—¶ï¼Œä½¿ç”¨ #{} è¿˜å¯ä»¥è‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://xingxin-99.github.io/categories/Spring/"}],"tags":[{"name":"Mybatis","slug":"Mybatis","permalink":"https://xingxin-99.github.io/tags/Mybatis/"}],"keywords":[{"name":"Spring","slug":"Spring","permalink":"https://xingxin-99.github.io/categories/Spring/"}]},{"title":"RedisåŒå†™ä¸€è‡´æ€§","slug":"RedisåŒå†™ä¸€è‡´æ€§","date":"2023-05-24T12:24:16.000Z","updated":"2023-08-25T07:15:20.198Z","comments":true,"path":"2023/05/24/RedisåŒå†™ä¸€è‡´æ€§/","link":"","permalink":"https://xingxin-99.github.io/2023/05/24/RedisåŒå†™ä¸€è‡´æ€§/","excerpt":"","text":"åŒå†™ä¸€è‡´æ€§æ˜¯ä¸ºäº†ä¿è¯æ•°æ®åº“å’Œç¼“å­˜ä¸­çš„æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚ åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ å†™å¤šè¯»å°‘åœºæ™¯ä¸‹æµªè´¹æ€§èƒ½å¦‚æœé‡‡ç”¨æ›´æ–°ç¼“å­˜æ–¹å¼çš„è¯ï¼Œé‚£ä¹ˆæ¯å¯¹æ•°æ®åº“æ›´æ–°ä¸€æ¬¡ï¼Œå°±ä¼šæ›´æ–°ä¸€æ¬¡ç¼“å­˜ã€‚åœ¨å†™å¤šè¯»å°‘çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœè¿›è¡Œäº†å¤šæ¬¡æ›´æ–°ï¼Œä½†æ²¡æœ‰ä¸€æ¬¡è¯»å–ï¼Œé‚£ä¸­é—´æ›´æ–°å¤šæ¬¡ç¼“å­˜çš„è¿™ä¸ªè¿‡ç¨‹æ˜¯æ²¡å¿…è¦çš„ä¸”æµªè´¹æ€§èƒ½çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›è¯»ç¼“å­˜æ—¶è¯»çš„æ˜¯ç›¸å¯¹æœ€æ–°çš„æ•°æ®ã€‚å› æ­¤ç›®å‰å¤§å¤šé‡‡ç”¨ç±»ä¼¼äºæ‡’åŠ è½½çš„è¿™ç§æ¨¡å¼ï¼Œåˆ é™¤ç¼“å­˜åï¼Œä¸ä½¿ç”¨æ—¶ä¸è¯»ç¼“å­˜ï¼Œåªæœ‰ä½¿ç”¨æ—¶å†å»æ•°æ®åº“ä¸­è¯»å–æœ€æ–°çš„æ•°æ®ã€‚ è„æ•°æ®é—®é¢˜çº¿ç¨‹1å’Œçº¿ç¨‹2éƒ½è¦å¯¹æ•°æ®åº“ä¸­çš„Aæ•°æ®è¿›è¡Œå†™æ“ä½œã€‚çº¿ç¨‹1å…ˆæ‰§è¡Œï¼Œåœ¨å†™å…¥æ•°æ®åº“è¦æ›´æ–°ç¼“å­˜ä¹‹å‰ï¼Œçº¿ç¨‹2æ¥å¯¹Aè¿›è¡Œæ›´æ–°å¹¶å†™å…¥ç¼“å­˜ï¼Œç„¶åçº¿ç¨‹1å†å†™å…¥ç¼“å­˜ã€‚è¿™å¯¼è‡´ç¼“å­˜ä¸­æ˜¯Aæ›´æ–°åçš„æ•°æ®è€Œä¸æ˜¯æœŸæœ›çš„Bæ›´æ–°åçš„æ•°æ®ï¼Œå¯¼è‡´æœ€åç¼“å­˜ä¸­å‡ºç°äº†è„æ•°æ®ã€‚ å…ˆæ›´æ–°æ•°æ®åº“è¿˜æ˜¯å…ˆåˆ é™¤ç¼“å­˜ï¼Ÿ ä½¿ç”¨å»¶æ—¶åŒåˆ ï¼Œä¸ºä»€ä¹ˆè¦åˆ é™¤ä¸¤æ¬¡ï¼Ÿä¸ºä»€ä¹ˆç¬¬ä¸€æ¬¡è¦åˆ é™¤ï¼Ÿä¸ºä»€ä¹ˆè¦è¿›è¡Œå»¶æ—¶ï¼Ÿ å»¶æ—¶çš„ç›®çš„ï¼š çº¿ç¨‹Bè¯»å–æ•°æ®åº“ï¼Œåœ¨è¿˜æœªæ›´æ–°ç¼“å­˜æ—¶ï¼Œçº¿ç¨‹Aæ›´æ–°æ•°æ®åº“ï¼Œåˆ é™¤ç¼“å­˜ã€‚çº¿ç¨‹BæŠŠè¯»åˆ°çš„æ•°æ®å†™å…¥åˆ°ç¼“å­˜ä¸­ï¼Œå†™å…¥çš„æ˜¯è„æ•°æ®ã€‚è¿›è¡Œå»¶æ—¶ï¼Œç­‰åˆ°çº¿ç¨‹Bå°†è„æ•°æ®å†™å…¥åˆ°ç¼“å­˜ååœ¨è¿›è¡Œåˆ é™¤ï¼Œé™ä½äº†å‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§çš„å¯èƒ½ã€‚ ä¸»ä»åŒæ­¥ï¼Œéœ€è¦ç­‰å¾…ä»åº“ç­‰å¾…æ•°æ®æ›´æ–°åå†åˆ é™¤ç¼“å­˜ï¼Œå¦åˆ™è¯»å–çš„è¿˜æ˜¯ä»åº“ä¸­æœªæ›´æ–°çš„æ•°æ®ã€‚ å¦‚ä½•åˆ¤æ–­Reidisä¸­çš„keyåˆ é™¤å¤±è´¥ï¼Ÿ Redisçš„DELå‘½ä»¤ç”¨äºåˆ é™¤å·²å­˜åœ¨çš„é”®ï¼Œè¿”å›å€¼æ˜¯åˆ é™¤é”®çš„æ•°é‡ redisTemplate.delete(key)ï¼Œå¦‚æœåˆ é™¤å¤±è´¥ï¼Œè¿”å›false å¦‚æœå»¶æ—¶åŒåˆ ï¼Œæœ€åçš„åˆ å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ å¤±è´¥é‡è¯•æœºåˆ¶ åŒæ­¥é‡è¯• å¼‚æ­¥é‡è¯• ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ— è®¢é˜…binlogæ—¥å¿— ä½¿ç”¨canalç»„ä»¶è®¢é˜…binlogæ—¥å¿—ï¼Œå½“å‘ç°binlogä¸­æœ‰æ›´æ–°æ•°æ®çš„æ—¥å¿—æ—¶ï¼Œåˆ é™¤ç›¸åº”çš„ç¼“å­˜ã€‚ å®šæ—¶ä»»åŠ¡å°†éœ€è¦é‡è¯•çš„æ•°æ®å†™å…¥åˆ°é‡è¯•è¡¨ä¸­ï¼Œé‡è¯•è¡¨ä¸­æœ‰é‡è¯•æ¬¡æ•°åŠæ•°æ®çŠ¶æ€ï¼Œå®šæ—¶ä»»åŠ¡æ¯éš”ä¸€å®šæ—¶é—´è¯»å–é‡è¯•è¡¨ä¸­çš„æ•°æ®è¿›è¡Œé‡è¯•ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™å°†è¯¥æ•°æ®åˆ é™¤ï¼Œå¦‚æœä¸æˆåŠŸåˆ™é‡è¯•æ¬¡æ•°+1ï¼Œå¦‚æœé‡è¯•æ¬¡æ•°è¾¾åˆ°æŒ‡å®šå€¼è¿˜æœªæ›´æ–°æˆåŠŸï¼Œåˆ™é‡è¯•è¡¨ä¸­å°†è¯¥è®°å½•æ›´æ–°ä¸ºå¤±è´¥çŠ¶æ€ã€‚åŒæ—¶è€ƒè™‘æ˜¯ä¸æ˜¯ç”±äºRediså®•æœºè€Œå¯¼è‡´äº†æ›´æ–°ä¸€ç›´å¤±è´¥ï¼Œè€ƒè™‘ä½¿ç”¨Redisé›†ç¾¤æ¥æé«˜RedisæœåŠ¡çš„é«˜å¯ç”¨æ€§ã€‚ å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„å¼ºä¸€è‡´æ€§ï¼Ÿ å¦‚æœè¦ä¿è¯Redisä¸æ•°æ®åº“çš„å¼ºä¸€è‡´æ€§ï¼Œå¯ä»¥é è€ƒè™‘ä½¿ç”¨Redisçš„äº’æ–¥é”å®ç°ã€‚å½“è¦æ›´æ–°æ•°æ®æ—¶ï¼Œå¯¹è¦æ›´æ–°çš„keyåŠ ä¸Šäº’æ–¥é”ï¼ŒåŒæ—¶å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹å¯¹æ•°æ®åº“æ‰§è¡Œå†™æ“ä½œã€‚å½“å†™æ“ä½œæ‰§è¡Œå®Œæ¯•åé‡Šæ”¾é”ã€‚ å¦‚ä½•ä¸è¦æ±‚å¼ºä¸€è‡´æ€§ï¼Œå¯ä»¥æ€ä¹ˆåšï¼Ÿ å»¶æ—¶åŒåˆ  Canalç»„ä»¶","categories":[{"name":"Redis","slug":"Redis","permalink":"https://xingxin-99.github.io/categories/Redis/"}],"tags":[{"name":"Redis","slug":"Redis","permalink":"https://xingxin-99.github.io/tags/Redis/"}],"keywords":[{"name":"Redis","slug":"Redis","permalink":"https://xingxin-99.github.io/categories/Redis/"}]},{"title":"Typora+PicGo+é˜¿é‡Œäº‘OSSä¸Šä¼ å›¾ç‰‡","slug":"1","date":"2022-05-25T12:24:16.000Z","updated":"2023-08-25T07:19:07.822Z","comments":true,"path":"2022/05/25/1/","link":"","permalink":"https://xingxin-99.github.io/2022/05/25/1/","excerpt":"","text":"é˜¿é‡Œäº‘OSS ç™»é™†è¿›é˜¿é‡Œäº‘OSS åˆ›å»ºOSS Bucket è·å–AccessKey ä¿å­˜AccessKey IDä¸Secretï¼Œåé¢PicGoå›¾åºŠè®¾ç½®ä¼šä½¿ç”¨åˆ° PicGo ä¸‹è½½PicGoï¼šReleases Â· Molunerfinn/PicGo (github.com) é€‰æ‹©æ˜¾ç¤ºå›¾åºŠ å›¾åºŠè®¾ç½® éªŒè¯å›¾ç‰‡æ˜¯å¦èƒ½å¤Ÿä¸Šä¼ æˆåŠŸ TyporaTyporaä¸Šä¼ å›¾ç‰‡è®¾ç½®ï¼šæ–‡ä»¶-&gt;åå¥½è®¾ç½®-&gt;å›¾åƒ","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xingxin-99.github.io/categories/æŠ€æœ¯/"}],"tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xingxin-99.github.io/tags/æŠ€æœ¯/"}],"keywords":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xingxin-99.github.io/categories/æŠ€æœ¯/"}]},{"title":"ä¸»é¢˜é…ç½®","slug":"ä¸»é¢˜é…ç½®","date":"2022-04-25T02:37:16.000Z","updated":"2023-08-25T07:15:09.984Z","comments":true,"path":"2022/04/25/ä¸»é¢˜é…ç½®/","link":"","permalink":"https://xingxin-99.github.io/2022/04/25/ä¸»é¢˜é…ç½®/","excerpt":"","text":"ä¿®æ”¹å¯¹è¯","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xingxin-99.github.io/categories/æŠ€æœ¯/"}],"tags":[],"keywords":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xingxin-99.github.io/categories/æŠ€æœ¯/"}]},{"title":"æ­å»ºåšå®¢æ—¶é‡åˆ°çš„é—®é¢˜","slug":"æ­å»ºBlogæ—¶é‡åˆ°çš„é—®é¢˜","date":"2022-03-24T12:24:16.000Z","updated":"2023-08-25T07:15:14.986Z","comments":true,"path":"2022/03/24/æ­å»ºBlogæ—¶é‡åˆ°çš„é—®é¢˜/","link":"","permalink":"https://xingxin-99.github.io/2022/03/24/æ­å»ºBlogæ—¶é‡åˆ°çš„é—®é¢˜/","excerpt":"","text":"é—®é¢˜ï¼šæ‰§è¡Œhexo dåæŠ¥é”™ssh: connect to host github.com port 22: Connection refusedï¼Œæ–‡ä»¶ä¸èƒ½éƒ¨ç½²åˆ°Githubä¸­ è§£å†³ï¼šæ¢ä¸€ä¸ªç«¯å£å· è¿›å…¥.sshç›®å½•ï¼Œç¼–è¾‘é…ç½®æ–‡ä»¶config cd ~/.ssh vim config ç¼–è¾‘æ–‡ä»¶å†…å®¹ Host github.com User git Hostname ssh.github.com PreferredAuthentications publickey IdentityFile ~/.ssh/id_rsa Port 443 Host gitlab.com Hostname altssh.gitlab.com User git Port 443 PreferredAuthentications publickey IdentityFile ~/.ssh/id_rsa ä¿å­˜é€€å‡ºï¼Œæ£€æŸ¥æ˜¯å¦æˆåŠŸ ssh -T git@github.com éªŒè¯hexo dèƒ½å¦æˆåŠŸéƒ¨ç½²èµ„æºåˆ°Githubï¼Œç»“æœæˆåŠŸ å‚è€ƒï¼šGité—®é¢˜ åœ¨åˆ†ç±»ä¸‹æ·»åŠ æ ‡ç­¾ï¼Œæ²¡æœ‰æ˜¾ç¤ºåˆ›å»ºå‡ºåˆ†ç±»ä¸‹çš„é¡µé¢ è§£å†³ï¼š å…ˆç”Ÿæˆmdæ–‡ä»¶ï¼Œåœ¨mdé‡Œæ·»åŠ åˆ†ç±»ï¼Œå®ƒä¼šæ ¹æ®è¿™ä¸ªæ¥ç”Ÿæˆhtmlé¡µé¢ åˆ›å»ºæˆåŠŸåï¼Œå†æ·»åŠ è‡³é…ç½®æ–‡ä»¶ä¸­ hexo g ç”Ÿæˆé¡µé¢ä¼šå‘ç°é¡µé¢å·²ç»æˆåŠŸç”Ÿæˆ å¦‚ä½•ä¿®æ”¹æ–°çš„åˆ†ç±»ä¸‹çš„èƒŒæ™¯å›¾ç‰‡ï¼Ÿ","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xingxin-99.github.io/categories/æŠ€æœ¯/"}],"tags":[],"keywords":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xingxin-99.github.io/categories/æŠ€æœ¯/"}]}]}